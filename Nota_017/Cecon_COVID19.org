#+TITLE: Dados: O PIB da pandemia e cen√°rios para 2021
#+DATE: Janeiro de 2021
#+LATEX_CLASS: SelfArx
#+SETUPFILE: ../manuscript.setup
#+INCLUDE: Infos.org
#+PROPERTY: header-args python :results output drawer :eval never-export :session Cecon
#+PROPERTY: header-args R :results output drawer :eval never-export :session Cecon
#+LATEX:\flushbottom % Makes all text pages the same height
#+LATEX:\maketitle % Print the title and abstract box
#+LATEX:\thispagestyle{empty} % Removes page numbering from the first page
#+LATEX: \onecolumn
#+LATEX_HEADER: \usepackage{multirow, numprint}
bibliography:refs.bib

* Initial setup :noexport:ignore:
** Python
#+BEGIN_SRC python
import pandas as pd
import numpy as np
from datetime import datetime as dt
from datetime import timedelta

from tabulate import tabulate

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
from matplotlib.ticker import FuncFormatter

import seaborn as sns
import pandas_datareader.data as web
import requests
import json

import matplotlib.dates as mdates

import country_converter as coco

cc = coco.CountryConverter()

import matplotlib.image as image

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
corona_sp = "2020-03-24"
corona_sp_txt = "In√≠cio isolamento social em SP"

corona_60 = "2020-03-18"
corona_60_txt = "Mais de 60 casos de COVID-19"

start_year = "2018-01-01"
base = "2014-12-01"


def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == "Jan":
        month += f"\n{label.year}"
    return month


# ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))


def line_format_day(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    day = label.day
    string = f"{day}/{month}"
    return month


def interpolator(df):
    for col in df:
        df[col] = pd.to_numeric(df[col], errors="coerce")
        df = df.resample("D").interpolate(method="time")

    return df


def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == "Jan":
        month += f"\n{label.year}"
    return month


def rebase(df, base=base):
    for col in df:
        df[col] = df[col].apply(lambda x: (100 * x) / df[col][base])
    return df


def consulta_bc(codigo_bcb, nome=["Nome da s√©rie"]):
    url = "http://api.bcb.gov.br/dados/serie/bcdata.sgs.{}/dados?formato=json".format(
        codigo_bcb
    )
    df = pd.read_json(url)
    df["data"] = pd.to_datetime(df["data"], dayfirst=True)
    df.set_index("data", inplace=True)
    df.index.name = ""
    df.columns = nome
    return df


def autolabel(rects):
    """
    Attach a text label above each bar displaying its height
    """
    for rect in rects:
        height = rect.get_height()
        ax.text(
            rect.get_x() + rect.get_width() / 2.0,
            1.05 * height,
            "%d" % int(height),
            ha="center",
            va="bottom",
        )


def add_value_labels(ax, spacing=5):
    """Add labels to the end of each bar in a bar chart.

    Arguments:
        ax (matplotlib.axes.Axes): The matplotlib object containing the axes
            of the plot to annotate.
        spacing (int): The distance between the labels and the bars.
    """

    # For each bar: Place a label
    for rect in ax.patches:
        # Get X and Y placement of label from rect.
        y_value = rect.get_height()
        x_value = rect.get_x() + rect.get_width() / 2

        # Number of points between bar and label. Change to your liking.
        space = spacing
        # Vertical alignment for positive values
        va = "bottom"

        # If value of bar is negative: Place label below bar
        if y_value < 0:
            # Invert space to place label below
            space *= -1
            # Vertically align label at top
            va = "top"

        # Use Y value as label and format number with one decimal place
        label = "{:.1f}".format(y_value)

        # Create annotation
        ax.annotate(
            label,  # Use `label` as label
            (x_value, y_value),  # Place label at end of the bar
            xytext=(0, space),  # Vertically shift label by `space`
            textcoords="offset points",  # Interpret `xytext` as offset in points
            ha="center",  # Horizontally center label
            va=va,
        )  # Vertically align label differently for
        # positive and negative values.
#+END_SRC

#+RESULTS:
:results:
:end:
** R

#+begin_src R
library(sidrar)
library(tidyverse)
library(xlsx)
## library(data.table)
## library(dtplyr)
## library(dplyr, warn.conflicts = FALSE)
library(cowplot)
logo_file <- './figs/Cecon_Logo.png'
source('https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R')

library(patchwork)
                                        # fun√ß√£ozinha dos esquemas --------------------------------------------------------------------

gen_poly <- function(x, .deg=3) {
  options(na.action="na.exclude")
  t <- 1:length(x)
  fit <- lm(x ~ poly(t, degree = .deg))
  pred <- predict(fit, data.frame(t = t))
  return(pred)
}


                                        # aplica na baguia toda -----------------------------------------------------------------------

deg <- 5 # degree do poly

argmax <- function(smoothed, w=1, ...) {
  require(zoo)
  n <- length(smoothed)
  smoothed <- zoo(smoothed)
  y.max <- rollapply(smoothed, 2*w+1, max, align="center")
  delta <- y.max - smoothed[-c(1:w, n+1-1:w)]
  i.max <- which(delta <= 0) + w
  return(i.max)
}

ggthemr::ggthemr('pale')
#+end_src

#+RESULTS:
:results:
‚îÄ‚îÄ [1mAttaching packages[22m ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tidyverse 1.3.0 ‚îÄ‚îÄ
[32m‚úî[39m [34mggplot2[39m 3.3.3     [32m‚úî[39m [34mpurrr  [39m 0.3.4
[32m‚úî[39m [34mtibble [39m 3.1.0     [32m‚úî[39m [34mdplyr  [39m 1.0.5
[32m‚úî[39m [34mtidyr  [39m 1.1.2     [32m‚úî[39m [34mstringr[39m 1.4.0
[32m‚úî[39m [34mreadr  [39m 1.4.0     [32m‚úî[39m [34mforcats[39m 0.5.0
‚îÄ‚îÄ [1mConflicts[22m ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ tidyverse_conflicts() ‚îÄ‚îÄ
[31m‚úñ[39m [34mdplyr[39m::[32mfilter()[39m masks [34mstats[39m::filter()
[31m‚úñ[39m [34mdplyr[39m::[32mlag()[39m    masks [34mstats[39m::lag()

Attaching package: ‚Äòpatchwork‚Äô

The following object is masked from ‚Äòpackage:cowplot‚Äô:

    align_plots
:end:
** Downloads

*** Google mobility

#+begin_src sh :dir /HDD/Cecon_Atividade/Nota_016/ :exports none

wget -O ./raw/Covid/Google_Mobility.csv https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv
#+end_src

#+RESULTS:
:results:
Erro: unexpected symbol in "wget -O ."
:end:

*** Brasil.io

#+begin_src sh :dir /HDD/Cecon_Atividade/Nota_016/ :exports none
wget -O ./raw/Covid/Casos_Brasilio.csv.gz https://data.brasil.io/dataset/covid19/caso_full.csv.gz
gunzip ./raw/Covid/Casos_Brasilio.csv.gz
#+end_src

#+RESULTS:
:results:
Erro: unexpected symbol in "wget -O ."
Erro: unexpected symbol in "gunzip ."
:end:

* Indicadores de antecedente
** IBC-Br (acumulado 12 meses vs 12 meses anteriores)

#+BEGIN_SRC python :results graphics file :file ./figs/Antecedente/IBCBr.pdf

df = consulta_bc(24364, ["IBCBr (%YoY)"])
df.index.name = ""
# df = rebase(df)
df = df.pct_change(12)
df = (1 + df / 100).rolling(window=12).agg(lambda x: x.prod()) - 1
df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"IBCBr Dessazonalizado",
    ax=ax,
    lw=2.5,
    color="black",
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label=corona_sp_txt)
ax.axhline(y=0, color="gray", ls="-")
ax.set_yticklabels(["{:,.2%}".format(x) for x in ax.get_yticks()])
ax.legend()
# ax.set_ylabel("Taxa de crescimento YoY (%)")
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()

fig.savefig(
    "./figs/Antecedente/" + "IBCBr" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/Antecedente/IBCBr.pdf]]

** Tr√°fego de ve√≠culos pesados nas estradas pedagiadas - ABCR - Dados dessazonalizados


#+BEGIN_SRC python  :results graphics file :file ./figs/Setoriais/TrafegoPedagio.pdf
df = consulta_bc(28553, ["ABCR"])


df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Tr√°fego de ve√≠culos pesados nas estradas pedagiadas\nDados dessazonalizados",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/TrafegoPedagio" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/TrafegoPedagio.pdf]]


* Dados de alta frequ√™ncia

** Bloomberg adaptado ao COVID-19 ([[https://www.bloomberg.com/news/articles/2020-11-13/alternative-data-show-activity-crashes-as-virus-resurges-chart][Link]])

** Google Reports: Brasil

*** Baixando :noexport:

#+begin_src shell :dir /HDD/Cecon_Atividade/Nota_016/raw/Granulares/ :exports none
wget -N https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/google_reports/mobility_report_brazil.csv
#+end_src

#+RESULTS:
:results:
:end:

*** Brasil

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/GoogleReport_Brasil.pdf
df = pd.read_csv(
    "./raw/Granulares/mobility_report_brazil.csv",
    index_col="date",
    dayfirst=True,
)
df = df[df["sub region 1"] == "Total"].copy(deep=True)
df.drop(["country", "sub region 1", "sub region 2"], axis="columns", inplace=True)
df.index.name = ""
df.index = pd.to_datetime(df.index)
df.columns = [
    "Varejo e recrea√ß√£o",
    "Mercados e Farm√°cias",
    "Parques",
    "Esta√ß√µes de transporte p√∫blico",
    "Locais de trabalho",
    "Resid√™ncia",
]


fig, ax = plt.subplots(figsize=(8, 5))
df.rolling(7).mean().plot(
    title="Relat√≥rio de mobilidade do google - Brasil\nSemana M√≥vel",
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)

ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))

# Formatando eixos
days = mdates.DayLocator()  # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter("%b")
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter("%d/%m")

ax2 = plt.axes([0.9, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/GoogleReport_Brasil" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/GoogleReport_Brasil.pdf]]

*** Estado de S√£o Paulo

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/GoogleReport_EstadoSP.pdf
sp = pd.read_csv(
    "./raw/Granulares/mobility_report_brazil.csv",
    index_col="date",
    dayfirst=True,
)
sp = sp[sp["sub region 2"] == "Total"]
sp = sp[sp["sub region 1"] == "State of S√£o Paulo"]
sp.drop(["country", "sub region 1", "sub region 2"], axis="columns", inplace=True)
sp.index.name = ""
sp.index = pd.to_datetime(sp.index)
sp.columns = [
    "Varejo e recrea√ß√£o",
    "Mercados e Farm√°cias",
    "Parques",
    "Esta√ß√µes de transporte p√∫blico",
    "Locais de trabalho",
    "Resid√™ncia",
]

fig, ax = plt.subplots(figsize=(8, 5))
sp.rolling(7).mean().plot(
    title="Relat√≥rio de mobilidade do google - Estado de S√£o Paulo\nSemana M√≥vel",
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)

ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))

# Formatando eixos
days = mdates.DayLocator()  # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter("%b")
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter("%d/%m")

ax2 = plt.axes([0.9, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()
fig.savefig(
    "./figs/Granulares/GoogleReport_EstadoSP" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/GoogleReport_EstadoSP.pdf]]

*** Cidade de S√£o Paulo

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/GoogleReport_CidadeSP.pdf
cidade = pd.read_csv(
    "./raw/Granulares/mobility_report_brazil.csv",
    index_col="date",
    dayfirst=True,
)
cidade = cidade[cidade["sub region 1"] == "State of S√£o Paulo"]
cidade = cidade[cidade["sub region 2"] == "S√£o Paulo"]
cidade.drop(["country", "sub region 1", "sub region 2"], axis="columns", inplace=True)
cidade.index.name = ""
cidade.index = pd.to_datetime(cidade.index)
cidade.columns = [
    "Varejo e recrea√ß√£o",
    "Mercados e Farm√°cias",
    "Parques",
    "Esta√ß√µes de transporte p√∫blico",
    "Locais de trabalho",
    "Resid√™ncia",
]

fig, ax = plt.subplots(figsize=(8, 5))
cidade.rolling(7).mean().plot(
    title="Relat√≥rio de mobilidade do google - Cidade de S√£o Paulo\nSemana M√≥vel",
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)

ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))

# Formatando eixos
days = mdates.DayLocator()  # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter("%b")
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter("%d/%m")

ax2 = plt.axes([0.9, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/GoogleReport_CidadeSP" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/GoogleReport_CidadeSP.pdf]]

** Apple: Tend√™ncias de mobilidade

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/AppleReport_Brasil.pdf
df = pd.read_csv(
    'https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/apple_reports/applemobilitytrends.csv',
    # index_col = 'date',
    # dayfirst=True
)
df = df[df['country'] == 'Brazil'].copy(deep=True)
df = df[df['geo_type'] == 'sub-region'].copy(deep=True)
df = df[df['transportation_type'] == 'driving'].copy(deep=True)
df.drop([
    'country',
    'geo_type',
    'transportation_type',
    'sub-region',
    'alternative_name',
], axis = 'columns', inplace=True)
df.set_index('region', inplace=True)
df.index.name=''
df = df.transpose().bfill()
df.index = pd.to_datetime(df.index)

fig, ax = plt.subplots(figsize=(8, 5))
df.rolling(7).mean().plot(
    title=f'Relat√≥rio de mobilidade da Apple: Dire√ß√£o\nSemana M√≥vel - {df.index[0]: %d/%b/%Y} = 100',
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)

ax.legend(
    loc='upper center',
    bbox_to_anchor=(0.5, -0.05),
    ncol=4
)

# Formatando eixos
days = mdates.DayLocator()   # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter('%b')
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter('%d/%m')

ax2 = plt.axes([0.9, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/AppleReport_Brasil" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/AppleReport_Brasil.pdf]]

** Waze: $\Delta \%$ Km

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/Waze_Brasil.pdf
df = pd.read_csv(
    'https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/waze_reports/Waze_Country-Level_Data.csv',
    index_col = 'Date',
    dayfirst=True
)
df = df[df['Country'] == 'Brazil'].copy(deep=True)
df.index.name=''
df.index = pd.to_datetime(df.index)

fig, ax = plt.subplots(figsize=(8, 5))
df.rolling(7).mean().plot(
    title='Waze: Mudan√ßa percentual de Kilometros andados\nSemana M√≥vel',
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)

ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))

# Formatando eixos
days = mdates.DayLocator()   # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter('%b')
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter('%d/%m')

ax2 = plt.axes([0.9, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/Waze_Brasil" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/Waze_Brasil.pdf]]

** TomTom: Congestionamento

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/TomTom_Brasil.pdf
df = pd.read_csv(
    'https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/tomtom_reports/tomtom_trafic_index.csv',
    index_col = 'date',
    dayfirst=True
)
df = df[df['country'] == 'Brazil'].copy(deep=True)
df.index.name=''
df.index = pd.to_datetime(df.index)

df['Capitais'] = df['city']
df['Varia√ß√£o do congestionamento'] = df['diffRatio'].rolling(7).mean()

df = df[[
    'Capitais',
    'Varia√ß√£o do congestionamento'
]].dropna()
df['Capitais'] = df['Capitais'].astype('category')
df = pd.pivot(df, columns='Capitais')
df.columns = df.columns.get_level_values(1)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title='TomTom: Varia√ß√£o percentual do congestionamento\nem rela√ß√£o a 2019 - Semana M√≥vel',
    ax=ax,
    lw=1.5,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)

ax.legend(
    loc="center left",
    bbox_to_anchor=(1, 0.5),
    title = 'Capitais',
)

# Formatando eixos
days = mdates.DayLocator()   # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter('%b')
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter('%d/%m')

ax2 = plt.axes([0.7, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/TomTom_Brasil" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/TomTom_Brasil.pdf]]

* Atividade


** Baixando dados e criando nomes :ignore:
#+BEGIN_SRC sh :dir ./raw/ContasNacionais/ :exports none :eval no
wget -N --backups=1 ftp://ftp.ibge.gov.br/Contas_Nacionais/Contas_Nacionais_Trimestrais/Tabelas_Completas/Tab_Compl_CNT.zip
unzip -o Tab_Compl_CNT.zip
mv *.xls Tab_Compl_CNT.xlsx
#+END_SRC

#+BEGIN_SRC python
Colunas = [
    "Agropecuaria",
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria",
    "Comercio",
    "Transporte, armazenagem e correio",
    "Informacao e comunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
    "VA",
    "PIB",
    "Consumo das Familias",
    "Consumo do Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Agropecuaria = ['Agropecuaria']

Industria = [
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria"
]

Servicos = [
    "Comercio",
    "Transporte, armazenagem e correio",
    "Informacao e comunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
]

Demanda = [
    "Consumo das Familias",
    "Consumo do Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Oferta = [
    'Agropecuaria',
    "Total Industria",
    "Total Servicos",
]

df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Val encad pre√ßos 95 com ajuste', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
#+END_SRC

#+RESULTS:
:results:
:end:

** Trimestre Contra trimestre imediatamente anterior

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/PIB.pdf
fig = plt.figure(figsize=(9, 4))
ax = plt.axes()
ax2 = plt.axes([0.15, 0.6, 0.2, 0.2])

suptitle = "Taxa de crescimento"
title = "Trimestre contra trimestre anterior"


df["PIB"].pct_change()["2019":].plot(
    ax=ax,
    color="darkblue",
    kind="bar",
    edgecolor="black",
    lw=1.5,
)
ax.axhline(y=0, ls="-", color="black")

plt.suptitle(suptitle, color="black", weight="bold")
ax.set_title(title, color="black")

# ax.text(0.95, -0.2, 'Fonte: IBGE',
#         verticalalignment='bottom', horizontalalignment='right',
#         transform=ax.transAxes,
#         color='black', fontsize=10)

# ax.text(0.6, -0.2, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
#         verticalalignment='bottom', horizontalalignment='right',
#         transform=ax.transAxes,
#         color='black', fontsize=10)

# sns.set_style("white")
sns.set_context("paper", font_scale=1.2)
sns.despine()
ax.tick_params(axis="x", colors="black")
ax.tick_params(axis="y", colors="black")
ax.yaxis.label.set_color("black")
ax.xaxis.label.set_color("black")
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: "{:.1%}".format(y)))
# ax.set_xticklabels(ax.get_xticklabels(), rotation=0)
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.savefig(
    "./figs/PIB/PIB.pdf",
    dpi=300,
    bbox_inches="tight",
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/PIB.pdf]]

** Trimestre Contra mesmo trimestre do ano anterior

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/PIB_YoY.pdf
fig = plt.figure(figsize=(9,4))
ax = plt.axes()
ax2 = plt.axes([0.15,0.6,0.2,0.2])

suptitle = 'Taxa de crescimento'
title = 'Trimestre contra mesmo trimestre do ano anterior'


df['PIB'].pct_change(4)["2019":].plot(ax=ax, color='darkblue', kind='line')
ax.axhline(y=0, ls='--', color='black')

plt.suptitle(suptitle, color='black', weight = 'bold')
ax.set_title(title, color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
# ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

fig.savefig('./figs/PIB/PIB_YoY.pdf', dpi=300)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/PIB_YoY.pdf]]

** Agropecu√°ria

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Agropecuaria.pdf
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Agropecuaria].pct_change().tail(4).plot(kind='bar', ax=ax, color='darkblue')

plt.suptitle('Agricultura', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

fig.savefig(
    './figs/PIB/Agropecuaria.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Agropecuaria.pdf]]

** Ind√∫stria

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Industria.pdf
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Industria].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('Ind√∫stria', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Industria.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Industria.pdf]]


** Servi√ßos

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Servicos.pdf
fig, ax = plt.subplots(figsize=(8,5))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Servicos].pct_change().tail(4).plot(kind='bar', ax=ax)
lgd = ax.legend(
    loc='center left',
    bbox_to_anchor=(1, 0.5)
)


plt.suptitle('Servi√ßos', color='black', weight = 'bold')

ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Servicos.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Servicos.pdf]]

** Demanda

#+BEGIN_SRC python   :results graphics file :file ./figs/PIB/Demanda.pdf
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Demanda + ['PIB']].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('Demanda', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Demanda.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Demanda.pdf]]

** Oferta


#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Oferta.pdf
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Oferta + ['PIB']].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('Oferta', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
plt.close()
fig.savefig(
    './figs/PIB/Oferta.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
    )
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Oferta.pdf]]


** Contribui√ß√£o para varia√ß√£o: Demanda

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Contrib_Demanda.pdf
fig, ax = plt.subplots(figsize=(8,5))
ax2 = fig.add_axes([0.15,0.7,0.2,0.2])

df[Demanda].diff().apply(lambda x: x/(df["PIB"].shift())).tail(4).plot(
    kind = 'bar',
    stacked = True,
    ax = ax,
    color = (
        "tomato",
        "darkred",
        "darkslateblue",
        "tan",
        "khaki"
    ),
    width = 0.75,
    edgecolor='black'
)
plt.suptitle('Demanda', color='black', weight = 'bold')
ax.axhline(y=0, color='black', linestyle='-', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Contribui√ß√£o para varia√ß√£o do PIB', color='black')

ax.text(0.95, -0.125, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.125, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Contrib_Demanda.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Contrib_Demanda.pdf]]

** Contribui√ß√£o para varia√ß√£o: Oferta

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Contrib_Oferta.pdf
fig, ax = plt.subplots(1,1,figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


#df["PIB"].pct_change().tail(12).plot(ax = ax, kind = 'line', legend = True, color = 'black')
df[Oferta].diff().apply(lambda x: x/(df["VA"].shift())).tail(4).plot(
    kind = 'bar',
    stacked = True,
    ax = ax,
    color = (
        "green",
    #    "darkred",
        "darkslateblue",
        "tan",
    #    "khaki"
    ),
    cmap="Set1",
    width = 0.75,
    edgecolor='black'
)

plt.suptitle('Oferta', color='black', weight = 'bold')
ax.axhline(y=0, color='black', linestyle='-', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Contribui√ß√£o para varia√ß√£o do valor adicionado', color='black')

ax.text(0.95, -0.125, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.125, 'Atualizado em {}. √öltimo dado dispon√≠vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Contrib_Oferta.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Contrib_Oferta.pdf]]


** Contribui√ß√£o para varia√ß√£o: Servi√ßos

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Contrib_Servicos.pdf
fig, ax = plt.subplots(1, 1, figsize=(9, 4))
ax2 = fig.add_axes([0.15, 0.6, 0.2, 0.2])


# df["PIB"].pct_change().tail(12).plot(ax = ax, kind = 'line', legend = True, color = 'black')
df[Servicos].drop(["Total Servicos"], axis="columns").diff().apply(
    lambda x: x / (df["Total Servicos"].shift())
).tail(4).plot(
    kind="bar",
    stacked=True,
    ax=ax,
    color=(
        "green",
        "darkred",
        "darkslateblue",
        "tan",
        "khaki",
        "gray",
        "orange",
    ),
    cmap="Set1",
    width=0.75,
    edgecolor="black",
)

plt.suptitle("Servi√ßos", color="black", weight="bold")
ax.axhline(y=0, color="black", linestyle="-", lw=2)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))


ax.set_title("Contribui√ß√£o para varia√ß√£o", color="black")

ax.text(
    0.95,
    -0.125,
    "Fonte: IBGE",
    verticalalignment="bottom",
    horizontalalignment="right",
    transform=ax.transAxes,
    color="black",
    fontsize=10,
)

ax.text(
    0.6,
    -0.125,
    "Atualizado em {}. √öltimo dado dispon√≠vel: {}".format(
        dt.now().strftime("%d/%m/%Y"), df.index[-1]
    ),
    verticalalignment="bottom",
    horizontalalignment="right",
    transform=ax.transAxes,
    color="black",
    fontsize=10,
)

sns.despine()
ax.tick_params(axis="x", colors="black")
ax.tick_params(axis="y", colors="black")
ax.yaxis.label.set_color("black")
ax.xaxis.label.set_color("black")
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: "{:.1%}".format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")
fig.savefig(
    "./figs/PIB/Contrib_Servicos.pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Contrib_Servicos.pdf]]

** Acumulado no ano (sem ajuste)

*** Carregano dados :ignore:

#+BEGIN_SRC python :exports none
Colunas = [
    "Agropecuaria",
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria",
    "Comercio",
    "Transporte, armazenagem\ne correio",
    "Informacao e\ncomunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
    "VA",
    "Imposto",
    "PIB",
    "Consumo\ndas Familias",
    "Consumo\ndo Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Agropecuaria = ['Agropecuaria']

Industria = [
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria"
]

Servicos = [
    "Comercio",
    "Transporte, armazenagem\ne correio",
    "Informacao e\ncomunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
]

Demanda = [
    "Consumo\ndas Familias",
    "Consumo\ndo Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Oferta = [
    'Agropecuaria',
    "Total Industria",
    "Total Servicos",
]

df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
#+END_SRC

#+RESULTS:
:results:
:end:

*** Servi√ßos

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Servicos_Acum.pdf
df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
last = str(df.index.to_list()[-1]).split(' ')[0]
df = df[last:][Servicos].transpose().sort_values('2020-10-01', ascending=False)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em rela√ß√£o ao\nmesmo per√≠odo do ano anterior",
    ax=ax,
    lw=2.5,
    legend = False,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax.axhline(y=0, ls='-', lw=1.0, color='black')

add_value_labels(ax)

ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/Servicos_Acum" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Servicos_Acum.pdf]]

*** Servi√ßos (compara√ß√£o com ano anterior)

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Servicos_Acum_Comparativo.pdf
df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df.index = df.index.to_timestamp()

last = str(df.index.to_list()[-1]).split(' ')[0]
previous = str(df.index.to_list()[-5]).split(' ')[0]
df = df.loc[[previous, last],:]
df = df[Servicos].transpose().sort_values('2020-10-01', ascending=False)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em rela√ß√£o ao\nmesmo per√≠odo do ano anterior",
    ax=ax,
    lw=2.5,
    legend = False,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax.axhline(y=0, ls='-', lw=1.0, color='black')

add_value_labels(ax)

ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/Servicos_Acum_Comparativo" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Servicos_Acum_Comparativo.pdf]]

*** Demanda

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Demanda_Acum.pdf
df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
# df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
last = str(df.index.to_list()[-1]).split(' ')[0]
df = df[last:][Demanda].transpose().sort_values('2020-10-01', ascending=False)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em rela√ß√£o ao\nmesmo per√≠odo do ano anterior",
    ax=ax,
    lw=2.5,
    legend = False,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax.axhline(y=0, ls='-', lw=1.0, color='black')
ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/Demanda_Acum" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Demanda_Acum.pdf]]

*** Demanda (compara√ß√£o com ano anterior)

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Demanda_Acum_Comparativo.pdf
df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
# df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
last = str(df.index.to_list()[-1]).split(' ')[0]
previous = str(df.index.to_list()[-5]).split(' ')[0]
df = df.loc[[previous, last],:]
df = df[Demanda].transpose().sort_values(last, ascending=False)

df.columns = [previous[:4], last[:4]]
fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em rela√ß√£o ao\nmesmo per√≠odo do ano anterior",
    ax=ax,
    lw=2.5,
    legend = False,
    kind = 'bar', edgecolor='black', width=.8,
    color = ('teal', 'darkred')
)
ax.legend()
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax.axhline(y=0, ls='-', lw=1.0, color='black')
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

add_value_labels(ax)

ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/Demanda_Acum_Comparativo" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Demanda_Acum_Comparativo.pdf]]

*** PIB

#+BEGIN_SRC python :exports none
Colunas = [
    "Agropecu√°ria",
    "Ind. Extrativa",
    "Ind. de Transforma√ß√£o",
    "Eletricidade e g√°s, √°gua,esgoto,\nativ. de gest√£o de res√≠duos",
    "Constru√ß√£o",
    "Total Industria",
    "Com√©rcio",
    "Transporte, armazenagem\ne correio",
    "Informa√ß√£o e\ncomunica√ß√£o",
    "Ativ. Financeiras, de seguros e\nservi√ßos relacionados",
    "Ativ. Imobili√°rias",
    "Outras atividades de servi√ßos",
    "Adm., defesa, sa√∫de e educa√ß√£o\np√∫blicas e seguridade social",
    "Total Servicos",
    "VA",
    "Imposto",
    "PIB",
    "Consumo\ndas Familias",
    "Consumo\ndo Governo",
    "FBCF",
    "Exportacao",
    "Importacao",
]

Agropecuaria = ["Agropecu√°ria"]

Industria = [
    "Ind. Extrativa",
    "Ind. de Transforma√ß√£o",
    "Eletricidade e g√°s, √°gua,esgoto,\nativ. de gest√£o de res√≠duos",
    "Constru√ß√£o",
    # "Total Industria",
]

Servicos = [
    "Com√©rcio",
    "Transporte, armazenagem\ne correio",
    "Informa√ß√£o e\ncomunica√ß√£o",
    "Ativ. Financeiras, de seguros e\nservi√ßos relacionados",
    "Ativ. Imobili√°rias",
    "Outras atividades de servi√ßos",
    "Adm., defesa, sa√∫de e educa√ß√£o\np√∫blicas e seguridade social",
    # "Total Servicos",
]

Demanda = [
    "Consumo\ndas Familias",
    "Consumo\ndo Governo",
    "FBCF",
    "Exportacao",
    "Importacao",
]

Oferta = [
    "Agropecuaria",
    "Total Industria",
    "Total Servicos",
]

df = pd.read_excel(
    "./raw/ContasNacionais/Tab_Compl_CNT.xlsx",
    header=3,
    sheet_name="Acum. em 4 trimestres",
    index_col=0,
)
df.index = (
    df.index.str.replace(".", "Q")
    .str.replace("IV", "4")
    .str.replace("III", "3")
    .str.replace("II", "2")
    .str.replace("I", "1")
)
df.index = pd.PeriodIndex(df.index, freq="Q")
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
#+END_SRC

#+RESULTS:
:results:
:end:

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/PIB_Acum.pdf
df = pd.read_excel(
    "./raw/ContasNacionais/Tab_Compl_CNT.xlsx",
    header=3,
    sheet_name="Acum. em 4 trimestres",
    index_col=0,
)
df.index = (
    df.index.str.replace(".", "Q")
    .str.replace("IV", "4")
    .str.replace("III", "3")
    .str.replace("II", "2")
    .str.replace("I", "1")
)
df.index = pd.PeriodIndex(df.index, freq="Q")
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
last = str(df.index.to_list()[-1]).split(" ")[0]
df = (
    df[last:][Servicos + Industria + Agropecuaria + ["PIB"]]
    .transpose()
    .sort_values("2020-10-01", ascending=False)
)


colors = "".join(["r" if col == "PIB" else "b" for col in df.index])

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em rela√ß√£o ao\nmesmo per√≠odo do ano anterior",
    ax=ax,
    lw=1.5,
    legend=False,
    kind="bar",
    edgecolor="black",
    width=0.8,
    color=colors,
)
ax.set_yticklabels(["{:,.0%}".format(x / 100) for x in ax.get_yticks()])
ax.axhline(y=0, ls="-", lw=1.0, color="black")

add_value_labels(ax)

ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/PIB_Acum" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/PIB_Acum.pdf]]

* Cr√©dito
#+begin_src python
start_year = '2019-01-01'
#+end_src

#+RESULTS:
:results:
:end:

** Endividamento das fam√≠lias

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/EndividamentoFamilias.pdf
titulo = "Endividamento das fam√≠lias\nTotal e Exceto cr√©dito habitacional"
porcentagem = True
unidade = "renda acum.\n√∫ltimos 12 meses"
df = pd.concat(
    [
        consulta_bc(19882, ["Total"]),
        consulta_bc(20400, ["Exceto cr√©dito habitacional"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ""
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df[start_year:].plot(
    title=titulo,
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(["{:,.0f}".format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f"R$ {unidade}")
else:
    ax.set_yticklabels(["{:,.2%}".format(x / 100) for x in ax.get_yticks()])
    ax.set_ylabel(f"em % {unidade}")
ax2 = plt.axes([0.9, 0.6, 0.2, 0.2])


ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()
plt.close()

fig.savefig(
    "./figs/Credito/EndividamentoFamilias" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/EndividamentoFamilias.pdf]]


** Saldo Pessoal Jur√≠dica - N√≠vel
     
#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoPJ.pdf
titulo = "Saldo Pessoa jur√≠dica"
porcentagem=False
unidade="Milh√µes"
df = pd.concat(
    [
        consulta_bc(20543, ["Saldo Pessoa jur√≠dica livre"]),
        consulta_bc(20594, ["Saldo Pessoa jur√≠dica direcionados"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ''
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    lw=2, 
)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='In√≠cio isolamento\nsocial em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.2%}'.format(x/100) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.close()

fig.savefig(
    './figs/Credito/SaldoPJ' +   '.pdf',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoPJ.pdf]]



** Saldo Pessoa Jur√≠dica - em % do PIB
#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoPJ_PIB.pdf
titulo = "Saldo Pessoa jur√≠dica\nem % PIB"
porcentagem = True
unidade = "PIB"
df = pd.concat(
    [
        consulta_bc(20626, ["Recursos livres"]),
        consulta_bc(20629, ["Recursos direcionados"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ""
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df[start_year:].plot(
    title=titulo,
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(["{:,.0f}".format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f"R$ {unidade}")
else:
    ax.set_yticklabels(["{:,.2%}".format(x / 100) for x in ax.get_yticks()])
    ax.set_ylabel(f"em % {unidade}")
ax2 = plt.axes([0.9, 0.6, 0.2, 0.2])


ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()
plt.close()

fig.savefig(
    "./figs/Credito/SaldoPJ_PIB" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoPJ_PIB.pdf]]

** Saldo Pessoa f√≠sica - N√≠vel

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoPF.pdf
titulo = "Saldo Pessoa f√≠sica"
porcentagem = False
unidade = "Milh√µes"
df = pd.concat(
    [
        consulta_bc(20570, ["Saldo Pessoa f√≠sica livre"]),
        consulta_bc(20606, ["Saldo Pessoa f√≠sica direcionados"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ""
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df[start_year:].plot(
    title=titulo,
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(["{:,.0f}".format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f"R$ {unidade}")
else:
    ax.set_yticklabels(["{:,.2%}".format(x / 100) for x in ax.get_yticks()])
    ax.set_ylabel(f"em % {unidade}")
ax2 = plt.axes([0.9, 0.6, 0.2, 0.2])


ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()
plt.close()

fig.savefig(
    "./figs/Credito/SaldoPF" + ".pdf", dpi=300, bbox_inches="tight", pad_inches=0
)
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoPF.pdf]]


** Saldo Pessoa f√≠sica - em % do PIB

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoPF_PIB.pdf
titulo = "Saldo Pessoa f√≠sica\nem % PIB"
porcentagem = True
unidade = "PIB"
df = pd.concat(
    [
        consulta_bc(20627, ["Recursos livres"]),
        consulta_bc(20630, ["Recursos direcionados"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ""
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df[start_year:].plot(
    title=titulo,
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento\nsocial em SP"
)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(["{:,.0f}".format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f"R$ {unidade}")
else:
    ax.set_yticklabels(["{:,.2%}".format(x / 100) for x in ax.get_yticks()])
    ax.set_ylabel(f"em % {unidade}")
ax2 = plt.axes([0.9, 0.6, 0.2, 0.2])


ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()
plt.close()

fig.savefig(
    "./figs/Credito/SaldoPF_PIB" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoPF_PIB.pdf]]


** Cr√©dito ampliado em % do Total

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoCreditoAmpliado_Total.pdf
titulo = "Saldo Cr√©dito Ampliado\nem % do Total"
porcentagem=True
unidade="do Total"
df = pd.concat(
    [
        consulta_bc(28183, ["Setor n√£o financeiro"]),
        consulta_bc(28196, ["Governo geral"]),
        consulta_bc(28203, ["Empresas e Fam√≠lias"]),
    ],
    axis=1,
)
df = df[start_year:]
df = df.apply(pd.to_numeric, errors='coerce')
df["Total"] = df.sum(axis=1)
df = df.apply(lambda x: x/df["Total"]).drop(["Total"], axis='columns')

df.index.name = ''


fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    kind='bar', stacked=True, edgecolor='black',
    lw=2,
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
#ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='In√≠cio isolamento\nsocial em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else:
    ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.close()

fig.savefig(
    './figs/Credito/SaldoCreditoAmpliado_Total' + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoCreditoAmpliado_Total.pdf]]

** Indicadores de aprova√ß√£o de cr√©dito

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/PTC.pdf
titulo = "Indicadores de aprova√ß√£o de cr√©dito\nAprova√ß√µes Esperadas - Observadas"
porcentagem=False
unidade="Pontos"
df = pd.concat(
    [
        consulta_bc(21396, ["Grandes - Esperadas"]),
        consulta_bc(21397, ["Grandes - Observadas"]),
        consulta_bc(21398, ["Micro - Esperadas"]),
        consulta_bc(21399, ["Micro - Observadas"]),
        consulta_bc(21400, ["Consumo - Esperadas"]),
        consulta_bc(21401, ["Consumo - Observadas"]),
        consulta_bc(21402, ["Habitacional - Esperadas"]),
        consulta_bc(21403, ["Habitacional - Observadas"]),
    ],
    axis=1,
)
df["Grandes Empresas"] = df["Grandes - Esperadas"] - df["Grandes - Observadas"]
df["Micro, Pequenas e M√©dias Empresas"] = df["Micro - Esperadas"] - df["Micro - Observadas"]
df["Consumo"] = df["Consumo - Esperadas"] - df["Consumo - Observadas"]
df["Habitacional"] = df["Habitacional - Esperadas"] - df["Habitacional - Observadas"]
df = df[["Grandes Empresas", "Micro, Pequenas e M√©dias Empresas", "Consumo", "Habitacional"]]

df = interpolator(df)
df = df[start_year:]

df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = titulo,
    ax = ax,
    # kind='bar', stacked=True, edgecolor='black',
    lw=2,
)
# ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
ax.set_ylabel('Esperadas - Observadas (Pontos)')
ax.axhline(y = 0, color='black', ls='-', lw=1,)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='In√≠cio isolamento\nsocial em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
# if porcentagem == False:
#     ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
#     ax.set_ylabel(f'{unidade}')
# else:
#     ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
#     ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.close()

fig.savefig(
    './figs/Credito/PTC' + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/PTC.pdf]]

** Recolhimentos compuls√≥rios de institui√ß√µes financeiras

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/Recolhimentos_Total.pdf
titulo = "Recolhimentos compuls√≥rios de institui√ß√µes financeira\nSaldo Total"
porcentagem=False
unidade="u.m.c (mil)"

df = consulta_bc(17633, ["Saldo Total"])

df = df[start_year:]
df = df.apply(pd.to_numeric, errors='coerce')

df.index.name = ''


fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    lw=2,
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='In√≠cio isolamento\nsocial em SP')
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else:
    ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.135,0.135,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.close()

fig.savefig(
    './figs/Credito/Recolhimentos_Total' + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/Recolhimentos_Total.pdf]]

* √çndices de atividade setoriais


** Pesquisa Mensal do Com√©rcio (PMC)

#+BEGIN_SRC python  :file ./figs/Setoriais/PMC_IBGE.pdf :results graphics file
df = pd.concat(
    [
        consulta_bc(28473, ["Total"]),
        consulta_bc(28474, ["Combust√≠veis e lubrificantes"]),
        consulta_bc(28475, ["Hipermercados, supermercados, produtos aliment√≠cios, bebidas e fumo"]),
        consulta_bc(28477, ["Tecido, vestu√°rio e cal√ßado"]),
        consulta_bc(28478, ["M√≥veis e eletrodom√©sticos - Brasil - Dados dessazonalizados"]),
        consulta_bc(28479, ["Autom√≥veis, motocicletas, partes e pe√ßas"]),
        consulta_bc(28480, ["Artigos farmac√™uticos, m√©dicos, ortop√©dicos, perfumaria e cosm√©ticos"]),
        consulta_bc(28481, ["Livros, jornais, revistas e papelaria"]),
        consulta_bc(28482, ["Equipamentos e materiais para escrit√≥rio e comunica√ß√£o"]),
        consulta_bc(28483, ["Outros artigos de uso pessoal e dom√©stico"]),
        consulta_bc(28484, ["Material de constru√ß√£o"]),
        consulta_bc(28485, ["Com√©rcio ampliado"]),
    ],
    axis=1,
)
df.index.name = ''
for col in df:
    df[col] = df[col].apply(lambda x: (100*x)/df[col][base])

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = f"Pesquisa Mensal do Com√©rcio (PMC)\nVolume de Vendas Dessazonalizado\n{base} = 100",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='In√≠cio isolamento social em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.close()

fig.savefig(
    './figs/Setoriais/PMC_IBGE' + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PMC_IBGE.pdf]]


** Pesquisa Industrial Mensal (PIM)

#+BEGIN_SRC python  :file ./figs/Setoriais/PIM_IBGE.pdf :results graphics file
df = pd.concat(
    [
        consulta_bc(28503, ["Geral"]),
        consulta_bc(28504, ["Extrativa mineral"]),
        consulta_bc(28505, ["Ind√∫stria de transforma√ß√£o"]),
        consulta_bc(28506, ["Bens de capital"]),
        consulta_bc(28507, ["Bens intermedi√°rios"]),
        consulta_bc(28508, ["Bens de consumo"]),
        consulta_bc(28509, ["Bens de consumo dur√°veis"]),
        consulta_bc(28510, ["Semidur√°veis e n√£o dur√°veis"]),
        consulta_bc(28511, ["Insumos da constru√ß√£o civil"]),
    ],
    axis=1,
)
df.index.name = ""
for col in df:
    df[col] = df[col].apply(lambda x: (100 * x) / df[col][base])

df = df[start_year:]
df = interpolator(df)


fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Pesquisa Industrial Mensal (PIM)\nSe√ß√µes de atividades desazonalizadas\n{base} = 100",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/PIM_IBGE" + ".pdf", dpi=300, bbox_inches="tight", pad_inches=0
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PIM_IBGE.pdf]]


** Pesquisa Mensal de Servi√ßos (PMS)
*** Receita nominal sem ajuste sazonal
#+BEGIN_SRC python  :results graphics file :file ./figs/Setoriais/PMS_IBGE.pdf
file_name = "PMS_IBGE"
df = pd.concat(
    [
        consulta_bc(21637, ["Total"]),
        consulta_bc(21638, ["Prestados √†s fam√≠lias"]),
        consulta_bc(21639, ["Informa√ß√£o e comunica√ß√£o"]),
        consulta_bc(21640, ["Profissionais, Administrativos e Complementares"]),
        consulta_bc(21641, ["Transportes, Servi√ßos auxiliares e Correio"]),
        consulta_bc(21642, ["Outros"]),
    ],
    axis=1,
)
df.index.name = ""

for col in df:
    df[col] = df[col].apply(lambda x: (100 * x) / df[col].loc[base])

df = df[start_year:]
df = interpolator(df)
df.columns = [
    "Total Geral",
    "Servi√ßos prestados √†s Fam√≠lias",
    "Servi√ßos de informa√ß√£o e comunica√ß√£o",
    "Servi√ßos Profissionais, Administrativos e Complementares",
    "Transportes, Servi√ßos auxiliares aos transportes e Correio",
    "Outros servi√ßos",
]

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Pesquisa Mensal de Servi√ßos (PMS)\nReceita nominal\n{base} = 100",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/PMS_IBGE" + ".pdf", dpi=300, bbox_inches="tight", pad_inches=0
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PMS_IBGE.pdf]]

*** Volume com ajuste sazonal


#+begin_src R :exports none
df <- get_sidra(
  api = "/t/6443/n1/all/v/8677/p/all/c11046/40312/c12355/31399,31426,106869,106874,106876,107071/d/v8677%201"
) %>%
  select( "M√™s (C√≥digo)", "Atividades de servi√ßos", "Valor") %>%
  mutate(Data =  paste0(`M√™s (C√≥digo)`, "01")) %>%
  mutate(Data = as.Date(Data, format="%Y%m%d")) %>%
  select(-c(`M√™s (C√≥digo)`)) %>%
  pivot_wider(names_from = "Atividades de servi√ßos", values_from = Valor)

names(df) <- c(
  "Data",
  "Profissionais, Administrativos e Complementares",
  "Outros",
  "Prestados √†s fam√≠lias",
  "Informa√ß√£o e comunica√ß√£o",
  "Transportes, Servi√ßos auxiliares e Correio",
  "Total"
  )
write.csv(
  df,
  './clean/IBGE/PMS_volume_dessazonalizada.csv',
  row.names=FALSE
)
#+end_src

#+RESULTS:
:results:
All others arguments are desconsidered when 'api' is informed
:end:

#+BEGIN_SRC python  :results graphics file :file ./figs/Setoriais/PMS_vol_dessazonalizada.pdf
df = pd.read_csv(
    "./clean/IBGE/PMS_volume_dessazonalizada.csv", index_col="Data", parse_dates=True
)

df.index.name = ""

for col in df:
    df[col] = df[col].apply(lambda x: (100 * x) / df[col].loc[base])

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Pesquisa Mensal de Servi√ßos (PMS)\n√çndice de Volume de servi√ßos dessazonalizado\n{base} = 100",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/PMS_vol_dessazonalizada" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PMS_vol_dessazonalizada.pdf]]

*** Volume com ajuste sazonal (em rela√ß√£o ao m√™s anterior)


#+begin_src R :exports none
df <- get_sidra(
  api = "/t/6443/n1/all/v/8677/p/all/c11046/40312/c12355/31399,31426,106869,106874,106876,107071/d/v8677%201"
) %>%
  select( "M√™s (C√≥digo)", "Atividades de servi√ßos", "Valor") %>%
  mutate(Data =  paste0(`M√™s (C√≥digo)`, "01")) %>%
  mutate(Data = as.Date(Data, format="%Y%m%d")) %>%
  select(-c(`M√™s (C√≥digo)`)) %>%
  pivot_wider(names_from = "Atividades de servi√ßos", values_from = Valor)

names(df) <- c(
  "Data",
  "Profissionais, Administrativos e Complementares",
  "Outros",
  "Prestados √†s fam√≠lias",
  "Informa√ß√£o e comunica√ß√£o",
  "Transportes, Servi√ßos auxiliares e Correio",
  "Total"
  )
write.csv(
  df,
  './clean/IBGE/PMS_volume_dessazonalizada.csv',
  row.names=FALSE
)
#+end_src

#+RESULTS:
:results:
All others arguments are desconsidered when 'api' is informed
:end:

#+BEGIN_SRC python  :results graphics file :file ./figs/Setoriais/PMS_vol_dessazonalizada_diff.pdf
df = pd.read_csv(
    "./clean/IBGE/PMS_volume_dessazonalizada.csv", index_col="Data", parse_dates=True
)

df.index.name = ""

for col in df:
    df[col] = df[col].apply(lambda x: (100 * x) / df[col].loc[base])

df = df["2020-01-01":]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.diff().plot(
    title=f"Pesquisa Mensal de Servi√ßos (PMS)\n√çndice de Volume de servi√ßos dessazonalizado\nComparado ao m√™s anterior",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.axhline(y=0, color="black", ls="-", lw=1)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/PMS_vol_dessazonalizada_diff" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PMS_vol_dessazonalizada_diff.pdf]]

* Emprego

** Rendimento m√©dio real habitual das pessoas ocupadas


#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/RMHPO.pdf
df = pd.concat(
    [
        consulta_bc(24383, ["Com carteira"]),
        consulta_bc(24384, ["Sem carteira"]),
        consulta_bc(24385, ["Setor privado"]),
        consulta_bc(24386, ["Setor p√∫blico"]),
        consulta_bc(24387, ["Conta pr√≥pria"]),
        consulta_bc(24388, ["Empregadores"]),
    ],
    axis=1,
)

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Rendimento m√©dio real habitual\ndas pessoas ocupadas - PNADC",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/RMHPO" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/RMHPO.pdf]]

** Massa de rendimento real efetiva e habitual de todos os trabalhos

#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/MRR_Efetiva_Habitual.pdf
df = pd.concat(
    [
        consulta_bc(28544, ["Efetiva"]),
        consulta_bc(28545, ["Habitual"]),
    ],
    axis=1,
)

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Massa de rendimento real efetiva e\nhabitual de todos os trabalhos",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/MRR_Efetiva_Habitual" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/MRR_Efetiva_Habitual.pdf]]

** Massa Salarial Ampliada Dispon√≠vel - PNADC

#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/MSAD.pdf
df = consulta_bc(22079, ["MSAD - PNADC"])

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Massa Salarial Ampliada Dispon√≠vel PNADC",
    ax=ax,
    lw=2.5,
)
ax.set_yticklabels(["{:,.2f}".format(x / 1000) for x in ax.get_yticks()])
ax.set_ylabel('R$ Bilh√µes')
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/MSAD" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/MSAD.pdf]]

** Rendimento habitual m√©dio por atividade


#+BEGIN_SRC python   :tangle ./codes/pnad.py :eval no
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Mensal RHM Setor Real",
    skiprows = 11,
    usecols = "A:K",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''
df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Rendimento habitual m√©dio por atividade",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='In√≠cio isolamento social em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.close()

fig.savefig(
    image_path + file_path.strip("/")[-1] + "RHM_Setor" + "_" + '.pdf',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
:end:

** N√∫mero de horas trabalhadas - ind√∫stria de transforma√ß√£o

#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/Horas_Transformacao.pdf
df = consulta_bc(24348, ["Ind√∫stria de transforma√ß√£o"])

df = rebase(df, base='2020-01-01')
df = df['2019-01-01':]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"N√∫mero de horas trabalhadas - Dados dessazonalizados\nJan/2020 = 100",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/Horas_Transformacao" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/Horas_Transformacao.pdf]]

** Novo CAGED  - Por atividade (dados dessazonalizados)

#+BEGIN_SRC python :results graphics file :file ./figs/Emprego/NovoCaged_Atividade.pdf
df = pd.concat(
    [
        # consulta_bc(28784, ["Total"]),
        consulta_bc(28785, ["Agropecu√°ria"]),
        consulta_bc(28786, ["Ind√∫strias extrativas"]),
        consulta_bc(28787, ["Ind√∫strias de transforma√ß√£o"]),
        # consulta_bc(28788, ["SIUP"]),
        # consulta_bc(28789, ["Eletricidade e g√°s"]),
        # consulta_bc(28790, ["√Ågua, esgoto, atividades de\ngest√£o de res√≠duos e descontamina√ß√£o"]),
        consulta_bc(28791, ["Constru√ß√£o"]),
        consulta_bc(28792, ["Com√©rcio"]),
        consulta_bc(28793, ["Servi√ßos"]),
        # consulta_bc(28794, ["Transporte, armazenamento e correios"]),
        # consulta_bc(28795, ["Alojamento e alimenta√ß√£o"]),
        # consulta_bc(28796, ["Informa√ß√£o e comunica√ß√£o"]),
        # consulta_bc(28797, ["Atividades financeiras e seguros"]),
        # consulta_bc(28798, ["Atividades imobili√°rias"]),
        # consulta_bc(28799, ["Atividades profissionais, cient√≠ficas e t√©cnicas"]),
        # consulta_bc(28800, ["Atividades administrativas e servi√ßos complementares"]),
        # consulta_bc(28801, ["Administra√ß√£o p√∫blica, defesa e seguridade social"]),
        consulta_bc(28802, ["Educa√ß√£o"]),
        consulta_bc(28803, ["Sa√∫de e servi√ßos sociais"]),
        # consulta_bc(28804, ["Outras atividades de servi√ßos"]),
    ],
    axis = 1
)
df.index.name = ''
df = df['2019':]

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Novo Caged por atividade - Dados dessazonalizados",
    ax = ax,
    lw = 1.5,
    edgecolor = 'black',
    kind = 'bar', stacked = True, width=0.9
)



ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([.9,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.close()

fig.savefig(
    './figs/Emprego/NovoCaged_Atividade.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/NovoCaged_Atividade.pdf]]



** Taxa de desocupa√ß√£o

#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/TaxaDesocupacao.pdf
df = consulta_bc(24369, ["Taxa de desocupa√ß√£o - PNADC"])


df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa de desocupa√ß√£o\nPNADC (em %)",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/TaxaDesocupacao" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/TaxaDesocupacao.pdf]]


** Desalentados e subocupados :noexport:

#+BEGIN_SRC python   :tangle ./codes/pnad.py :eval no
var = "Desalentados_Subocupados"
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Dessaz",
    skiprows = 11,
    usecols = "A,D,S,T",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''
df.columns = [
    "For√ßa de trabalho",
    "Subocupados",
    "Desalentados"
]
df = df.apply(pd.to_numeric, errors='coerce')
df["Taxa de desalentados"] = df["Desalentados"]/df["For√ßa de trabalho"]
df["Taxa de Subocupados por \ninsufici√™ncia de horas trabalhadas"] = df["Subocupados"]/df["For√ßa de trabalho"]
df = df[start_year:]
df = df[["Taxa de desalentados", "Taxa de Subocupados por \ninsufici√™ncia de horas trabalhadas"]]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Taxa de desalentados e subocupatos\n(em % da for√ßa de trabalho)",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='In√≠cio isolamento social em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.close()

fig.savefig(
    image_path + file_path.strip("/")[-1] + var.replace(" ", "_") + "_" + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
:end:

* PNAD-COVID
** R trial
#+begin_src R :eval no
library(dplyr)
library(srvyr)
library(readr)
library(ggplot2)
library(Cairo)
library(cowplot)
library(magick)

logo_file <- './figs/Cecon_Logo.pdf'

pnad_covid <- read_csv("./raw/PNAD_COVID/PNAD_COVID_112020.csv", col_types = cols(.default = "d"))
mes <- "Novembro"
# ligando Pesos e filtrando Salvador
pnad_covid <- pnad_covid %>%
    as_survey_design(
        ids = UPA,
        strata = Estrato,
        weights = V1032,
        nest = TRUE
        )


# Criando colunas com Vari√°veis
pnad_covid <- pnad_covid %>% mutate(one = 1,
                                            Sexo = ifelse(A003 == 1, "Homem", "Mulher"),
                                            Idade = case_when(
                                                A002 %in% 15:24 ~ "15-24",
                                                A002 %in% 25:34 ~ "25-34",
                                                A002 %in% 35:49 ~ "35-49",
                                                A002 %in% 50:64 ~ "50-64",
                                                A002 > 64 ~ "65+"),
                                            Cor = case_when(
                                                A004 == 1 ~ "Branca",
                                                A004 == 2 ~ "Preta",
                                                A004 == 4 ~ "Parda"),
                                            Escolaridade = factor(case_when(
                                                A005 %in% 1:2 ~ "Sem Instru√ß√£o ou Fundamental Incompleto",
                                                A005 %in% 3:4 ~ "Fundamental completo ou M√©dio Incompleto",
                                                A005 %in% 5:6 ~ "M√©dio completo ou Superior Incompleto",
                                                A005 == 7 ~ "Superior completo",
                                                A005 == 8 ~ "P√≥s-gradua√ß√£o"),
                                                levels = c( "Sem Instru√ß√£o ou Fundamental Incompleto",
                                                            "Fundamental completo ou M√©dio Incompleto",
                                                            "M√©dio completo ou Superior Incompleto",
                                                            "Superior completo",
                                                            "P√≥s-gradua√ß√£o")),
                                            Tipo_emprego = factor(case_when(
                                                C007 == 1 ~ "Trabalhador dom√©stico (empregado dom√©stico, cuidados, bab√°)",
                                                C007 == 2 ~ "Militar",
                                                C007 == 3 ~ "Policial ou Bombeiro",
                                                C007 == 4 ~ "Setor privado",
                                                C007 == 5 ~ "Setor p√∫blico",
                                                C007 == 6 ~ "Empregador",
                                                C007 == 7 ~ "Aut√¥nomo (Conta pr√≥pria)"),
                                                levels = c( "Trabalhador dom√©stico (empregado dom√©stico, cuidados, bab√°)",
                                                            "Militar",
                                                            "Policial ou Bombeiro",
                                                            "Setor privado",
                                                            "Setor p√∫blico",
                                                            "Empregador",
                                                            "Aut√¥nomo (Conta pr√≥pria)")),
                                            Faixa_salario = factor(case_when(
                                                C01012 <= 1044 ~ "Menos de um sal√°rio m√≠nimo",
                                                C01012 %in% c(1045:2090) ~ "Entre 1 e 2",
                                                C01012 %in% c(2091:3135) ~ "Entre 2 e 3",
                                                C01012 %in% c(3136:4180) ~ "Entre 3 e 4",
                                                C01012 %in% c(4181:5225) ~ "Entre 4 e 5",
                                                C01012 >= 5226 ~ "Mais de 5"),
                                                levels = c("Menos de um sal√°rio m√≠nimo",
                                                           "Entre 1 e 2",
                                                           "Entre 2 e 3",
                                                           "Entre 3 e 4",
                                                           "Entre 4 e 5",
                                                           "Mais de 5")),
                                            domicilio_situacao = factor(case_when(
                                                F001 == 1 ~ "Pr√≥prio - j√° pago",
                                                F001 == 2 ~ "Pr√≥prio - ainda pagando" ,
                                                F001 == 3 ~ "Alugado",
                                                F001 %in% 4:6 ~ "Cedido (Por empregador, Familiar ou outro)"),
                                                levels = c("Pr√≥prio - j√° pago",
                                                           "Pr√≥prio - ainda pagando",
                                                           "Alugado",
                                                           "Cedido (Por empregador, Familiar ou outro)")),
                                            home_office = ifelse(C013 == 1, "Home Office", "Presencial"),
                                            auxilio_emergencial = ifelse(D0051 == 1, "Aux√≠lio", "Sem aux√≠lio")
)


############### Home office - Por sexo e cor ################### Criando dataset para conferir pessoas em Home Office
df <- pnad_covid %>%
    group_by(Sexo, Cor) %>%
    summarise(
        home_office = survey_total(C013 == 1, na.rm = TRUE),
        mao_de_obra = survey_total(C001 == 1, na.rm = TRUE)) %>%
    mutate(trab_home_office = (home_office/mao_de_obra)*100) %>%
    drop_na()# gr√°fico
fig <- ggplot(df, aes(fill = Cor, y = trab_home_office, x = Sexo)) +
    geom_bar(position = "dodge", stat = "identity") +
    geom_text(aes(label=sprintf("%1.2f%%",trab_home_office)),size = 3, position =position_dodge(width=0.9),
              vjust=-0.5, color = 'black',fontface='bold') +
    theme_classic() +
    theme(axis.title.x = element_text(colour = "black"),
          axis.title.y = element_text(colour = "black"),
          axis.text.y = element_text(face="bold", color="#000000",
                                     size=10),
          axis.line = element_line(colour = "black",
                                   size = 1, linetype = "solid"),
          axis.text=element_text(size=6, face="bold"),
          axis.text.x = element_text(face="bold", color="#000000", size=10),
          plot.title = element_text(colour = "black", size = 17, hjust=0.5),
          legend.position = "bottom", legend.background = element_rect(fill="ghostwhite", size=0.7, linetype="blank")) +
    labs(x = "Sexo", fill = "Cor/Ra√ßa: ", caption = "Fonte: Microdados da Pnad Covid19 - IBGE. Novembro 2020.",
         title = "Pessoas em home office, por cor/ra√ßa e sexo") +
    scale_fill_manual(values = c("#00b894","#ff7675","#0984e3","#6c5ce7")) +
    scale_y_discrete(limits=factor(0:100), breaks = c(0,10,20,30,40,50,60,70,80,90,100), name = "Percentual (%)")

fig<- ggdraw(fig) +
    draw_image(logo_file, x = .975, y = .975, hjust = 1, vjust = 1, width = 0.25, height = 0.2)
# Salvando
ggsave(plot = fig, "./figs/PNAD_COVID/home_sexo_cor.pdf",
       width = 10, height = 5, dpi = 120, units = "in",type = "cairo")

#+end_src

** Pend√™ncias :noexport:
*** TODO Incluir logos
** Home office - Por sexo e cor




[[./figs/PNAD_COVID/home_sexo_cor.pdf]]

** Home office - Por Cor e Escolaridade
[[./figs/PNAD_COVID/home_edu_cor.pdf]]
** Home office - Por Cor e Idade
[[./figs/PNAD_COVID/home_sexo_idade.pdf]]

** Home office - Por Trabalho
[[./figs/PNAD_COVID/home_emprego.pdf]]

** Home office - Por faixa salarial e cor
[[./figs/PNAD_COVID/home_renda.pdf]]
** Auxilio - Faixa Salarial
[[./figs/PNAD_COVID/auxilio_renda.pdf]]
** Auxilio - Por tipo do domicilio
[[./figs/PNAD_COVID/auxilio_domicilio.pdf]]
** Auxilio - Sexo e Cor
[[./figs/PNAD_COVID/auxilio_cor_sexo.pdf]]


* Relat√≥rio do Tesouro :noexport:



* IMF Fiscal Monitor
** Medidas fiscais em % do PIB

#+BEGIN_SRC python :results graphics file :file ./figs/IMF/FiscalMonitor_Covid.pdf
df = pd.read_excel(
    './raw/IMF/fiscal-monitor-database-oct-2020-for-webpage.xlsx',
    sheet_name='Summary.Global',
    index_col=1,
    skiprows=[0,1,2,]
)
df = df.loc[[
    # 'G20: Emerging markets',
    'Argentina',
    'Brazil',
    'China',
    'India',
    'Indonesia',
    'Mexico',
    'Russia',
    'Saudi Arabia',
    'South Africa'
],:].copy()
df = df[[
    'Above the line measures',
    'Unnamed: 3',
    'Unnamed: 4',
    'Above the line measures.1',
    'Unnamed: 15',
    'Unnamed: 16',
]]

df.columns = [
    'Gastos adicionais totais',
    'Setor de sa√∫de totais',
    'Outros setores totais',
    'Gastos adicionais',
    'Setor de sa√∫de',
    'Outros setores',
]
df.index.name = 'G20 - Pa√≠ses Emergentes'
df = df.sort_values(
    'Gastos adicionais',
    ascending=False
)
fig, ax = plt.subplots(figsize=(8, 5))
df[[
    # "Gastos adicionais",
    "Setor de sa√∫de",
    "Outros setores",
]].plot(
    title=f"Resumo das medidas fiscais dos pa√≠ses emergentes\nem resposta √† pandemia COVID-19 em % do PIB",
    ax=ax,
    lw=2.5,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax2 = plt.axes([0.675, 0.55, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/IMF/FiscalMonitor_Covid" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/FiscalMonitor_Covid.pdf]]

** Medidas fiscais em % do PIB: Setor de sa√∫de/Outros setores

#+BEGIN_SRC python :results graphics file :file ./figs/IMF/FiscalMonitor_Covid_ratio.pdf
df = pd.read_excel(
    './raw/IMF/fiscal-monitor-database-oct-2020-for-webpage.xlsx',
    sheet_name='Summary.Global',
    index_col=1,
    skiprows=[0,1,2,]
)
df = df.loc[[
    # 'G20: Emerging markets',
    'Argentina',
    'Brazil',
    'China',
    'India',
    'Indonesia',
    'Mexico',
    'Russia',
    'Saudi Arabia',
    'South Africa'
],:].copy()
df = df[[
    'Above the line measures',
    'Unnamed: 3',
    'Unnamed: 4',
    'Above the line measures.1',
    'Unnamed: 15',
    'Unnamed: 16',
]]

df.columns = [
    'Gastos adicionais totais',
    'Setor de sa√∫de totais',
    'Outros setores totais',
    'Gastos adicionais',
    'Setor de sa√∫de',
    'Outros setores',
]
df.index.name = 'G20 - Pa√≠ses Emergentes'

df["Sa√∫de/Outros setores"] = df["Setor de sa√∫de"]/df["Outros setores"]

df = df.sort_values(
    'Sa√∫de/Outros setores',
    ascending=False
)
fig, ax = plt.subplots(figsize=(8, 5))
df[[
    "Sa√∫de/Outros setores"
]].plot(
    title=f"Raz√£o entre gastos com sa√∫de e outros setores\nem resposta √† pandemia COVID-19",
    ax=ax,
    lw=2.5,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax2 = plt.axes([0.675, 0.55, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/IMF/FiscalMonitor_Covid_ratio" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/FiscalMonitor_Covid_ratio.pdf]]

** Medidas fiscais em % do PIB: Setor de sa√∫de/Total

#+BEGIN_SRC python :results graphics file :file ./figs/IMF/FiscalMonitor_Covid_total.pdf
df = pd.read_excel(
    './raw/IMF/fiscal-monitor-database-oct-2020-for-webpage.xlsx',
    sheet_name='Summary.Global',
    index_col=1,
    skiprows=[0,1,2,]
)
df = df.loc[[
    # 'G20: Emerging markets',
    'Argentina',
    'Brazil',
    'China',
    'India',
    'Indonesia',
    'Mexico',
    'Russia',
    'Saudi Arabia',
    'South Africa'
],:].copy()
df = df[[
    'Above the line measures',
    'Unnamed: 3',
    'Unnamed: 4',
    'Above the line measures.1',
    'Unnamed: 15',
    'Unnamed: 16',
]]

df.columns = [
    'Gastos adicionais totais',
    'Setor de sa√∫de totais',
    'Outros setores totais',
    'Gastos adicionais',
    'Setor de sa√∫de',
    'Outros setores',
]
df.index.name = 'G20 - Pa√≠ses Emergentes'

df["Sa√∫de/Gastos adicionais"] = df["Setor de sa√∫de"]/df["Gastos adicionais"]

df = df.sort_values(
    'Sa√∫de/Gastos adicionais',
    ascending=False
)
fig, ax = plt.subplots(figsize=(8, 5))
df[[
    "Sa√∫de/Gastos adicionais"
]].plot(
    title=f"Raz√£o entre gastos com sa√∫de e total dos gastos adicionais\nem resposta √† pandemia COVID-19",
    ax=ax,
    lw=2.5,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
ax2 = plt.axes([0.675, 0.55, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/IMF/FiscalMonitor_Covid_total" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/FiscalMonitor_Covid_total.pdf]]

* World Economic outlook


** GDP vs Lockdown
#+NAME: IMF_fig_1
#+CAPTION: GDP Forecast Errors in 2020:H1 and Lockdown Stringency
|---------+--------------------+---------------------|
| Country | GDP Forecast Error | Lockdown Stringency |
|---------+--------------------+---------------------|
| AUS     | -4,54              | 37,21               |
| AUT     | -9,11              | 37,13               |
| BEL     | -9,65              | 41,34               |
| BRA     | -8,71              | 44,01               |
| CAN     | -8,81              | 40,92               |
| CHL     | -5,71              | 41,76               |
| CHN     | -7,82              | 62,36               |
| COL     | -10,70             | 49,59               |
| HRV     | -9,36              | 40,25               |
| CZE     | -8,87              | 34,38               |
| DNK     | -6,03              | 39,22               |
| EST     | -6,54              | 31,58               |
| FIN     | -5,24              | 28,49               |
| FRA     | -13,44             | 48,72               |
| DEU     | -7,04              | 35,39               |
| GRC     | -10,79             | 39,91               |
| HKG     | -4,45              | 43,62               |
| HUN     | -8,91              | 38,69               |
| IND     | -15,70             | 51,69               |
| IDN     | -6,09              | 42,06               |
| IRL     | -3,48              | 45,59               |
| ISR     | -6,44              | 49,81               |
| ITA     | -11,99             | 51,65               |
| JPN     | -6,27              | 24,21               |
| KOR     | -3,02              | 39,64               |
| LVA     | -7,49              | 33,94               |
| LTU     | -3,51              | 40,30               |
| MYS     | -12,54             | 40,67               |
| MEX     | -11,10             | 41,61               |
| NLD     | -6,49              | 40,82               |
| NOR     | -6,10              | 32,55               |
| PER     | -20,54             | 55,43               |
| PHL     | -15,14             | 58,33               |
| POL     | -6,56              | 40,53               |
| PRT     | -10,87             | 43,79               |
| ROU     | -7,04              | 44,54               |
| RUS     | -4,29              | 48,61               |
| SRB     | -4,59              | 40,73               |
| SGP     | -7,63              | 43,65               |
| SVK     | -10,39             | 40,44               |
| SVN     | -11,35             | 34,24               |
| ZAF     | -9,66              | 47,21               |
| ESP     | -14,65             | 42,21               |
| SWE     | -4,28              | 21,08               |
| CHE     | -6,16              | 37,10               |
| TWN     | -1,37              | 13,73               |
| THA     | -9,13              | 39,43               |
| TUR     | -5,42              | 42,28               |
| UKR     | -8,08              | 47,94               |
| GBR     | -12,91             | 38,99               |
| USA     | -6,44              | 43,14               |
| VNM     | -4,35              | 47,91               |
|---------+--------------------+---------------------|


#+BEGIN_SRC python :var df=IMF_fig_1() :results graphics file :file ./figs/IMF/GDP_Lockdown.pdf
df = pd.DataFrame(
    df,
)
df.set_index(0, inplace=True)
df = df.rename(columns=df.iloc[0]).drop("Country")
for col in df:
    df[col] = [x.replace(",", ".") for x in df[col]]
df = df.apply(pd.to_numeric, axis=1)


df["Country"] = df.index.to_list()
fig, ax = plt.subplots(figsize=(8, 5))
sns.regplot(data=df, y="GDP Forecast Error", x="Lockdown Stringency", ax=ax)
# ax.legend()
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


def label_point(x, y, val, ax):
    a = pd.concat({"x": x, "y": y, "val": val}, axis=1)
    for i, point in a.iterrows():
        ax.text(point["x"] + 0.02, point["y"], str(point["val"]))


label_point(df["Lockdown Stringency"], df["GDP Forecast Error"], df["Country"], ax)
sns.despine()

fig.savefig(
    "./figs/IMF/" + "GDP_Lockdown" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/GDP_Lockdown.pdf]]



** Lockdown: Voluntary vs Stringency

#+NAME: Vol_String
#+CAPTION: Impact of Lockdowns and Voluntary Social Distancing on Mobility during the First 90 Days of Each Country‚Äôs Epidemic
| Country groups | Lockdown stringency | Voluntary social distancing |
|----------------+---------------------+-----------------------------|
| All            | -7,85               | -6,53                       |
| AEs            | -8,07               | -10,62                      |
| EMs            | -8,78               | -6,26                       |
| LICs           | -5,8                | -2,83                       |
|----------------+---------------------+-----------------------------|

#+BEGIN_SRC python :var df=Vol_String :results graphics file :file ./figs/IMF/Vol_String.pdf
df = pd.DataFrame(
    df,
)
# df = df.transpose()
df.set_index(0, inplace=True)
df.index.name = "Country Groups"
df = df.rename(columns=df.iloc[0]).drop("Country groups")
for col in df:
    df[col] = [x.replace(",", ".") for x in df[col]]
df = df.apply(pd.to_numeric, axis=1)


fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    kind="bar",
    stacked=True,
    ax=ax,
    # cmap="Set1",
    width=0.75,
    edgecolor="black",
)
ax.set_ylim(-25, 15)
ax.axhline(y=0, ls="-", color="black")
ax.legend()
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()

fig.savefig(
    "./figs/IMF/" + "Vol_String" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/Vol_String.pdf]]

** Sequencing of lockdown measures
#+NAME: Lock_measure
#+CAPTION: Sequencing of lockdown measures
|--------------------------------+--------+-----+------|
| Lockdown measures              | Middle | Low | High |
|--------------------------------+--------+-----+------|
| Stay-at-home orders            |     18 |  10 |   27 |
| Public transport closures      |     16 | 7,5 |   25 |
| Internal movement restrictions |     16 |   7 |   27 |
| Workplace closures             |     13 |   6 |   22 |
| Gathering restrictions         |     10 |   2 |   20 |
| Public event cancellations     |      6 |   1 | 14,5 |
| School closures                |    4,5 |   1 | 13,5 |
| International travel controls  |      1 |   0 |    9 |
|--------------------------------+--------+-----+------|

#+BEGIN_SRC python :var df=Lock_measure() :results graphics file :file ./figs/IMF/Lock_measures.pdf
df = pd.DataFrame(
    df,
)
# df = df.transpose()
df.set_index(0, inplace=True)
df.index.name = "Lockdown measures"
df = df.rename(columns=df.iloc[0]).drop("Lockdown measures")
for col in df:
    df[col] = [str(x).replace(",", ".") for x in df[col]]
df = df.apply(pd.to_numeric, axis=1)
df = df.sort_values(by="Middle", ascending=True)
df.reset_index(inplace=True)
fig, ax = plt.subplots(figsize=(8, 5))
ax = sns.barplot(
    y="Lockdown measures",
    x="Middle",
    color="teal",
    # cmap="Set1",
    data=df,
    xerr=df["Low"],
    errcolor="black",
)

# df.plot(
#     kind = 'scatter',
#     y = "Lockdown measures",
#     x = "Low",
#     ax=ax,
#     color = 'black',
#     zorder=2
#     )

# df.plot(
#     kind = 'scatter',
#     y = "Lockdown measures",
#     x = "High",
#     ax=ax,
#     color = 'black',
#     zorder=2
#     )
ax.set_xlabel("Days")
ax2 = plt.axes([0.635, 0.635, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()

fig.savefig(
    "./figs/IMF/" + "Lock_measures" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/Lock_measures.pdf]]

* OECD Weekly tracker
** Informa√ß√µes adicionais

Conforme sugere o Anexo A (p. 40) de textcite:woloszko_2020_Tracking, a semana considerada se inicia aos domingos.
Compara-se com a mesma semana do ano anterior cujos dias da semana s√£o os mais pr√≥ximos da data de refer√™ncia do ano corrente.
Exemplo dado pelo autor (p. 43):

#+begin_quote
The log difference for, say, 03-01-2020, is obtained by taking the difference between the $svi_{03-01-2020}$ and the log of a weighted average of the closest known values before and after 03-01-2019, that is 31-12-2018 and 07-01-2019.
#+end_quote


** Download :noexport:
#+begin_src shell :dir /HDD/Cecon_Atividade/Nota_016/raw/OECD/ :exports none :eval yes
wget -q https://github.com/NicolasWoloszko/OECD-Weekly-Tracker/raw/main/Data/weekly_tracker.xlsx
#+end_src


** Tracker e contrafactual
#+begin_src python :results graphics file :file ./figs/Granulares/OCDE_Semanal.pdf
df = pd.read_excel("./raw/OECD/weekly_tracker.xlsx", parse_dates=True, index_col="date")
df = df[df["ISO3"] == "BRA"][["Tracker (yoy)", "Tracker (counterfactual)"]][
    "2019-01-01":
]
df.index.name = ""
df.columns = ["Tracker", "Contrafactual"]
fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Indicador Semanal - OCDE",
    ax=ax,
    lw=2.5,
    color=("darkred", "blue"),
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.axhline(y=0, ls="-", lw=1.0, color="gray")
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
fig.savefig(
    "./figs/Granulares/OCDE_Semanal" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
plt.close()
#+end_src
#+RESULTS:
[[file:./figs/Granulares/OCDE_Semanal.pdf]]

** Tracker e contrafactual (subplots)
#+begin_src python :results graphics file :file ./figs/Granulares/OCDE_Subplots.pdf
df = pd.read_excel("./raw/OECD/weekly_tracker.xlsx", parse_dates=True, index_col="date")
df = df[df["ISO3"] == "BRA"][["Tracker (yoy)", "Tracker (counterfactual)"]][
    "2019-01-01":
]
df.index.name = ""
df.columns = ["Tracker", "Contrafactual"]
fig, ax = plt.subplots(2, 1, figsize=(10, 12))
df.plot(
    title=f"Indicador Semanal - OCDE",
    ax=ax,
    lw=2.5,
    color=("darkred", "blue"),
    subplots=True,
)
ax[0].axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP"
)
ax[0].axhline(y=0, ls="-", lw=1.0, color="gray")
ax[0].legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax[1].axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP"
)
ax[1].axhline(y=0, ls="-", lw=1.0, color="gray")
ax[1].legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax2 = plt.axes([0.695, 0.135, 0.1, 0.1])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
fig.savefig(
    "./figs/Granulares/OCDE_Subplots" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
plt.close()
#+end_src
#+RESULTS:
[[file:./figs/Granulares/OCDE_Subplots.pdf]]

** Contrafactual
#+begin_src python :results graphics file :file ./figs/Granulares/OCDE_Contrafactual.pdf
df = pd.read_excel("./raw/OECD/weekly_tracker.xlsx", parse_dates=True, index_col="date")
df = df[df["ISO3"] == "BRA"][["Tracker (yoy)", "Tracker (counterfactual)"]][
    "2019-01-01":
]
df.index.name = ""
df.columns = ["Tracker", "Contrafactual"]
fig, ax = plt.subplots(figsize=(8, 5))
df["Contrafactual"].dropna().plot(
    title=f"Indicador Semanal - OCDE (Contrafactual)",
    ax=ax,
    lw=2.5,
    color=("darkred"),
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="In√≠cio isolamento em SP")
ax.axhline(y=0, ls="-", lw=1.0, color="gray")
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax2 = plt.axes([0.695, 0.235, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
fig.savefig(
    "./figs/Granulares/OCDE_Contrafactual" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0.2,
)
plt.close()
#+end_src
#+RESULTS:
[[file:./figs/Granulares/OCDE_Contrafactual.pdf]]

* Aux√≠lio emergencial

#+begin_export latex
\npdecimalsign{,}
\npthousandsep{.}
\nprounddigits{0}
\begin{figure}[h]
    \resizebox{\textwidth}{!}{%
    \input{./tabs/AE.tex}} 
\end{figure}
#+end_export

* Novos casos x Restri√ß√£o de mobilidade por tipo de isolamento :noexport:
** TODOs :noexport:
*** TODO Remover outlier dos boxplots
** Loading data :ignore:noexport:

*** Our world data

#+BEGIN_SRC python
df = pd.read_csv(
    "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv",
    index_col="date",
    parse_dates=True,
    usecols=[  # subseting
        "date",
        "iso_code",
        "continent",
        "total_cases",
        "total_deaths",
        "total_cases_per_million",
        "total_deaths_per_million",
        "new_cases_smoothed",
        "new_deaths_smoothed",
        "new_deaths_per_million",
        "new_cases_per_million",
        "new_cases_smoothed_per_million",
        "new_deaths_smoothed_per_million",
        "new_tests_smoothed_per_thousand",
        "people_fully_vaccinated",
        "new_vaccinations_smoothed_per_million",
        "stringency_index",
        "new_vaccinations_smoothed_per_million",
    ],
)
df[["stringency_index"]] = df[["stringency_index"]].shift(14)
df = df.groupby("iso_code").rolling(window=14).mean().reset_index().set_index("date")
df.to_csv("./clean/COVID/cases_deaths.csv")
#+END_SRC

#+RESULTS:
:results:
:end:

*** Stringency 


#+BEGIN_SRC python
df = pd.read_csv(
    "https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv",
    index_col="Date",
    parse_dates=True,
    usecols=[  # subseting
        "Date",
        "CountryCode",
        "C1_School closing",
        "C1_Flag",
        "C2_Workplace closing",
        "C2_Flag",
        "C3_Cancel public events",
        "C3_Flag",
        "C4_Restrictions on gatherings",
        "C4_Flag",
        "C5_Close public transport",
        "C5_Flag",
        "C6_Stay at home requirements",
        "C6_Flag",
        "C7_Restrictions on internal movement",
        "C7_Flag",
        "C8_International travel controls",
    ],
)

closure = [
    "C1_School closing",
    "C2_Workplace closing",
    "C3_Cancel public events",
    "C4_Restrictions on gatherings",
    "C5_Close public transport",
    "C6_Stay at home requirements",
    "C7_Restrictions on internal movement",
    "C8_International travel controls",
]

flags = [
    "C1_Flag",
    "C2_Flag",
    "C3_Flag",
    "C4_Flag",
    "C5_Flag",
    "C6_Flag",
    "C7_Flag",
]

df["Closure"] = (
    df.reset_index().set_index("CountryCode")[closure].mean(axis="columns").values
)
# df = df[df["Closure"].diff() != 0]
df["Restrict"] = [i > 0 for i in df["Closure"].diff() > 0]
df["Stay_at_home"] = [i == 3 for i in df["C6_Stay at home requirements"]]
df["Stay_at_home_federal"] = df["Stay_at_home"] * df["C6_Flag"]
df["Stay_at_home_federal"] = [i == 1 for i in df["Stay_at_home_federal"]]
df = df[
    ["CountryCode", "Closure", "Restrict", "Stay_at_home", "Stay_at_home_federal"]
    + closure
    + flags
]

short_closure = ["C" + str(i) for i in range(1, len(closure) + 1)]

df.columns = (
    [
        "iso_code",
        "Closure",
        "Restrict",
        "Stay_at_home",
        "Stay_at_home_federal",
    ]
    + short_closure
    + flags
)
df.index.name = "date"  # for merging purposes
df.to_csv("./clean/COVID/closes.csv")
#+END_SRC

#+RESULTS:
:results:
:end:

*** Google mobility

#+BEGIN_SRC python
url = "https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv"

cols = [
    "country_region",
    "sub_region_1",
    "sub_region_2",
    "metro_area",
    "iso_3166_2_code",
    "census_fips_code",
    "date",
    "retail_and_recreation_percent_change_from_baseline",
    "grocery_and_pharmacy_percent_change_from_baseline",
    "parks_percent_change_from_baseline",
    "transit_stations_percent_change_from_baseline",
    "workplaces_percent_change_from_baseline",
    "residential_percent_change_from_baseline",
]

df = pd.read_csv(
    url,
    usecols=cols,
    parse_dates=True,
    dtype={
        "country_region": str,
        "sub_region_1": str,
        "sub_region_2": str,
        "metro_area": str,
        "iso_3166_2_code": str,
        "census_fips_code": str,
        "date": str,
        "retail_and_recreation_percent_change_from_baseline": np.float64,
        "grocery_and_pharmacy_percent_change_from_baseline": np.float64,
        "parks_percent_change_from_baseline": np.float64,
        "transit_stations_percent_change_from_baseline": np.float64,
        "workplaces_percent_change_from_baseline": np.float64,
        "residential_percent_change_from_baseline": np.float64,
    },
)
# Convert date column to days of the year
# df['date'] = pd.to_datetime(df['date'], format="%Y/%m/%d", utc=True)


# Remove subnational data, keeping only country figures
filter_cols = [
    "sub_region_1",
    "sub_region_2",
    "metro_area",
    "iso_3166_2_code",
    "census_fips_code",
]
df = df[df[filter_cols].isna().all(1)]

# Delete columns
df = df.drop(
    [
        # "country_region",
        "sub_region_1",
        "sub_region_2",
        "metro_area",
        "census_fips_code",
        "iso_3166_2_code",
    ],
    axis="columns",
)


# Standardise country names to OWID country names
df = df.reset_index().set_index("country_region")
df.index = cc.convert(
    names=list(df.index), to="ISO3", not_found=None
)  # To avoid string problems
df = df.reset_index().set_index("date").drop("index", axis="columns")
# Converting the index as date
df.index = pd.to_datetime(df.index)
# Assign new column names
rename_dict = {
    "date": "Date",
    "level_0": "iso_code",
    "retail_and_recreation_percent_change_from_baseline": "Retail & Recreation",
    "grocery_and_pharmacy_percent_change_from_baseline": "Grocery & Pharmacy",
    "parks_percent_change_from_baseline": "Parks",
    "transit_stations_percent_change_from_baseline": "Transit Stations",
    "workplaces_percent_change_from_baseline": "Workplaces",
    "residential_percent_change_from_baseline": "Residential",
}

# Rename columns
df = df.rename(columns=rename_dict)
df["Isolamento"] = df["Residential"].pct_change()
df.to_csv("./clean/COVID/google_mobility.csv")
#+END_SRC

#+RESULTS:
:results:
:end:

** Merging :noexport:


#+begin_src R
df <-read_csv(
  './clean/COVID/cases_deaths.csv',
  guess_max = 3000
)  %>% arrange(iso_code)

# check if full_join or right or left join
tmp <- read_csv(
  './clean/COVID/google_mobility.csv'
)  %>% arrange(iso_code)
df <- df %>% left_join(tmp)

tmp <- read_csv(
  './clean/COVID/closes.csv'
)  %>% arrange(iso_code)
df <- df %>% left_join(tmp)

df <- df %>%
  group_by(iso_code) %>%
  mutate(Policy_change = c(NA, diff(Closure))) %>%
  ungroup() %>%
  mutate(Restrict = Policy_change > 0) %>%
  mutate(stayhome_growth = (Residential/lag(Residential) - 1) * 100) %>%
  mutate(stayhome_growth_7 = (Residential/lag(Residential,7) - 1) * 100) %>%
  mutate(stayhome_growth_14 = (Residential/lag(Residential,14) - 1) * 100) %>%
  mutate(Isolamento_14 = case_when(
     stayhome_growth_14 >= 0 & Stay_at_home == TRUE ~ "R√≠gido", # Queda da mobilidade junto da imposi√ß√£o
     stayhome_growth_14 > 0 & Policy_change > 0  & Stay_at_home == FALSE ~ "Brando",
     stayhome_growth_14 > 0 & Policy_change <=0 & Stay_at_home == FALSE ~ "Volunt√°rio", # Queda da mobilidade sem restri√ß√£o
     stayhome_growth_14 < 0 ~ "Queda",
           )) %>%
  mutate(Isolamento_Federal = case_when(
     stayhome_growth_14 >= 0 & Stay_at_home_federal == TRUE ~ "R√≠gido", # Queda da mobilidade junto da imposi√ß√£o
     stayhome_growth_14 > 0 & Policy_change > 0  & Stay_at_home_federal == FALSE ~ "Brando",
     stayhome_growth_14 > 0 & Policy_change <=0 & Stay_at_home_federal == FALSE ~ "Volunt√°rio", # Queda da mobilidade sem restri√ß√£o
     stayhome_growth_14 < 0 ~ "Queda",
           )) %>%
  mutate(Isolamento_14 = as.factor(Isolamento_14)) %>%
  mutate(cases_growth = (new_cases_per_million/lag(new_cases_per_million) - 1) * 100) %>%
  mutate(deaths_growth = (new_deaths_per_million/lag(new_deaths_per_million) - 1) * 100) %>%
  mutate(vaccine_growth = (people_fully_vaccinated/lag(people_fully_vaccinated) - 1) * 100) %>%
  distinct(date, iso_code, .keep_all = TRUE)

write.csv(
  df,
  './clean/COVID/cases_closes_google_merged.csv',
  row.names = FALSE
)
#+end_src

#+RESULTS:
:results:

[36m‚îÄ‚îÄ[39m [1m[1mColumn specification[1m[22m [36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m
cols(
  date = [34mcol_date(format = "")[39m,
  iso_code = [31mcol_character()[39m,
  total_cases = [32mcol_double()[39m,
  new_cases_smoothed = [32mcol_double()[39m,
  total_deaths = [32mcol_double()[39m,
  new_deaths_smoothed = [32mcol_double()[39m,
  total_cases_per_million = [32mcol_double()[39m,
  new_cases_per_million = [32mcol_double()[39m,
  new_cases_smoothed_per_million = [32mcol_double()[39m,
  total_deaths_per_million = [32mcol_double()[39m,
  new_deaths_per_million = [32mcol_double()[39m,
  new_deaths_smoothed_per_million = [32mcol_double()[39m,
  new_tests_smoothed_per_thousand = [32mcol_double()[39m,
  people_fully_vaccinated = [32mcol_double()[39m,
  new_vaccinations_smoothed_per_million = [32mcol_double()[39m,
  stringency_index = [32mcol_double()[39m
)

[36m‚îÄ‚îÄ[39m [1m[1mColumn specification[1m[22m [36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m
cols(
  date = [34mcol_date(format = "")[39m,
  iso_code = [31mcol_character()[39m,
  `Retail & Recreation` = [32mcol_double()[39m,
  `Grocery & Pharmacy` = [32mcol_double()[39m,
  Parks = [32mcol_double()[39m,
  `Transit Stations` = [32mcol_double()[39m,
  Workplaces = [32mcol_double()[39m,
  Residential = [32mcol_double()[39m,
  Isolamento = [32mcol_double()[39m
)
Joining, by = c("date", "iso_code")

[36m‚îÄ‚îÄ[39m [1m[1mColumn specification[1m[22m [36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m
cols(
  .default = col_double(),
  date = [34mcol_date(format = "")[39m,
  iso_code = [31mcol_character()[39m,
  Restrict = [33mcol_logical()[39m,
  Stay_at_home = [33mcol_logical()[39m,
  Stay_at_home_federal = [33mcol_logical()[39m
)
[36m‚Ñπ[39m Use [30m[47m[30m[47m`spec()`[47m[30m[49m[39m for the full column specifications.
Joining, by = c("date", "iso_code")
:end:

** Adaptando dataframe :noexport:

#+begin_src R
df <- read_csv(
  "./clean/COVID/cases_closes_google_merged.csv",
  guess_max = 3000
) %>%
  mutate(Isolamento_14 = factor(Isolamento_14, levels = c("R√≠gido", "Brando", "Volunt√°rio", "Queda", NA))) %>%
  select(
    date,
    iso_code,
    new_cases_per_million,
    new_cases_smoothed_per_million,
    new_deaths_smoothed_per_million,
    cases_growth,
    deaths_growth,
    vaccine_growth,
    Policy_change,
    Restrict,
    Isolamento_14,
    Residential,
    Closure,
    stayhome_growth,
    stayhome_growth_7,
    stayhome_growth_14,
    vaccine_growth,
    total_deaths,
    Stay_at_home,
    Stay_at_home_federal,
    C1, C2, C6,
    C1_Flag, C2_Flag, C6_Flag,
    total_deaths_per_million,
    total_cases_per_million
  ) %>%
  mutate(cases_growth_after14 = lead(cases_growth, 14)) %>%
  filter(
    ## date > as.Date("2020-02-01"), # same start date for all
    cases_growth < 10, # Removing outliers
    cases_growth > -10,
    ## cases_growth_after14 > -10,
    ## cases_growth_after14<10,
    ## stayhome_growth_7<100,
    total_deaths >= 5
  ) %>%
  ## drop_na(Isolamento, Isolamento_7, Isolamento_14, cases_growth, Policy_change) %>%
  filter(iso_code %in% c(
    "ARG",
    ## "AUS",
    ## "BEL",
    "BOL",
    "BRA",
    ## "CAN",
    ## "CHE",
    "CHL",
    "COL",
    ## "DEU",
    ## "DNK",
    "ECU",
    ## "ESP",
    ## "FIN",
    ## "FRA",
    "GBR",
    ## "IND",
    ## "IRL",
    "ISR",
    ## "ITA",
    ## "JPN",
    ## "KOR",
    ## "MEX",
    ## "NDL",
    ## "NOR",
    ## "NZL",
    "PRT",
    "PRY",
    ## "RUS",
    "SWE",
    "URY",
    "USA",
    "VEN"
    ## "ZAF"
  )) %>%
  mutate(iso_code = as.factor(iso_code)) %>%
  mutate(Policy = case_when(
    Policy_change > 0 ~ "Restri√ß√£o",
    Policy_change < 0 ~ "Flexibiliza√ß√£o",
    Policy_change == 0 ~ "Sem mudan√ßas"
  )) %>%
  mutate(Policy = as.factor(Policy)) %>%
  mutate(cases_rolling_14 = zoo::rollapply(cases_growth, width = 14, FUN = mean, fill = NA)) %>%
  mutate(cum_negative_day = zoo::rollapply(cases_rolling_14 < 0, width = 14, FUN = sum, fill = NA))

ylab <- "Taxa de crescimento de casos"
w <- 14 * 2
th_new_cases <- 100
th_total_deaths <- 100

df <- df %>%
  mutate(y.max = zoo::rollapply(new_cases_smoothed_per_million, 2 * w + 1, max, fill = NA, align = "center")) %>%
  mutate(delta = y.max - new_cases_smoothed_per_million) %>%
  mutate(Pico = new_cases_smoothed_per_million >= th_new_cases & delta <= 0) %>%
  group_by(iso_code) %>%
  fill(Pico, .direction = "up") %>%
  mutate(nPico = cumsum(Pico)) %>%
  ungroup() %>%
  mutate(Onda = case_when(
    total_deaths >= th_total_deaths & nPico == 0 ~ "In√≠cio ao 1o pico",
    total_deaths >= th_total_deaths & nPico == 1 ~ "1o ao 2o Pico",
    total_deaths >= th_total_deaths & nPico >= 2 ~ "p√≥s 2o pico"
  )) %>%
  mutate(Onda = factor(Onda)) %>%
  fill(Onda) %>%
  fill(Onda, .direction = "up") %>%
  mutate(Onda = fct_relevel(Onda, "In√≠cio ao 1o pico", "1o ao 2o Pico", "p√≥s 2o pico")) %>%
  group_by(iso_code) %>%
  mutate(Strigency_type = case_when(
    Closure <= quantile(Closure, 0.25, na.rm = TRUE) ~ "Low",
    Closure >= quantile(Closure, 0.75, na.rm = TRUE) ~ "High",
    Closure < quantile(Closure, 0.75, na.rm = TRUE)  & Closure > quantile(Closure, 0.25, na.rm = TRUE) ~ "Medium",
  )) %>%
  ## mutate(Strigency_type = as.factor(Strigency_type)) %>%
  ungroup()

write.csv(
  df,
  "./clean/COVID/casos_TipoIsolamento_Onda.csv",
  row.names = FALSE
)

## for(iso in df$iso_code %>% unique() %>% as.character()){
##   df %>%
##     filter(iso_code == iso) %>%
##     data.frame() %>%
##     write.xlsx(
##       './clean/COVID/boxplots/data.xlsx',
##       sheetName = iso,
##       row.names = FALSE,
##       append = TRUE
##     )
## }

## df %>%
##   group_by(iso_code) %>%
##   do(write.csv(
##     . %>% data.frame(),
##     paste0('./clean/COVID/boxplots/', unique(.$iso_code), ".csv"),
##     row.names=FALSE
##   ))
#+end_src

#+RESULTS:
:results:

[36m‚îÄ‚îÄ[39m [1m[1mColumn specification[1m[22m [36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m
cols(
  .default = col_double(),
  date = [34mcol_date(format = "")[39m,
  iso_code = [31mcol_character()[39m,
  Restrict = [33mcol_logical()[39m,
  Stay_at_home = [33mcol_logical()[39m,
  Stay_at_home_federal = [33mcol_logical()[39m,
  Isolamento_14 = [31mcol_character()[39m,
  Isolamento_Federal = [31mcol_character()[39m
)
[36m‚Ñπ[39m Use [30m[47m[30m[47m`spec()`[47m[30m[49m[39m for the full column specifications.
:end:



** Inspe√ß√£o dos picos

#+begin_src R :results value file :var figname="Picos"

name = paste0('./figs/COVID/', figname, ".pdf")


df <- read_csv(
  "./clean/COVID/casos_TipoIsolamento_Onda.csv",
  guess_max = 3000
)
    
# https://stackoverflow.com/questions/10942360/how-to-get-geom-vline-to-honor-facet-wrap
df_inf <- df %>% 
  group_by(iso_code) %>% 
  summarise(vline = date[Pico==1])

df %>% ggplot(aes(x=date)) +
  ## geom_line(aes(y=new_cases_smoothed_per_million), color="black", linetype="dashed") + 
  geom_line(aes(y=new_cases_per_million), color="red") +
  geom_vline(
    data = df_inf, 
    mapping = aes(xintercept = vline)
  ) +
  labs(
    y = "Novos casos por mil√£o de habitantes",
    x = ""
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 guides(fill=guide_legend(title="Pa√≠ses")) +
      theme(
        axis.text.y.left = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y.left = element_text(size = 14),
        strip.text = element_text( size = 12, face = "bold" )
      ) +
  facet_wrap(~iso_code) ->fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.95, y = 0.15, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 30, height = 20, units = "cm")
print(name)
#+end_src


** Descri√ß√£o dos dados
#+ATTR_LATEX: :environment longtable :align c|p{2cm}|p{5cm}|p{5cm}|p{3cm}
|---------+------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Eixo    | Nome                               | Descri√ß√£o                                                                                                                                                                                                                                                                                                              | Ajuste                                                                                                                | Motivo                                                                                                                                                                                                 |
|---------+------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Y       | Taxa de crescimento de novos casos | Taxa de crescimento dos novos casos de COVID-19 por milh√£o de habitantes                                                                                                                                                                                                                                               | Foram removidos casos em que a taxa de crescimento foi acima de 10% e menor de -10% em rela√ß√£o ao dia anterior        | Remover potenciais outliers                                                                                                                                                                            |
|---------+------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| X       | Fase da pandemia                   | Descreve se a pandemia ocorreu antes do primeiro pico ap√≥s as 5 primeiras mortes; desde o primeiro pico ate o pico da segunda onda e; p√≥s-segunda onda para captar pa√≠ses em que a pandemia n√£o esta controlada.                                                                                                       | Se o total de mortes for menor que 100, n√£o ser√° categorizado como pico da respectiva onda.                           | N√£o classificar m√°ximos locais em uma janela pequena (menos de 14 dias) como um pico e, por consequ√™ncia, incluir mais picos do que os existentes.                                                     |
|---------+------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Cores   | Tipo de isolamento                 | Se o tempo que as pessoas ficaram em casa (em rela√ß√£o √† 14 dias atr√°s) aumentar e n√£o houver medida de restri√ß√£o no dia, volunt√°rio. Se o tempo que as pessoas ficaram em casa (em rela√ß√£o √† 14 dias atr√°s) aumentar e houver medida de restri√ß√£o, imposto. Se o tempo que as pessoas ficaram em casa diminuiu, queda. | Foram removidos casos em que a taxa de varia√ß√£o do tempo que as pessoas ficaram em casa for maior que 100% em m√≥dulo. | Para remover poss√≠vies outlier. Foi considerada a compara√ß√£o com 14 dias atr√°s para evitar efeitos do fim de semana e contemplar situa√ß√µes em que as medidas de restri√ß√µes n√£o foram de curta dura√ß√£o. |
|---------+------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Largura | -                                  | Os boxplots ser√£o t√£o mais largos quanto mais observa√ß√µes existirem para a fase da pandemia. Assim, um boxplot mais largo no p√≥s-segundo pico indica que exitem mais observa√ße√µs se comparados com o restante da pandemia.                                                                                             | -                                                                                                                     | -                                                                                                                                                                                                      |
|---------+------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Altura  | -                                  | Os boxplots ser√£o t√£o mais altos quanto maior a dispers√£o nas taxas de crescimento                                                                                                                                                                                                                                     | -                                                                                                                     | -                                                                                                                                                                                                      |
|---------+------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

** Novos casos por milh√£o x Fase pandemia (sem aparar dados)
#+begin_src R :results value file :var figname="Casos_Policy_Todos" :eval no

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  ## filter(
  ##   ## Policy_change != 0,
  ##   new_cases_per_million > 10
  ## ) %>%
  ## drop_na(Policy_change, Onda, cases_growth, Isolamento_14) %>%
  ggplot(aes(y=Onda, x= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") +
  geom_boxplot(outlier.shape = NA, outlier.color=NA, outlier.alpha=1) +
  labs(
    y = "Fase da Pandemia",
    x = ylab
  ) +
  ## scale_fill_manual(values=c("#FF0000", "#00FF00","#0000FF")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_Todos.pdf]]
:end:


** Novos casos por milh√£o x Fase pandemia (mais de 10 casos por milh√£o de habitante)

#+begin_src R :results value file :var figname="Casos_Policy_10_Todos" :eval no

name = paste0('./figs/COVID/', figname, ".pdf")
    
df %>%
  filter(
    ## Policy_change != 0,
    new_cases_per_million > 10
  ) %>%
  drop_na(Policy_change, Onda, cases_growth, Isolamento_14) %>%
  ggplot(aes(y=Onda, x= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") + 

  geom_boxplot(outlier.shape = NA) +
  labs(
    y = "Fase da Pandemia",
    x = ylab
  ) +
  ## scale_fill_manual(values=c("#FF0000", "#00FF00","#0000FF")) + 
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_10_Todos.pdf]]
:end:

:results:
[[file:./figs/COVID/Casos_Policy_10_Todos.pdf]]
** Novos casos por milh√£o x Fase pandemia (mais de 50 casos por milh√£o de habitante)

#+begin_src R :results value file :var figname="Casos_Policy_50_Todos" :eval no

name = paste0('./figs/COVID/', figname, ".pdf")
    
df %>%
  filter(
    ## Policy_change != 0,
    new_cases_per_million > 50
  ) %>%
  drop_na(Policy_change, Onda, cases_growth, Isolamento_14) %>%
  ggplot(aes(y=Onda, x= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") + 

  geom_boxplot(outlier.shape = NA) +
  labs(
    y = "Fase da Pandemia",
    x = ylab
  ) +
  ## scale_fill_manual(values=c("#FF0000", "#00FF00","#0000FF")) + 
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_50_Todos.pdf]]
:end:

** Novos casos por milh√£o x Fase pandemia (mais de 100 casos por milh√£o de habitante)

#+begin_src R :results value file :var figname="Casos_Policy_100_Todos" :eval no

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    ## Policy_change != 0,
    new_cases_per_million > 100
  ) %>%
  drop_na(Policy_change, Onda, cases_growth, Isolamento_14) %>%
  ggplot(aes(y=Onda, x= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") +

  geom_boxplot(outlier.shape = NA) +
  labs(
    y = "Fase da Pandemia",
    x = ylab
  ) +
  ## scale_fill_manual(values=c("#FF0000", "#00FF00","#0000FF")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_100_Todos.pdf]]
:end:


** Texto explicativo

Neste ponto, cabe discutir a relav√¢ncia do isolamento social volunt√°rio e sua rela√ß√£o com o est√°gio da pandemia.
Para isso, associa-se o tipo de isolamento social (se volunt√°rio, imposto ou em queda) com as diferentes fases da pandemia e com as taxas de crescimento de novos casos por meio de /boxplots/ como indicado pela figura abaixo.
O eixo das coordenadas indica a taxa de crescimento de novos casos por milh√£o de habitantes e possui uma linha horizontal em zero para facilitar a visualiza√ß√£o.
O eixo das abscissas apresenta a respectiva fase da pandemia em casa pa√≠s.
Denomina-se de "in√≠cio ao primeiro pico" como per√≠odo em que o n√∫mero acumulado de mortes √© superior √† src_R[:exports results :results value]{print(th_total_deaths)} {{{results(100)}}} e que a taxa de crescimento de novos casos foi a maior em uma janela de src_R[:export results :results value]{print(w)} {{{results(28)}}} dias[fn::Mais precisamente, src_R[:export results :results value]{print(w/2)} {{{results(14)}}} dias depois e antes do dia em quest√£o.].
A mesma janela foi aplicada para categorizar o per√≠odo entre o primeiro e segundo pico.
Ap√≥s o segundo pico de cont√°gio, denominou-se no gr√°fico de "p√≥s segundo pico".

Em seguida, para determinar o tipo de isolamenta social, comparou-se o tempo que as pessoas ficaram em casa em rela√ß√£o a src_R[:export results :results value]{print(w/2)} {{{results(14)}}} dias atr√°s a partir dos dados de mobilidade do Google (Citar).
Caso o tempo de perman√™ncia nas resid√™ncias tenha aumentado, mas n√£o tenha ocorrido nenhuma pol√≠tica de restri√ß√£o neste dia; denota-se esse tipo de isolamento de "volunt√°rio".
Por outro lado, se o tempo de perman√™ncia tenha aumentado, mas houve uma medida de restri√ß√£o neste dia, denominou-se de "imposto".
Caso tenha ocorrido uma redu√ß√£o da perman√™ncia nas casas, logo diminui√ß√£o do isolamento social, foi categorizado como "queda".

Os dados de pol√≠tica de restri√ß√£o s√£o extra√≠dos da base de monitoramento da ado√ß√£o de pol√≠ticas de combate √† COVID-19 da universidade de Oxford cite:OxCGRT.
Neste caso, foram utilizadas as medidas do grupo "C" que al√©m da imposi√ß√£o para que as pessoas n√£o saiam de casa (C6) englobam o fechamento/proibi√ß√£o de: escolas (C1); locais de trabalho (C2); eventos p√∫blicos (C3); Aglomera√ß√µes (C4); Transporte p√∫blico (C5); Deslocamento entre cidades e regi√µes (C7) e; viagens internacionais (C8).
Em seguida, adotamos a classifica√ß√£o do FMI em que o tipo de isolamento √© considerado como "r√≠gido" se as medidas de restri√ß√£o s√£o as 25% maiores de acordo com o indicador mencionado anteriormente.
Se as medias s√£o as medidas de isolamento est√£o entre as 25% menores de acordo com o mesmo indicador, classificou-se como "brando".
Para abranger o maior n√∫mero de dados poss√≠veis, nomeou-se de "m√©dio" os tipos de isolamento em que est√£o entre o primeiro e terceiro quartil.

Com estes dados a m√£o, relacionou-se tais informa√ß√µes por meio de /boxplots/.
A partir deste gr√°fico √© poss√≠vel avaliar em que medida a aus√™ncia de pol√≠ticas de isolamento social s√£o acompanhadas por um aumento no isolamento dada o descontrole da pandemia.
O caso brasileiro se destaca, dentre outras raz√µes, por ser um dos que n√£o foram adotadas medidas de isolamento mais r√≠gidas uma vez passado o primeiro pico da pandemia.
Al√©m de insuficientes e precocemente abandonadas, as medidas de isolamento social se tornaram mais brandas ao mesmo tempo que o contagio do novo corana v√≠rus continuo crescente.
Por um lado, nota-se que as medidas adotadas na dire√ß√£o a coibir o isolamento social foram bastante efetivas no sentido de estimular as pessoas a sa√≠rem √†s mesmo quando a taxa de crescimento de novos casos √© consideramente positiva.
Por outro, esse movimento foi contrabalanceado pelo aumento do isolamento volunt√°rio em propor√ß√£o igual (quando n√£o maior) √† redu√ß√£o do isolamento.

Por fim, cabe pontuar que a ado√ß√£o relativamente precoce de medidas de isolamento r√≠gidas pode sugerir o sucesso na condi√ß√£o do controle na pandemia.
No entanto, quando observamos os dados para al√©m do primeiro pico de n√∫mero de novos casos √© poss√≠vel notar que essa postura de restri√ß√£o branda n√£o √© exitosa no combate da pandemia e n√£o tem os efeitos econ√¥micos positivos t√£o almejados pelo governo dado o aumento do isolamento social volunt√°rio.
Este resultado nada tem de espantoso ou contraintuitivo quando analisamos a literatura acad√™mica.
Neste ponto, o WEO √© enf√°tico ao destacar que medidas mais restritivas t√™m efeitos menores na margem sobre o isolamento social, mas seus efeitos sobre o cont√°gio √© consideravelmente superior.
Dessa forma, pol√≠ticas de restri√ß√£o mais r√≠gidas s√£o mais exitosas tanto sobre a controle da pandemia quanto sobre os efeitos econ√¥micos a m√©dio prazo do que uma postura mais branda que, por sua vez, √© ineficaz em ambos.

[[file:./figs/COVID/Casos_Policy_LowHigh.pdf]]

* Mobilidade e pol√≠ticas implementadas

#+begin_src R  :results value file :exports results
countries <- c(
  "USA",
  "SWE",
  "ARG",
  "BRA",
  "PRY",
  "URY",
  "VEN",
  "PRT",
  "GBR"
) 

policy <-"C6"
policy_name <- "Ficar em casa"
width <- 7
library(RColorBrewer)
myColors <- brewer.pal(5,"Set1")

df <- read_csv(
  "./clean/COVID/casos_TipoIsolamento_Onda.csv",
  guess_max = 3000
) %>%
  select(date, iso_code, Residential, C1, C1_Flag, C2, C2_Flag, C6, C6_Flag, Pico, new_cases_per_million) %>%
  mutate(C6 = case_when(
           C6 == 0 ~ "Sem restri√ß√£o",
           C6 == 1 ~ "Recomendado ficar\nem casa",
           C6 == 2 ~ "Proibido sair\n(Salvo exce√ß√µes)",
           C6 == 3 ~ "Proibido sair"),
    C6 = fct_relevel(C6, "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair"))

names(myColors) <- levels(df$C6)


  
for(country in countries){
    
name <-paste0("./figs/COVID/Mobilidade_Policy_", country, "_", policy, ".pdf")
tmp <- df %>%  filter(iso_code == country) %>%
  mutate(Residential=zoo::rollapply(
           Residential,
           width,
           mean,
           align='right',fill=NA))

df_inf <- tmp %>%
  group_by(iso_code) %>%
  summarise(vline = date[Pico==1]) %>%
  ungroup()
  
p1 <- tmp %>% ggplot(aes(x = date, y = Residential, color = new_cases_per_million)) +
  geom_line( size = 1.25 ) +
  guides(
    color = guide_colorbar(reverse = TRUE)) +
  scale_color_continuous(name = "Novos casos\npor milh√£o", high = "#132B43", low = "#56B1F7") +
  geom_vline(
    data = df_inf,
    mapping = aes(xintercept = vline),
    color = "black"
  ) +
  labs(
    y = "Tempo em casa (Semana M√≥vel)",
    x = "",
    title = country
  ) +
  ylim(0, 27.5)

tmp %>%
  select(date, C6, C6_Flag) %>%
  pivot_longer(C6, names_to = "Policy", values_to = "Measure") %>%
  mutate(Policy = 1) %>%
  pivot_wider(values_from = Policy, values_fill = NA, names_from = Measure) %>%
  pivot_longer(!c(date, C6_Flag), values_to = "Measure") ->tmp_long
  
p2 <- tmp_long %>%  ggplot(aes(x = date, y = Measure, color=name) ) +
  geom_line(aes(size=factor(C6_Flag))) +
  scale_y_discrete(labels = abbreviate) +
  scale_color_manual(values=myColors, name=policy_name) +
  scale_size_discrete(name = "Abrang√™ncia", labels = c("Focalizado", "Federal"), limits = c("0","1")) +
  theme_minimal() +
  theme(
    legend.position = "right",
    axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
    axis.ticks.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
     axis.title.x = element_blank(),
    axis.text.y = element_blank()
    ) +
  labs(
    y = "",
    x = ""
  )

legend_1 <- get_legend(
  # create some space to the left of the legend
  p1 + theme(legend.box.margin = margin(0, 0, 0, 12))
)
  
legend_2 <- get_legend(
  # create some space to the left of the legend
  p2 + theme(legend.box.margin = margin(0, 0, 0, 12))
)
p2 <- p2 + theme(legend.position="none")  
p1 <- p1 + theme(legend.position="none")  
fig <- cowplot::plot_grid(p1, p2, nrow = 2, rel_heights = c(3,0.5), align="v", axis="lr")
assign(country, fig, envir=.GlobalEnv)
print(name)
ggsave(name, width = 20, height = 20, units = "cm")
}
# arrange the three plots in a single row
prow <- plot_grid(
  ARG,
  BRA,
  PRY,
  URY,
  VEN,
  USA,
  align = 'hv',
  axis = 'lr',
  ## hjust = -1,
  nrow = 2
)

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).

name <- paste0("./figs/COVID/Mobilidade_Policy_", "selected", "_", policy, ".pdf")

legends <- plot_grid(
  legend_1,
  legend_2,
  nrow = 2,
  align = 'hv',
  hjust = -1
)

fig<- plot_grid(
  prow,
  NULL,
  legends,
  rel_widths = c(3, 0.05, .4),
  nrow = 1
  )


fig <- ggdraw(fig) +
   draw_image(logo_file, x = 1.0, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 40, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Mobilidade_Policy_selected_C6.pdf]]
:end:




* Mobilidade, medidas adotadas, casos acumulados por estados brasileiros

** Dados de pol√≠ticas adotdas :noexport:

#+begin_src R
df <-read_csv(
  'https://raw.githubusercontent.com/OxCGRT/Brazil-covid-policy/master/data/OxCGRT_Brazil_latest.csv',
  guess_max = 3000
)  %>%
  select(Date, RegionName, RegionCode, Jurisdiction, `C6_Stay at home requirements`, C6_Flag, C6_Notes) %>%
  rename(C6 = `C6_Stay at home requirements`) %>%
  filter(Jurisdiction == "STATE_WIDE") %>%
  mutate(Date = lubridate::ymd(Date)) %>%
  mutate(
    C6 = case_when(
           C6 == 0 ~ "Sem restri√ß√£o",
           C6 == 1 ~ "Recomendado ficar\nem casa",
           C6 == 2 ~ "Proibido sair\n(Salvo exce√ß√µes)",
           C6 == 3 ~ "Proibido sair",
           is.na(C6) ~ "Dados indispon√≠veis"
      )) %>%
  mutate(C6 = factor(C6)) %>%
  mutate(C6 = fct_relevel(C6, "Dados indispon√≠veis", "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair")) %>%
  mutate(C6_Flag = factor(C6_Flag)) %>%
  arrange(RegionName, Date) %>%
  select(-c(Jurisdiction, C6_Notes)) %>%
  rowwise() %>%  mutate(RegionCode = strsplit(RegionCode, split="_")[[1]][2]) %>%
  rename(Estado = RegionName, Sigla = RegionCode, date = Date) %>%
  mutate(Estado = factor(Estado), Sigla = factor(Sigla))



write.csv(
  df,
  './clean/COVID/Estados/Medidas_Estados_Brasil.csv',
  row.names = FALSE
)

df %>%  pivot_longer(C6, names_to = "Policy", values_to = "Measure") %>%
  mutate(Policy = 1) %>%
  pivot_wider(values_from = Policy, values_fill = NA, names_from = Measure) %>%
  pivot_longer(!c(date, C6_Flag, Estado, Sigla), values_to = "Measure") %>%
  mutate(name = factor(name)) -> df_long

write.csv(
  df_long,
  './clean/COVID/Estados/Medidas_Estados_Brasil_Long.csv',
  row.names = FALSE
)
#+end_src

#+RESULTS:
:results:

[36m‚îÄ‚îÄ[39m [1m[1mColumn specification[1m[22m [36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m
cols(
  .default = col_double(),
  CountryName = [31mcol_character()[39m,
  CountryCode = [31mcol_character()[39m,
  RegionName = [31mcol_character()[39m,
  RegionCode = [31mcol_character()[39m,
  CityName = [31mcol_character()[39m,
  CityCode = [31mcol_character()[39m,
  Jurisdiction = [31mcol_character()[39m,
  C1_Notes = [31mcol_character()[39m,
  C2_Notes = [31mcol_character()[39m,
  C3_Notes = [31mcol_character()[39m,
  C4_Notes = [31mcol_character()[39m,
  C5_Notes = [31mcol_character()[39m,
  C6_Notes = [31mcol_character()[39m,
  C7_Notes = [31mcol_character()[39m,
  C8_Notes = [31mcol_character()[39m,
  E1_Notes = [31mcol_character()[39m,
  E2_Notes = [31mcol_character()[39m,
  E3_Notes = [31mcol_character()[39m,
  E4_Notes = [31mcol_character()[39m,
  H1_Notes = [31mcol_character()[39m
  # ... with 9 more columns
)
[36m‚Ñπ[39m Use [30m[47m[30m[47m`spec()`[47m[30m[49m[39m for the full column specifications.
:end:

** Dados de mobilidade :noexport:

#+begin_src R
df <- data.table::fread(
    './raw/Covid/Google_Mobility.csv',
    select = c(
        "date",
        "country_region_code",
        "sub_region_1",
        "sub_region_2",
        "residential_percent_change_from_baseline",
        "iso_3166_2_code"
    ),
    na.strings="",
    data.table = FALSE,
    strip.white = TRUE,
    stringsAsFactors = FALSE, 
    fill = TRUE,
    sep= ","
) %>%
  filter(country_region_code == "BR") %>%
  drop_na(sub_region_1) %>%
  filter(is.na(sub_region_2)) %>%
  select(date, iso_3166_2_code, residential_percent_change_from_baseline) %>%
  rename(Sigla = iso_3166_2_code, Residential = residential_percent_change_from_baseline) %>%
  rowwise() %>%  mutate(Sigla = strsplit(Sigla, split="-")[[1]][2]) %>%
  arrange(Sigla, date) %>%
  mutate(Sigla = factor(Sigla))

data.table::fwrite(
              df,
              './clean/COVID/Estados/Mobilidade.csv',
              row.names = FALSE
              )
    
#+end_src

#+RESULTS:
:results:
:end:





** Dados de casos :noexport:

#+begin_src R

df <- data.table::fread(
    './raw/Covid/Casos_Brasilio.csv') %>%
  filter(place_type == "state") %>%
  select(date,
         state,
         new_confirmed,
         new_deaths,
         estimated_population,
         last_available_confirmed_per_100k_inhabitants
         ) %>%
  arrange(state, date) %>%
  rename(
    Sigla = state,
    new_cases = new_confirmed,
    total_cases_per_million = last_available_confirmed_per_100k_inhabitants,
    Populacao = estimated_population
    ) %>%
  mutate(Sigla = factor(Sigla))


data.table::fwrite(
              df,
              './clean/COVID/Estados/Casos.csv',
              row.names = FALSE
              )
    
#+end_src

#+RESULTS:
:results:
:end:

** Unindo dataframes :noexport:

#+begin_src R
after <- 3

df <-read_csv(
  './clean/COVID/Estados/Medidas_Estados_Brasil.csv',
  guess_max = 3000
) 

# check if full_join or right or left join
tmp <- read_csv(
  './clean/COVID/Estados/Mobilidade.csv',
)
df <- df %>% left_join(tmp)

tmp <- read_csv(
  './clean/COVID/Estados/Casos.csv',
)
df <- df %>% left_join(tmp)

df <- df %>%
  mutate(C6 = factor(C6)) %>%
  mutate(Sigla = factor(Sigla)) %>%
  mutate(Policy_change = c(NA, diff(C6 %>% fct_rev() %>% as.numeric()))) %>%
  mutate(stayhome_growth_14 = (Residential/lag(Residential,14) - 1) * 100) %>%
  mutate(stayhome_growth_after = (lead(Residential, after)/Residential - 1) * 100) %>%
  mutate(Isolamento = case_when(
     stayhome_growth_after >= 0 & C6 == "Algumas exce√ß√µes\npara sair" |  C6 == "Proibido sair" ~ "R√≠gido", # Queda da mobilidade junto da imposi√ß√£o
     stayhome_growth_after > 0 & Policy_change > 0  &  C6 == "Recomendado ficar\nem casa" | C6 == "Sem restri√ß√£o" ~ "Brando",
     stayhome_growth_after > 0 & Policy_change <=0 & C6 != "Proibido sair" ~ "Volunt√°rio", # Queda da mobilidade sem restri√ß√£o
     stayhome_growth_after < 0 ~ "Queda",
     is.na(stayhome_growth_after) | is.na(Policy_change) ~ "Dados indispon√≠veis"
           )) %>%
  mutate(Isolamento = factor(Isolamento)) %>%
  mutate(cases_growth = ((new_cases/lag(new_cases)) - 1) * 100) %>%
  mutate(deaths_growth = (new_deaths/lag(new_deaths) - 1) * 100) %>%
  mutate(new_cases_100K = (replace_na(new_cases, 0)/Populacao)*10^5) %>%
  mutate(new_deaths_100K = (replace_na(new_cases, 0)/Populacao)*10^5) %>%
  mutate(new_cases_100K = zoo::rollapply(new_cases_100K, width = 7, FUN = mean, fill = NA)) %>%
  mutate(new_cases_1M = (replace_na(new_cases, 0)/Populacao)*10^6) %>%
  mutate(new_cases_100K = zoo::rollapply(new_cases_100K, width = 7, FUN = mean, fill = NA)) %>%
  mutate(cases_growth_100K = (((new_cases_100K)/lag(new_cases_100K))-1)*100) %>%
  group_by(Sigla) %>%
  mutate(cum_cases_100K = (cumsum(replace_na(new_cases, 0))/Populacao)*10^5) %>%
  mutate(cum_cases_100K = zoo::rollapply(cum_cases_100K, width = 7, FUN = mean, fill = NA)) %>%
  mutate(cum_cases_1M = (cumsum(replace_na(new_cases, 0))/Populacao)*10^6) %>%
  mutate(cum_cases_1M = zoo::rollapply(cum_cases_1M, width = 7, FUN = mean, fill = NA)) %>%
  mutate(cum_deaths_100K = (cumsum(replace_na(new_deaths, 0))/Populacao)*10^5) %>%
  mutate(cum_deaths_100K = zoo::rollapply(cum_deaths_100K, width = 7, FUN = mean, fill = NA)) %>%
  ungroup()

w <- 14 * 3
th_new_cases <- 100 * 3
th_total_deaths <- 100
th_cases_100 <- 12.5

df <- df %>%
  group_by(Sigla) %>%
  mutate(total_deaths = cumsum(replace_na(new_deaths, 0))) %>%
  ungroup() %>%
  mutate(tmp = zoo::rollapply(new_cases, 7, mean, fill = NA, align = "center")) %>%
  mutate(y.max = zoo::rollapply(tmp, 2 * w + 1, max, fill = NA, align = "center")) %>%
  mutate(delta = y.max - tmp) %>%
  mutate(Pico = new_cases_100K >= th_cases_100 & delta <= 0) %>%
  group_by(Sigla) %>%
  fill(Pico, .direction = "up") %>%
  mutate(nPico = cumsum(Pico)) %>%
  ungroup() %>%
  mutate(Onda = case_when(
    total_deaths >= th_total_deaths & nPico == 0 ~ "In√≠cio ao 1o pico",
    total_deaths >= th_total_deaths & nPico == 1 ~ "1o ao 2o Pico",
    total_deaths >= th_total_deaths & nPico >= 2 ~ "p√≥s 2o pico"
  )) %>%
  mutate(Onda = factor(Onda)) %>%
  fill(Onda) %>%
  fill(Onda, .direction = "up") %>%
  mutate(Onda = fct_relevel(Onda, "In√≠cio ao 1o pico", "1o ao 2o Pico", "p√≥s 2o pico"))
  
write.csv(
  df,
  './clean/COVID/Estados/Merged_wide.csv',
  row.names = FALSE
)
#+end_src

#+RESULTS:
:results:

[36m‚îÄ‚îÄ[39m [1m[1mColumn specification[1m[22m [36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m
cols(
  date = [34mcol_date(format = "")[39m,
  Estado = [31mcol_character()[39m,
  Sigla = [31mcol_character()[39m,
  C6 = [31mcol_character()[39m,
  C6_Flag = [32mcol_double()[39m
)

[36m‚îÄ‚îÄ[39m [1m[1mColumn specification[1m[22m [36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m
cols(
  date = [34mcol_date(format = "")[39m,
  Sigla = [31mcol_character()[39m,
  Residential = [32mcol_double()[39m
)
Joining, by = c("date", "Sigla")

[36m‚îÄ‚îÄ[39m [1m[1mColumn specification[1m[22m [36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[39m
cols(
  date = [34mcol_date(format = "")[39m,
  Sigla = [31mcol_character()[39m,
  new_cases = [32mcol_double()[39m,
  new_deaths = [32mcol_double()[39m,
  Populacao = [32mcol_double()[39m,
  total_cases_per_million = [32mcol_double()[39m
)
Joining, by = c("date", "Sigla")
:end:

** N√∫mero de casos por estados

#+begin_src R :results value file :exports file :var figname="Casos"

df <- read_csv(
  "./clean/COVID/Estados/Merged_wide.csv",
  guess_max = 3000
) %>%
  mutate(C6 = factor(C6),
         C6 = fct_relevel(C6, "Dados indispon√≠veis", "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair")) %>%
  mutate(Estado = factor(Estado)) %>%
  group_by(Sigla)

name = paste0('./figs/COVID/Estados/', figname, ".pdf")

df_inf <- df %>%
  group_by(Estado) %>%
  summarise(vline = date[Pico==1])

df %>% ggplot(aes(x=date)) +
  geom_line(aes(y=new_cases_100K), color="red") +
  geom_vline(
    data = df_inf,
    mapping = aes(xintercept = vline),
    color = "black"
  ) +
  labs(
    y = "Novos casos por\n100 mil habitantes",
    x = ""
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_date(date_breaks = "2 months", date_minor_breaks = "2 weeks", date_labels = "%b/%y") +
  guides(fill=guide_legend(title="Estados Brasileiros")) +
      theme(
        axis.text.y.left = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y.left = element_text(size = 14),
        strip.text = element_text( size = 12, face = "bold" )
      ) +
  facet_wrap(~Estado) ->fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.95, y = 0.15, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 40, height = 30, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Estados/Casos.pdf]]
:end:

** N√∫mero de mortes por estados

#+begin_src R :results value file :exports file :var figname="Mortes"

df <- read_csv(
  "./clean/COVID/Estados/Merged_wide.csv",
  guess_max = 3000
) %>%
  mutate(C6 = factor(C6),
         C6 = fct_relevel(C6, "Dados indispon√≠veis", "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair")) %>%
  mutate(Estado = factor(Estado)) %>%
  group_by(Sigla)

name = paste0('./figs/COVID/Estados/', figname, ".pdf")

df_inf <- df %>%
  group_by(Estado) %>%
  summarise(vline = date[Pico==1])

df %>% ggplot(aes(x=date)) +
  geom_line(aes(
    y=zoo::rollapply(new_deaths_100K, 14, mean, align='right',fill=NA)
    ), color="red") +
  ## geom_vline(
  ##   data = df_inf,
  ##   mapping = aes(xintercept = vline),
  ##   color = "black"
  ## ) +
  labs(
    y = "Novas mortes por 100 mil habitantes",
    x = ""
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_date(date_breaks = "2 months", date_minor_breaks = "2 weeks", date_labels = "%b/%y") +
  guides(fill=guide_legend(title="Estados Brasileiros")) +
      theme(
        axis.text.y.left = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y.left = element_text(size = 14),
        strip.text = element_text( size = 12, face = "bold" )
      ) +
  facet_wrap(~Estado) ->fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.95, y = 0.15, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 40, height = 30, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Estados/Mortes.pdf]]
:end:

** N√∫mero de casos acumulados por estados

#+begin_src R :results value file :exports file :var figname="Casos_Cum"

df <- read_csv(
  "./clean/COVID/Estados/Merged_wide.csv",
  guess_max = 3000
) %>%
  mutate(C6 = factor(C6),
         C6 = fct_relevel(C6, "Dados indispon√≠veis", "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair")) %>%
  mutate(Estado = factor(Estado)) %>%
  group_by(Sigla)

name = paste0('./figs/COVID/Estados/', figname, ".pdf")

df_inf <- df %>%
  group_by(Estado) %>%
  summarise(vline = date[Pico==1])

df %>% ggplot(aes(x=date)) +
  geom_line(aes(y=cum_cases_100K), color="red") +
  ## geom_vline(
  ##   data = df_inf,
  ##   mapping = aes(xintercept = vline),
  ##   color = "black"
  ## ) +
  labs(
    y = "Casos acumulados por\n100 mil habitantes",
    x = ""
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_date(date_breaks = "2 months", date_minor_breaks = "2 weeks", date_labels = "%b/%y") +
  guides(fill=guide_legend(title="Estados Brasileiros")) +
      theme(
        axis.text.y.left = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y.left = element_text(size = 14),
        strip.text = element_text( size = 12, face = "bold" )
      ) +
  facet_wrap(~Estado) ->fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.95, y = 0.15, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 40, height = 30, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Estados/Casos_Cum.pdf]]
:end:

** N√∫mero de mortes acumuadas por estados

#+begin_src R :results value file :exports file :var figname="Mortes_Cum"

df <- read_csv(
  "./clean/COVID/Estados/Merged_wide.csv",
  guess_max = 3000
) %>%
  mutate(C6 = factor(C6),
         C6 = fct_relevel(C6, "Dados indispon√≠veis", "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair")) %>%
  mutate(Estado = factor(Estado)) %>%
  group_by(Sigla)

name = paste0('./figs/COVID/Estados/', figname, ".pdf")

df_inf <- df %>%
  group_by(Estado) %>%
  summarise(vline = date[Pico==1])

df %>% ggplot(aes(x=date)) +
  geom_line(aes(y=cum_cases_100K), color="red") +
  ## geom_vline(
  ##   data = df_inf,
  ##   mapping = aes(xintercept = vline),
  ##   color = "black"
  ## ) +
  labs(
    y = "Mortes acumulados por 100 mil habitantes",
    x = ""
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_x_date(date_breaks = "2 months", date_minor_breaks = "2 weeks", date_labels = "%b/%y") +
  guides(fill=guide_legend(title="Estados Brasileiros")) +
      theme(
        axis.text.y.left = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        axis.title.y.left = element_text(size = 14),
        strip.text = element_text( size = 12, face = "bold" )
      ) +
  facet_wrap(~Estado) ->fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.95, y = 0.15, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 40, height = 30, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Estados/Mortes_Cum.pdf]]
:end:

** Novos casos e mortes - Brasil


#+begin_src R :results value file :var figname="Brasil"

name = paste0('./figs/COVID/Estados/', figname, ".pdf")


df <- read_csv(
  "./clean/COVID/casos_TipoIsolamento_Onda.csv",
  guess_max = 3000
) %>% filter(iso_code == "BRA")


rescale = max(df$new_deaths_smoothed_per_million)/max(df$new_cases_smoothed_per_million)
    
# https://stackoverflow.com/questions/10942360/how-to-get-geom-vline-to-honor-facet-wrap
df_inf <- df %>% 
  summarise(vline = date[Pico==1])


df %>% ggplot(aes(x=date)) +
  ## geom_line(aes(y=new_cases_smoothed_per_million), color="black", linetype="dashed") + 
  geom_line(aes(y=new_cases_smoothed_per_million), color="blue") +
  geom_line(aes(y=new_deaths_smoothed_per_million/rescale), color="red") +
  geom_vline(
    data = df_inf, 
    mapping = aes(xintercept = vline),
    color = "black"
  ) +
  labs(
    x = ""
  ) +
      scale_y_continuous(
        name = "Novos casos por milh√£o de habitantes",
        sec.axis = sec_axis( trans=~.*rescale, name="Novos mortes por milh√£o de habitantes")
      ) +
      theme(
        axis.line.y.right = element_line(color = "red"), 
        axis.ticks.y.right = element_line(color = "red"),
        axis.line.y.left = element_line(color = "blue"), 
        axis.ticks.y.left = element_line(color = "blue"),
        axis.text.y.right = element_text(size = 18),
        axis.text.y.left = element_text(size = 18),
        axis.text.x = element_text(size = 18),
        axis.title.y.left = element_text(size = 18),
        axis.title.y.right = element_text(size = 18)
      ) +
  scale_x_date(date_breaks = "1 month", date_minor_breaks = "2 weeks", date_labels = "%b/%y") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) ->fig


 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.35, y = 0.95, hjust = 1, vjust = 1, width = 0.25, height = 0.2)
ggsave(name, width = 40, height = 30, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Estados/Brasil.pdf]]
:end:

** Gr√°ficos de mobilidade e pol√≠tica por estados

#+begin_src R  :results value file :exports results
policy <-"C6"
policy_name <- "Ficar em casa"
width <- 7
library(RColorBrewer)
myColors <- brewer.pal(5,"Set1")

df <- read_csv(
  "./clean/COVID/Estados/Merged_wide.csv",
  guess_max = 3000
) %>%
  mutate(C6 = factor(C6),
         C6 = fct_relevel(C6, "Dados indispon√≠veis", "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair")) %>%
  mutate(Estado = factor(Estado)) %>%
  group_by(Sigla) %>%
  mutate(Residential=zoo::rollapply(
                              Residential,
                              width,
                              mean,
                              align='right',fill=NA)) %>%
  ungroup() %>%
  filter(Residential > -2)

estados <- df$Sigla %>% unique()



names(myColors) <- levels(df$C6)
lefts <- c(
  "AC",
  "AP", 
  "DF",
  "MA",
  "MT",
  "PE",
  "RJ",
  "RR",
  "SE"
)

rights <- c(
  "AM",
  "CE",
  "GO",
  "MS",
  "PB",
  "PR",
  "RO",
  "SC",
  "TO"
)   

plots <- c()

for(estado in estados){

  name <-paste0("./figs/COVID/Estados/Mobilidade_Policy_", estado, "_", policy, ".pdf")
  tmp <- df %>%  filter(Sigla == estado)

  df_inf <- tmp %>%
    group_by(Sigla) %>%
    summarise(vline = date[Pico==1]) %>%
    ungroup()

  rescale <- ((replace_na(tmp$new_cases_100K,0) %>% max())/(replace_na(tmp$Residential, 0) %>% max()))  %>% round()
                                        # color = new_cases n√£o tem legenda adequada  
  p1 <- tmp %>% ggplot(aes(x = date, y = Residential, color = "blue")) +
    geom_line( size = 1.25 ) +
    geom_line( aes(x = date, y = new_cases_100K/rescale), color = "red", size = 1.25 ) +
    ## guides(
    ##   color = guide_colorbar(reverse = TRUE)) +
    ## scale_color_continuous(name = "Novos casos", high = "#132B43", low = "#56B1F7") +
    geom_vline(
      data = df_inf,
      mapping = aes(xintercept = vline),
      color = "black"
    ) +
    ylim(0, 27.5) +
    scale_x_date(date_breaks = "2 months", date_minor_breaks = "2 weeks", date_labels = "%b/%y")

  if(estado %in% rights){  
    p1 <-p1 + labs(
                ## y = "Tempo em casa",
                x = "",
                title = tmp$Estado %>% unique()
              ) +
                                        # Custom the Y scales:
      scale_y_continuous(
        name = "",
        sec.axis = sec_axis( trans=~.*rescale, name="Novos casos/\n100 mil hab")
      ) +
      theme(
        axis.line.y.right = element_line(color = "red"), 
        axis.ticks.y.right = element_line(color = "red"),
        axis.line.y.left = element_line(color = "blue"), 
        axis.ticks.y.left = element_line(color = "blue"),
        axis.text.y.right = element_text(size = 14),
        axis.text.y.left = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y.right = element_text(size = 18)
      )
  } else if(estado %in% lefts){

    p1 <-p1 + labs(
                x = "",
                title = tmp$Estado %>% unique()
              ) +
                                        # Custom the Y scales:
      scale_y_continuous(
        name = "Tempo em casa",
        sec.axis = sec_axis( trans=~.*rescale, name="")
      ) +
      theme(
        axis.line.y.right = element_line(color = "red"), 
        axis.ticks.y.right = element_line(color = "red"),
        axis.line.y.left = element_line(color = "blue"), 
        axis.ticks.y.left = element_line(color = "blue"),
        axis.text.y.right = element_text(size = 14),
        axis.text.y.left = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.title.y.left = element_text(size = 18)
      )
  } else{

    p1 <-p1 + labs(
                x = "",
                title = tmp$Estado %>% unique()
              ) +
                                        # Custom the Y scales:
      scale_y_continuous(
        name = "",
        sec.axis = sec_axis( trans=~.*rescale, name="")
      ) +
      theme(
        axis.line.y.right = element_line(color = "red"), 
        axis.ticks.y.right = element_line(color = "red"),
        axis.line.y.left = element_line(color = "blue"), 
        axis.text.y.right = element_text(size = 14),
        axis.text.y.left = element_text(size = 14),
        axis.text.x = element_text(size = 14),
        axis.ticks.y.left = element_line(color = "blue")
      )
  }
  
  
  tmp %>%
    select(date, C6, C6_Flag) %>%
    pivot_longer(C6, names_to = "Policy", values_to = "Measure") %>%
    mutate(Policy = 1) %>%
    pivot_wider(values_from = Policy, values_fill = NA, names_from = Measure) %>%
    pivot_longer(!c(date, C6_Flag), values_to = "Measure") ->tmp_long

  p2 <- tmp_long %>%
    mutate(C6_Flag = case_when(
             C6_Flag == 1 ~ "Estadual",
             C6_Flag == 0 ~ "Local",
             is.na(C6_Flag) ~ "Sem dados"
           )) %>%
    mutate(C6_Flag = C6_Flag %>% factor() %>% fct_rev()) %>%
    rename(Cobertura = C6_Flag) %>%
    ggplot(aes(x = date, y = Measure, color=name) ) +
    ## geom_line(aes(size=1)) +
    geom_line(aes(size = Cobertura)) +
    scale_y_discrete(labels = abbreviate) +
    scale_color_manual(
      values=c("#575757", "#23AE00", "#FFCE14", "#FF7319", "#CA0014"),
      breaks=c("Dados indispon√≠veis", "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair"),
      name=policy_name) +
    theme_minimal() +
    theme(
      legend.position = "right",
      axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
      axis.ticks.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
      axis.title.x = element_blank(),
      axis.text.y = element_blank()
    ) +
    labs(
      y = "",
      x = ""
    )


  ## legend_1 <- get_legend(
  ##                                       # create some space to the left of the legend
  ##   p1 + theme(legend.box.margin = margin(0, 0, 0, 12))
  ## )
  if(estado == "RO"){
    legend_2 <- get_legend(
                                        # create some space to the left of the legend
      p2 +
      theme(legend.box.margin = margin(0, 0, 0, 12), legend.title=element_text(size=22), legend.text=element_text(size=20)) +
    guides(colour = guide_legend(override.aes = list(size=3)))
    )
  }
  p2 <- p2 + theme(legend.position="none")
  p1 <- p1 + theme(legend.position="none")
  fig <- cowplot::plot_grid(
                    p1 + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)),
                    p2 + theme(plot.margin = margin(t=-1.1, b=1., unit="cm"), axis.text.x = element_blank()) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()),
                    nrow = 2,
                    rel_heights = c(3,0.5),
                    align="v",
                    axis="lr"
                  )
  assign(estado, fig, envir=.GlobalEnv)

  plots <- c(plots, estado)

  print(name)
  ggsave(name, width = 32, height = 20, units = "cm")
}
                                        # arrange the three plots in a single row
prow <- plot_grid(
  AC, AL, AM,
  AP, BA, CE,
  DF, ES, GO,
  MA, MG, MS,
  MT, PA, PB,
  PE, PI, PR,
  RJ, RN, RO,
  RR, RS, SC,
  SE, SP, TO,
  align = 'hv',
  axis = 'lr',
  ## hjust = -1,
  nrow = 9
)

                                        # add the legend to the row we made earlier. Give it one-third of
                                        # the width of one plot (via rel_widths).

name <- paste0("./figs/COVID/Estados/Mobilidade_Policy_", "selected", "_", policy, ".pdf")

## legends <- plot_grid(
##   legend_1,
##   legend_2,
##   nrow = 2,
##   align = 'hv',
##   hjust = -1
## )

legends <-legend_2

fig<- plot_grid(
  prow,
  NULL,
  legends,
  rel_widths = c(3, 0.01, .4),
  nrow = 1
)


fig <- ggdraw(fig) # + draw_image(logo_file, x = 0.999, y = .975, hjust = 1, vjust = 1, width = 0.125, height = 0.1)
ggsave(name, width = 66, height = 77, units = "cm")
print(name)
#+end_src

** Boxplots de taxa de crescimento e tipo de isolamento

#+begin_src R :results value file :var figname="Boxplot_Isolamento"

name = paste0('./figs/COVID/Estados/', figname, ".pdf")

df <- read_csv(
  "./clean/COVID/Estados/Merged_wide.csv",
  guess_max = 3000
) %>%
  mutate(C6 = factor(C6)) %>%
  mutate(Isolamento_14 = factor(Isolamento)) %>%
  mutate(Sigla = factor(Sigla)) %>%
  mutate(Onda = fct_relevel(Onda, "In√≠cio ao 1o pico", "1o ao 2o Pico", "p√≥s 2o pico"))

df %>%
  filter(
    cases_growth < 10,
    cases_growth > -10,
    cases_growth_100K <10,
    cases_growth_100K > -10
  ) %>%
  drop_na(Policy_change, Onda, cases_growth, Isolamento) %>%
  ggplot(aes(y=Onda, x= cases_growth_100K, fill=Isolamento)) +
  geom_vline(xintercept=0, color="black") +
  geom_boxplot(outlier.shape = NA, outlier.color=NA, outlier.alpha=1) +
  labs(
    y = "Fase da Pandemia",
    x = "Tx. novos casos por 100 mil habitantes"
  ) +
  scale_fill_manual(
      values=c("#ffffff", "#23AE00", "#FFCE14", "#CA0014", "#0700A3"),
      breaks=c("Dados indispon√≠veis", "Queda", "Brando", "R√≠gido", "Volunt√°rio"),
      name="Tipo de isolamento") +
  ## scale_fill_manual(values=c("#FF0000", "#00FF00","#0000FF")) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~Sigla) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Estados/Boxplot_Isolamento.pdf]]
:end:

** Gr√°ficos de mobilidade e pol√≠tica por estados para indicar quando houve medida adotada

#+begin_src R  :results value file :exports results
policy <-"C6"
policy_name <- "Ficar em casa"
width <- 7
library(RColorBrewer)
myColors <- brewer.pal(5,"Set1")

df <- read_csv(
  "./clean/COVID/Estados/Merged_wide.csv",
  guess_max = 3000
) %>%
  mutate(C6_num = case_when(
           ## C6 == "Dados indispon√≠veis" ~ NA_integer_,
           C6 == "Sem restri√ß√£o" ~ 0,
           C6 == "Recomendado ficar\nem casa" ~ 1,
           C6 == "Proibido sair\n(Salvo exce√ß√µes)" ~ 2,
           C6 == "Proibido sair" ~ 3
         )) %>%
  mutate(Restrict = diff(c(NA, C6_num))) %>%
  mutate(Estado = factor(Estado)) %>%
  group_by(Sigla) %>%
  mutate(Residential=zoo::rollapply(
                              Residential,
                              width,
                              mean,
                              align='right',fill=NA)) %>%
  ungroup() %>%
  filter(Residential > -2)

estados <- df$Sigla %>% unique()



names(myColors) <- levels(df$C6)
lefts <- c(
  "AC",
  "AP",
  "DF",
  "MA",
  "MT",
  "PE",
  "RJ",
  "RR",
  "SE"
)

rights <- c(
  "AM",
  "CE",
  "GO",
  "MS",
  "PB",
  "PR",
  "RO",
  "SC",
  "TO"
)

plots <- c()

for(estado in estados){

  tmp <- df %>%  filter(Sigla == estado)

  df_inf <- tmp %>%
    group_by(Sigla) %>%
    summarise(vline = date[Restrict>0]) %>%
    ungroup()

  rescale <- ((replace_na(tmp$new_cases_100K,0) %>% max())/(replace_na(tmp$Residential, 0) %>% max()))  %>% round()
                                        # color = new_cases n√£o tem legenda adequada
  p1 <- tmp %>% ggplot(aes(x = date, y = Residential, color = "blue")) +
    geom_line( size = 1.25 ) +
    geom_line( aes(x = date, y = new_cases_100K/rescale), color = "red", size = 1.25 ) +
    ## guides(
    ##   color = guide_colorbar(reverse = TRUE)) +
    ## scale_color_continuous(name = "Novos casos", high = "#132B43", low = "#56B1F7") +
    geom_vline(
      data = df_inf,
      mapping = aes(xintercept = vline),
      color = "black"
    ) +
    geom_vline(
      data = df,
      mapping = aes(xintercept = "2020-03-24" %>% as.Date() %>% as.numeric()),
      color = "red",
      linetype="dashed"
    ) +
    ylim(0, 27.5) +
    scale_x_date(date_breaks = "2 months", date_minor_breaks = "2 weeks", date_labels = "%b/%y")

  if(estado %in% rights){
    p1 <-p1 + labs(
                ## y = "Tempo em casa",
                x = "",
                title = tmp$Estado %>% unique()
              ) +
                                        # Custom the Y scales:
      scale_y_continuous(
        name = "",
        sec.axis = sec_axis( trans=~.*rescale, name="Novos casos / 100 mil hab")
      ) +
      theme(
        axis.line.y.right = element_line(color = "red"),
        axis.ticks.y.right = element_line(color = "red"),
        axis.line.y.left = element_line(color = "blue"),
        axis.ticks.y.left = element_line(color = "blue")
      )
  } else if(estado %in% lefts){

    p1 <-p1 + labs(
                x = "",
                title = tmp$Estado %>% unique()
              ) +
                                        # Custom the Y scales:
      scale_y_continuous(
        name = "Tempo em casa",
        sec.axis = sec_axis( trans=~.*rescale, name="")
      ) +
      theme(
        axis.line.y.right = element_line(color = "red"),
        axis.ticks.y.right = element_line(color = "red"),
        axis.line.y.left = element_line(color = "blue"),
        axis.ticks.y.left = element_line(color = "blue")
      )
  } else{

    p1 <-p1 + labs(
                x = "",
                title = tmp$Estado %>% unique()
              ) +
                                        # Custom the Y scales:
      scale_y_continuous(
        name = "",
        sec.axis = sec_axis( trans=~.*rescale, name="")
      ) +
      theme(
        axis.line.y.right = element_line(color = "red"),
        axis.ticks.y.right = element_line(color = "red"),
        axis.line.y.left = element_line(color = "blue"),
        axis.ticks.y.left = element_line(color = "blue")
      )
  }


  tmp %>%
    select(date, C6, C6_Flag) %>%
    pivot_longer(C6, names_to = "Policy", values_to = "Measure") %>%
    mutate(Policy = 1) %>%
    pivot_wider(values_from = Policy, values_fill = NA, names_from = Measure) %>%
    pivot_longer(!c(date, C6_Flag), values_to = "Measure") ->tmp_long

  p2 <- tmp_long %>%
    mutate(C6_Flag = case_when(
             C6_Flag == 1 ~ "Estadual",
             C6_Flag == 0 ~ "Local",
             is.na(C6_Flag) ~ "Sem dados"
           )) %>%
    mutate(C6_Flag = C6_Flag %>% factor() %>% fct_rev()) %>%
    rename(Cobertura = C6_Flag) %>%
    ggplot(aes(x = date, y = Measure, color=name) ) +
    ## geom_line(aes(size=1)) +
    geom_line(aes(size = Cobertura)) +
    scale_y_discrete(labels = abbreviate) +
    scale_color_manual(
      values=c("#575757", "#23AE00", "#FFCE14", "#FF7319", "#CA0014"),
      breaks=c("Dados indispon√≠veis", "Sem restri√ß√£o", "Recomendado ficar\nem casa", "Proibido sair\n(Salvo exce√ß√µes)", "Proibido sair"),
      name=policy_name) +
    theme_minimal() +
    theme(
      legend.position = "right",
      axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
      axis.ticks.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
      axis.title.x = element_blank(),
      axis.text.y = element_blank()
    ) +
    labs(
      y = "",
      x = ""
    )


  ## legend_1 <- get_legend(
  ##                                       # create some space to the left of the legend
  ##   p1 + theme(legend.box.margin = margin(0, 0, 0, 12))
  ## )
  if(estado == "RO"){
    legend_2 <- get_legend(
                                        # create some space to the left of the legend
      p2 + theme(legend.box.margin = margin(0, 0, 0, 12)) + guides(colour = guide_legend(override.aes = list(size=3)))
    )
  }
  p2 <- p2 + theme(legend.position="none")
  p1 <- p1 + theme(legend.position="none")
  fig <- cowplot::plot_grid(
                    p1 + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)),
                    p2 + theme(plot.margin = margin(t=-1.1, b=1., unit="cm"), axis.text.x = element_blank()) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()),
                    nrow = 2,
                    rel_heights = c(3,0.5),
                    align="v",
                    axis="lr"
                  )
  assign(estado, fig, envir=.GlobalEnv)

  plots <- c(plots, estado)

}
                                        # arrange the three plots in a single row
prow <- plot_grid(
  AC, AL, AM,
  AP, BA, CE,
  DF, ES, GO,
  MA, MG, MS,
  MT, PA, PB,
  PE, PI, PR,
  RJ, RN, RO,
  RR, RS, SC,
  SE, SP, TO,
  align = 'hv',
  axis = 'lr',
  ## hjust = -1,
  nrow = 9
)

                                        # add the legend to the row we made earlier. Give it one-third of
                                        # the width of one plot (via rel_widths).

name <- paste0("./figs/COVID/Estados/Quando_Policy_", "selected", "_", policy, ".pdf")

## legends <- plot_grid(
##   legend_1,
##   legend_2,
##   nrow = 2,
##   align = 'hv',
##   hjust = -1
## )

legends <-legend_2

fig<- plot_grid(
  prow,
  NULL,
  legends,
  rel_widths = c(3, 0.05, .4),
  nrow = 1
)


fig <- ggdraw(fig) # + draw_image(logo_file, x = 0.999, y = .975, hjust = 1, vjust = 1, width = 0.125, height = 0.1)
ggsave(name, width = 40, height = 64, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Estados/Quando_Policy_selected_C6.pdf]]
:end:
