#+TITLE: Dados: O PIB da pandemia e cenÃ¡rios para 2021
#+DATE: Janeiro de 2021
#+LATEX_CLASS: SelfArx
#+SETUPFILE: ../manuscript.setup
#+INCLUDE: Infos.org
#+PROPERTY: header-args python :results output drawer :eval never-export :session Cecon
#+PROPERTY: header-args R :results output drawer :eval never-export :session Cecon
#+LATEX:\flushbottom % Makes all text pages the same height
#+LATEX:\maketitle % Print the title and abstract box
#+LATEX:\thispagestyle{empty} % Removes page numbering from the first page
#+LATEX: \onecolumn

* Initial setup :noexport:ignore:
** Python
#+BEGIN_SRC python
import pandas as pd
import numpy as np
from datetime import datetime as dt
from datetime import timedelta

from tabulate import tabulate

import matplotlib.pyplot as plt
import matplotlib.ticker as ticker
from matplotlib.ticker import FuncFormatter

import seaborn as sns
import pandas_datareader.data as web
import requests
import json

import country_converter as coco

cc = coco.CountryConverter()

import matplotlib.image as image

logo = "./figs/Cecon_Logo.png"
logo = image.imread(logo)
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
corona_sp = "2020-03-24"
corona_sp_txt = "InÃ­cio isolamento social em SP"

corona_60 = "2020-03-18"
corona_60_txt = "Mais de 60 casos de COVID-19"

start_year = "2018-01-01"
base = "2014-12-01"


def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == "Jan":
        month += f"\n{label.year}"
    return month


# ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))


def line_format_day(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    day = label.day
    string = f"{day}/{month}"
    return month


def interpolator(df):
    for col in df:
        df[col] = pd.to_numeric(df[col], errors="coerce")
        df = df.resample("D").interpolate(method="time")

    return df


def line_format(label):
    """
    Convert time label to the format of pandas line plot
    """
    month = label.month_name()[:3]
    if month == "Jan":
        month += f"\n{label.year}"
    return month


def rebase(df, base=base):
    for col in df:
        df[col] = df[col].apply(lambda x: (100 * x) / df[col][base])
    return df


def consulta_bc(codigo_bcb, nome=["Nome da sÃ©rie"]):
    url = "http://api.bcb.gov.br/dados/serie/bcdata.sgs.{}/dados?formato=json".format(
        codigo_bcb
    )
    df = pd.read_json(url)
    df["data"] = pd.to_datetime(df["data"], dayfirst=True)
    df.set_index("data", inplace=True)
    df.index.name = ""
    df.columns = nome
    return df


def autolabel(rects):
    """
    Attach a text label above each bar displaying its height
    """
    for rect in rects:
        height = rect.get_height()
        ax.text(
            rect.get_x() + rect.get_width() / 2.0,
            1.05 * height,
            "%d" % int(height),
            ha="center",
            va="bottom",
        )


def add_value_labels(ax, spacing=5):
    """Add labels to the end of each bar in a bar chart.

    Arguments:
        ax (matplotlib.axes.Axes): The matplotlib object containing the axes
            of the plot to annotate.
        spacing (int): The distance between the labels and the bars.
    """

    # For each bar: Place a label
    for rect in ax.patches:
        # Get X and Y placement of label from rect.
        y_value = rect.get_height()
        x_value = rect.get_x() + rect.get_width() / 2

        # Number of points between bar and label. Change to your liking.
        space = spacing
        # Vertical alignment for positive values
        va = "bottom"

        # If value of bar is negative: Place label below bar
        if y_value < 0:
            # Invert space to place label below
            space *= -1
            # Vertically align label at top
            va = "top"

        # Use Y value as label and format number with one decimal place
        label = "{:.1f}".format(y_value)

        # Create annotation
        ax.annotate(
            label,  # Use `label` as label
            (x_value, y_value),  # Place label at end of the bar
            xytext=(0, space),  # Vertically shift label by `space`
            textcoords="offset points",  # Interpret `xytext` as offset in points
            ha="center",  # Horizontally center label
            va=va,
        )  # Vertically align label differently for
        # positive and negative values.
#+END_SRC

#+RESULTS:
:results:

(python3:13490): Gtk-[1;33mWARNING[0m **: [34m17:23:58.782[0m: Theme parsing error: gtk.css:1:117: Failed to import: Erro ao abrir arquivo /home/gpetrini/.local/share/gnome-shell/extensions/unite@hardpixel.eu/styles/buttons-right-always.css: Arquivo ou diretÃ³rio inexistente
:end:
** R

#+begin_src R
library(sidrar)
library(tidyverse)
library(cowplot)
logo_file <- './figs/Cecon_Logo.png'
source('https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R')
## get_png <- function(filename) {
##   grid::rasterGrob(png::readPNG(filename), interpolate = TRUE)
## }

## logo_file %>% get_png() -> logo_file

#+end_src

#+RESULTS:
:results:
â”€â”€ [1mAttaching packages[22m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse 1.3.0 â”€â”€
[32mâœ”[39m [34mggplot2[39m 3.3.2     [32mâœ”[39m [34mpurrr  [39m 0.3.4
[32mâœ”[39m [34mtibble [39m 3.0.4     [32mâœ”[39m [34mdplyr  [39m 1.0.2
[32mâœ”[39m [34mtidyr  [39m 1.1.2     [32mâœ”[39m [34mstringr[39m 1.4.0
[32mâœ”[39m [34mreadr  [39m 1.4.0     [32mâœ”[39m [34mforcats[39m 0.5.0
â”€â”€ [1mConflicts[22m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse_conflicts() â”€â”€
[31mâœ–[39m [34mdplyr[39m::[32mfilter()[39m masks [34mstats[39m::filter()
[31mâœ–[39m [34mdplyr[39m::[32mlag()[39m    masks [34mstats[39m::lag()
:end:

* Indicadores de antecedente
** IBC-Br (acumulado 12 meses vs 12 meses anteriores)

#+BEGIN_SRC python :results graphics file :file ./figs/Antecedente/IBCBr.pdf

df = consulta_bc(24364, ["IBCBr (%YoY)"])
df.index.name = ""
# df = rebase(df)
df = df.pct_change(12)
df = (1 + df / 100).rolling(window=12).agg(lambda x: x.prod()) - 1
df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"IBCBr Dessazonalizado",
    ax=ax,
    lw=2.5,
    color="black",
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label=corona_sp_txt)
ax.axhline(y=0, color="gray", ls="-")
ax.set_yticklabels(["{:,.2%}".format(x) for x in ax.get_yticks()])
ax.legend()
# ax.set_ylabel("Taxa de crescimento YoY (%)")
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()

fig.savefig(
    "./figs/Antecedente/" + "IBCBr" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/Antecedente/IBCBr.pdf]]

** TrÃ¡fego de veÃ­culos pesados nas estradas pedagiadas - ABCR - Dados dessazonalizados


#+BEGIN_SRC python  :results graphics file :file ./figs/Setoriais/TrafegoPedagio.pdf
df = consulta_bc(28553, ["ABCR"])


df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"TrÃ¡fego de veÃ­culos pesados nas estradas pedagiadas\nDados dessazonalizados",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/TrafegoPedagio" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/TrafegoPedagio.pdf]]


* Dados de alta frequÃªncia

** Bloomberg adaptado ao COVID-19 ([[https://www.bloomberg.com/news/articles/2020-11-13/alternative-data-show-activity-crashes-as-virus-resurges-chart][Link]])

** Google Reports: Brasil

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/GoogleReport_Brasil.pdf
import matplotlib.dates as mdates


df = pd.read_csv(
    'https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/google_reports/mobility_report_brazil.csv',
    index_col = 'date',
    dayfirst=True
)
df = df[df['sub region 1'] == 'Total'].copy(deep=True)
df.drop(['country', 'sub region 1', 'sub region 2'], axis = 'columns', inplace=True)
df.index.name=''
df.index = pd.to_datetime(df.index)
df.columns = [
    'Varejo e recreaÃ§Ã£o',
    'Mercados e FarmÃ¡cias',
    'Parques',
    'EstaÃ§Ãµes de transporte pÃºblico',
    'Locais de trabalho',
    'ResidÃªncia',
]

fig, ax = plt.subplots(figsize=(8, 5))
df.rolling(7).mean().plot(
    title='RelatÃ³rio de mobilidade do google\nSemana MÃ³vel',
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento\nsocial em SP"
)

ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))

# Formatando eixos
days = mdates.DayLocator()   # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter('%b')
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter('%d/%m')

ax2 = plt.axes([0.9, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/GoogleReport_Brasil" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/GoogleReport_Brasil.pdf]]

** Apple: TendÃªncias de mobilidade

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/AppleReport_Brasil.pdf
df = pd.read_csv(
    'https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/apple_reports/applemobilitytrends.csv',
    # index_col = 'date',
    # dayfirst=True
)
df = df[df['country'] == 'Brazil'].copy(deep=True)
df = df[df['geo_type'] == 'sub-region'].copy(deep=True)
df = df[df['transportation_type'] == 'driving'].copy(deep=True)
df.drop([
    'country',
    'geo_type',
    'transportation_type',
    'sub-region',
    'alternative_name',
], axis = 'columns', inplace=True)
df.set_index('region', inplace=True)
df.index.name=''
df = df.transpose().bfill()
df.index = pd.to_datetime(df.index)

fig, ax = plt.subplots(figsize=(8, 5))
df.rolling(7).mean().plot(
    title=f'RelatÃ³rio de mobilidade da Apple: DireÃ§Ã£o\nSemana MÃ³vel - {df.index[0]: %d/%b/%Y} = 100',
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento\nsocial em SP"
)

ax.legend(
    loc='upper center',
    bbox_to_anchor=(0.5, -0.05),
    ncol=4
)

# Formatando eixos
days = mdates.DayLocator()   # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter('%b')
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter('%d/%m')

ax2 = plt.axes([0.9, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/AppleReport_Brasil" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/AppleReport_Brasil.pdf]]

** Waze: $\Delta \%$ Km

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/Waze_Brasil.pdf
df = pd.read_csv(
    'https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/waze_reports/Waze_Country-Level_Data.csv',
    index_col = 'Date',
    dayfirst=True
)
df = df[df['Country'] == 'Brazil'].copy(deep=True)
df.index.name=''
df.index = pd.to_datetime(df.index)

fig, ax = plt.subplots(figsize=(8, 5))
df.rolling(7).mean().plot(
    title='Waze: MudanÃ§a percentual de Kilometros andados\nSemana MÃ³vel',
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento\nsocial em SP"
)

ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))

# Formatando eixos
days = mdates.DayLocator()   # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter('%b')
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter('%d/%m')

ax2 = plt.axes([0.9, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/Waze_Brasil" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/Waze_Brasil.pdf]]

** TomTom: Congestionamento

#+BEGIN_SRC python :results graphics file :file ./figs/Granulares/TomTom_Brasil.pdf
df = pd.read_csv(
    'https://raw.githubusercontent.com/ActiveConclusion/COVID19_mobility/master/tomtom_reports/tomtom_trafic_index.csv',
    index_col = 'date',
    dayfirst=True
)
df = df[df['country'] == 'Brazil'].copy(deep=True)
df.index.name=''
df.index = pd.to_datetime(df.index)

df['Capitais'] = df['city']
df['VariaÃ§Ã£o do congestionamento'] = df['diffRatio'].rolling(7).mean()

df = df[[
    'Capitais',
    'VariaÃ§Ã£o do congestionamento'
]].dropna()
df['Capitais'] = df['Capitais'].astype('category')
df = pd.pivot(df, columns='Capitais')
df.columns = df.columns.get_level_values(1)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title='TomTom: VariaÃ§Ã£o percentual do congestionamento\nem relaÃ§Ã£o a 2019 - Semana MÃ³vel',
    ax=ax,
    lw=1.5,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento\nsocial em SP"
)

ax.legend(
    loc="center left",
    bbox_to_anchor=(1, 0.5),
    title = 'Capitais',
)

# Formatando eixos
days = mdates.DayLocator()   # every day
months = mdates.MonthLocator()  # every month
m_fmt = mdates.DateFormatter('%b')
#
# format the ticks
ax.xaxis.set_major_locator(months)
ax.xaxis.set_major_formatter(m_fmt)
# ax.xaxis.set_minor_locator(days)
ax.format_xdata = mdates.DateFormatter('%d/%m')

ax2 = plt.axes([0.7, 0.675, 0.2, 0.2])

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.autofmt_xdate()

sns.despine()
plt.close()

fig.savefig(
    "./figs/Granulares/TomTom_Brasil" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Granulares/TomTom_Brasil.pdf]]

* Atividade


** Baixando dados e criando nomes :ignore:
#+BEGIN_SRC sh :dir ./raw/ContasNacionais/ :exports none :eval no
wget -N --backups=1 ftp://ftp.ibge.gov.br/Contas_Nacionais/Contas_Nacionais_Trimestrais/Tabelas_Completas/Tab_Compl_CNT.zip
unzip -o Tab_Compl_CNT.zip
mv *.xls Tab_Compl_CNT.xlsx
#+END_SRC

#+BEGIN_SRC python
Colunas = [
    "Agropecuaria",
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria",
    "Comercio",
    "Transporte, armazenagem e correio",
    "Informacao e comunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
    "VA",
    "PIB",
    "Consumo das Familias",
    "Consumo do Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Agropecuaria = ['Agropecuaria']

Industria = [
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria"
]

Servicos = [
    "Comercio",
    "Transporte, armazenagem e correio",
    "Informacao e comunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
]

Demanda = [
    "Consumo das Familias",
    "Consumo do Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Oferta = [
    'Agropecuaria',
    "Total Industria",
    "Total Servicos",
]

df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Val encad preÃ§os 95 com ajuste', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
#+END_SRC

#+RESULTS:
:results:
:end:

** Trimestre Contra trimestre imediatamente anterior

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/PIB.pdf
fig = plt.figure(figsize=(9, 4))
ax = plt.axes()
ax2 = plt.axes([0.15, 0.6, 0.2, 0.2])

suptitle = "Taxa de crescimento"
title = "Trimestre contra trimestre anterior"


df["PIB"].pct_change()["2019":].plot(
    ax=ax,
    color="darkblue",
    kind="bar",
    edgecolor="black",
    lw=1.5,
)
ax.axhline(y=0, ls="-", color="black")

plt.suptitle(suptitle, color="black", weight="bold")
ax.set_title(title, color="black")

# ax.text(0.95, -0.2, 'Fonte: IBGE',
#         verticalalignment='bottom', horizontalalignment='right',
#         transform=ax.transAxes,
#         color='black', fontsize=10)

# ax.text(0.6, -0.2, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
#         verticalalignment='bottom', horizontalalignment='right',
#         transform=ax.transAxes,
#         color='black', fontsize=10)

# sns.set_style("white")
sns.set_context("paper", font_scale=1.2)
sns.despine()
ax.tick_params(axis="x", colors="black")
ax.tick_params(axis="y", colors="black")
ax.yaxis.label.set_color("black")
ax.xaxis.label.set_color("black")
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: "{:.1%}".format(y)))
# ax.set_xticklabels(ax.get_xticklabels(), rotation=0)
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

fig.savefig(
    "./figs/PIB/PIB.pdf",
    dpi=300,
    bbox_inches="tight",
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/PIB.pdf]]

** Trimestre Contra mesmo trimestre do ano anterior

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/PIB_YoY.pdf
fig = plt.figure(figsize=(9,4))
ax = plt.axes()
ax2 = plt.axes([0.15,0.6,0.2,0.2])

suptitle = 'Taxa de crescimento'
title = 'Trimestre contra mesmo trimestre do ano anterior'


df['PIB'].pct_change(4)["2019":].plot(ax=ax, color='darkblue', kind='line')
ax.axhline(y=0, ls='--', color='black')

plt.suptitle(suptitle, color='black', weight = 'bold')
ax.set_title(title, color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
# ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

fig.savefig('./figs/PIB/PIB_YoY.pdf', dpi=300)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/PIB_YoY.pdf]]

** AgropecuÃ¡ria

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Agropecuaria.pdf
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Agropecuaria].pct_change().tail(4).plot(kind='bar', ax=ax, color='darkblue')

plt.suptitle('Agricultura', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

fig.savefig(
    './figs/PIB/Agropecuaria.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Agropecuaria.pdf]]

** IndÃºstria

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Industria.pdf
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Industria].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('IndÃºstria', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Industria.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Industria.pdf]]


** ServiÃ§os

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Servicos.pdf
fig, ax = plt.subplots(figsize=(8,5))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Servicos].pct_change().tail(4).plot(kind='bar', ax=ax)
lgd = ax.legend(
    loc='center left',
    bbox_to_anchor=(1, 0.5)
)


plt.suptitle('ServiÃ§os', color='black', weight = 'bold')

ax.axhline(y=0, color='gray', linestyle='--', lw=2)

ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Servicos.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Servicos.pdf]]

** Demanda

#+BEGIN_SRC python   :results graphics file :file ./figs/PIB/Demanda.pdf
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Demanda + ['PIB']].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('Demanda', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Demanda.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Demanda.pdf]]

** Oferta


#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Oferta.pdf
fig, ax = plt.subplots(figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


df[Oferta + ['PIB']].pct_change().tail(4).plot(kind='bar', ax=ax)

plt.suptitle('Oferta', color='black', weight = 'bold')
ax.axhline(y=0, color='gray', linestyle='--', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('Trimestre contra trimestre anterior', color='black')

ax.text(0.95, -0.2, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.2, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

#sns.set_style("white")
sns.set_context('paper', font_scale=1.2)
sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
plt.close()
fig.savefig(
    './figs/PIB/Oferta.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
    )
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Oferta.pdf]]


** ContribuiÃ§Ã£o para variaÃ§Ã£o: Demanda

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Contrib_Demanda.pdf
fig, ax = plt.subplots(figsize=(8,5))
ax2 = fig.add_axes([0.15,0.7,0.2,0.2])

df[Demanda].diff().apply(lambda x: x/(df["PIB"].shift())).tail(4).plot(
    kind = 'bar',
    stacked = True,
    ax = ax,
    color = (
        "tomato",
        "darkred",
        "darkslateblue",
        "tan",
        "khaki"
    ),
    width = 0.75,
    edgecolor='black'
)
plt.suptitle('Demanda', color='black', weight = 'bold')
ax.axhline(y=0, color='black', linestyle='-', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('ContribuiÃ§Ã£o para variaÃ§Ã£o do PIB', color='black')

ax.text(0.95, -0.125, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.125, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Contrib_Demanda.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Contrib_Demanda.pdf]]

** ContribuiÃ§Ã£o para variaÃ§Ã£o: Oferta

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Contrib_Oferta.pdf
fig, ax = plt.subplots(1,1,figsize=(9,4))
ax2 = fig.add_axes([0.15,0.6,0.2,0.2])


#df["PIB"].pct_change().tail(12).plot(ax = ax, kind = 'line', legend = True, color = 'black')
df[Oferta].diff().apply(lambda x: x/(df["VA"].shift())).tail(4).plot(
    kind = 'bar',
    stacked = True,
    ax = ax,
    color = (
        "green",
    #    "darkred",
        "darkslateblue",
        "tan",
    #    "khaki"
    ),
    cmap="Set1",
    width = 0.75,
    edgecolor='black'
)

plt.suptitle('Oferta', color='black', weight = 'bold')
ax.axhline(y=0, color='black', linestyle='-', lw=2)
#ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))


ax.set_title('ContribuiÃ§Ã£o para variaÃ§Ã£o do valor adicionado', color='black')

ax.text(0.95, -0.125, 'Fonte: IBGE',
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

ax.text(0.6, -0.125, 'Atualizado em {}. Ãšltimo dado disponÃ­vel: {}'.format(dt.now().strftime("%d/%m/%Y"), df.index[-1]),
        verticalalignment='bottom', horizontalalignment='right',
        transform=ax.transAxes,
        color='black', fontsize=10)

sns.despine()
ax.tick_params(axis='x', colors='black')
ax.tick_params(axis='y', colors='black')
ax.yaxis.label.set_color('black')
ax.xaxis.label.set_color('black')
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: '{:.1%}'.format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')
fig.savefig(
    './figs/PIB/Contrib_Oferta.pdf',
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
    )
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Contrib_Oferta.pdf]]


** ContribuiÃ§Ã£o para variaÃ§Ã£o: ServiÃ§os

#+BEGIN_SRC python  :results graphics file :file ./figs/PIB/Contrib_Servicos.pdf
fig, ax = plt.subplots(1, 1, figsize=(9, 4))
ax2 = fig.add_axes([0.15, 0.6, 0.2, 0.2])


# df["PIB"].pct_change().tail(12).plot(ax = ax, kind = 'line', legend = True, color = 'black')
df[Servicos].drop(["Total Servicos"], axis="columns").diff().apply(
    lambda x: x / (df["Total Servicos"].shift())
).tail(4).plot(
    kind="bar",
    stacked=True,
    ax=ax,
    color=(
        "green",
        "darkred",
        "darkslateblue",
        "tan",
        "khaki",
        "gray",
        "orange",
    ),
    cmap="Set1",
    width=0.75,
    edgecolor="black",
)

plt.suptitle("ServiÃ§os", color="black", weight="bold")
ax.axhline(y=0, color="black", linestyle="-", lw=2)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))


ax.set_title("ContribuiÃ§Ã£o para variaÃ§Ã£o", color="black")

ax.text(
    0.95,
    -0.125,
    "Fonte: IBGE",
    verticalalignment="bottom",
    horizontalalignment="right",
    transform=ax.transAxes,
    color="black",
    fontsize=10,
)

ax.text(
    0.6,
    -0.125,
    "Atualizado em {}. Ãšltimo dado disponÃ­vel: {}".format(
        dt.now().strftime("%d/%m/%Y"), df.index[-1]
    ),
    verticalalignment="bottom",
    horizontalalignment="right",
    transform=ax.transAxes,
    color="black",
    fontsize=10,
)

sns.despine()
ax.tick_params(axis="x", colors="black")
ax.tick_params(axis="y", colors="black")
ax.yaxis.label.set_color("black")
ax.xaxis.label.set_color("black")
ax.yaxis.set_major_formatter(FuncFormatter(lambda y, _: "{:.1%}".format(y)))
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")
fig.savefig(
    "./figs/PIB/Contrib_Servicos.pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Contrib_Servicos.pdf]]

** Acumulado no ano (sem ajuste)

*** Carregano dados :ignore:

#+BEGIN_SRC python :exports none
Colunas = [
    "Agropecuaria",
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria",
    "Comercio",
    "Transporte, armazenagem\ne correio",
    "Informacao e\ncomunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
    "VA",
    "Imposto",
    "PIB",
    "Consumo\ndas Familias",
    "Consumo\ndo Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Agropecuaria = ['Agropecuaria']

Industria = [
    "Industria Extrativa",
    "Industria de Transformacao",
    "Eletricidade e agua",
    "Construcao",
    "Total Industria"
]

Servicos = [
    "Comercio",
    "Transporte, armazenagem\ne correio",
    "Informacao e\ncomunicacao",
    "Atividades Financeiras",
    "Atividades Imobiliarias",
    "Outras atividades",
    "ADM, defesa, etc",
    "Total Servicos",
]

Demanda = [
    "Consumo\ndas Familias",
    "Consumo\ndo Governo",
    "FBCF",
    "Exportacao",
    "Importacao"
]

Oferta = [
    'Agropecuaria',
    "Total Industria",
    "Total Servicos",
]

df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
#+END_SRC

#+RESULTS:
:results:
:end:

*** ServiÃ§os

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Servicos_Acum.pdf
df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
last = str(df.index.to_list()[-1]).split(' ')[0]
df = df[last:][Servicos].transpose().sort_values('2020-10-01', ascending=False)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em relaÃ§Ã£o ao\nmesmo perÃ­odo do ano anterior",
    ax=ax,
    lw=2.5,
    legend = False,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax.axhline(y=0, ls='-', lw=1.0, color='black')

add_value_labels(ax)

ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/Servicos_Acum" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Servicos_Acum.pdf]]

*** ServiÃ§os (comparaÃ§Ã£o com ano anterior)

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Servicos_Acum_Comparativo.pdf
df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
df.index = df.index.to_timestamp()

last = str(df.index.to_list()[-1]).split(' ')[0]
previous = str(df.index.to_list()[-5]).split(' ')[0]
df = df.loc[[previous, last],:]
df = df[Servicos].transpose().sort_values('2020-10-01', ascending=False)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em relaÃ§Ã£o ao\nmesmo perÃ­odo do ano anterior",
    ax=ax,
    lw=2.5,
    legend = False,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax.axhline(y=0, ls='-', lw=1.0, color='black')

add_value_labels(ax)

ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/Servicos_Acum_Comparativo" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Servicos_Acum_Comparativo.pdf]]

*** Demanda

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Demanda_Acum.pdf
df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
# df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
last = str(df.index.to_list()[-1]).split(' ')[0]
df = df[last:][Demanda].transpose().sort_values('2020-10-01', ascending=False)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em relaÃ§Ã£o ao\nmesmo perÃ­odo do ano anterior",
    ax=ax,
    lw=2.5,
    legend = False,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax.axhline(y=0, ls='-', lw=1.0, color='black')
ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/Demanda_Acum" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Demanda_Acum.pdf]]

*** Demanda (comparaÃ§Ã£o com ano anterior)

#+BEGIN_SRC python :results graphics file :file ./figs/PIB/Demanda_Acum_Comparativo.pdf
df = pd.read_excel('./raw/ContasNacionais/Tab_Compl_CNT.xlsx', header=3, sheet_name='Acum. em 4 trimestres', index_col=0)
df.index = df.index.str.replace('.', 'Q').str.replace('IV', '4').str.replace('III', '3').str.replace('II', '2').str.replace('I', '1')
df.index = pd.PeriodIndex(df.index, freq='Q')
df.columns = Colunas
# df["Importacao"] = -df["Importacao"]
df.index = df.index.to_timestamp()
last = str(df.index.to_list()[-1]).split(' ')[0]
previous = str(df.index.to_list()[-5]).split(' ')[0]
df = df.loc[[previous, last],:]
df = df[Demanda].transpose().sort_values(last, ascending=False)

df.columns = [previous[:4], last[:4]]
fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa (%) acumulada no ano em relaÃ§Ã£o ao\nmesmo perÃ­odo do ano anterior",
    ax=ax,
    lw=2.5,
    legend = False,
    kind = 'bar', edgecolor='black', width=.8,
    color = ('teal', 'darkred')
)
ax.legend()
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax.axhline(y=0, ls='-', lw=1.0, color='black')
ax.set_xticklabels(ax.get_xticklabels(), rotation=0)

add_value_labels(ax)

ax2 = plt.axes([0.1375, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/PIB/Demanda_Acum_Comparativo" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/PIB/Demanda_Acum_Comparativo.pdf]]

* CrÃ©dito
#+begin_src python
start_year = '2019-01-01'
#+end_src

#+RESULTS:
:results:
:end:

** Endividamento das famÃ­lias

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/EndividamentoFamilias.pdf
titulo = "Endividamento das famÃ­lias\nTotal e Exceto crÃ©dito habitacional"
porcentagem = True
unidade = "renda acum.\nÃºltimos 12 meses"
df = pd.concat(
    [
        consulta_bc(19882, ["Total"]),
        consulta_bc(20400, ["Exceto crÃ©dito habitacional"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ""
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df[start_year:].plot(
    title=titulo,
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento\nsocial em SP"
)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(["{:,.0f}".format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f"R$ {unidade}")
else:
    ax.set_yticklabels(["{:,.2%}".format(x / 100) for x in ax.get_yticks()])
    ax.set_ylabel(f"em % {unidade}")
ax2 = plt.axes([0.9, 0.6, 0.2, 0.2])


ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()
plt.close()

fig.savefig(
    "./figs/Credito/EndividamentoFamilias" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/EndividamentoFamilias.pdf]]


** Saldo Pessoal JurÃ­dica - NÃ­vel
     
#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoPJ.pdf
titulo = "Saldo Pessoa jurÃ­dica"
porcentagem=False
unidade="MilhÃµes"
df = pd.concat(
    [
        consulta_bc(20543, ["Saldo Pessoa jurÃ­dica livre"]),
        consulta_bc(20594, ["Saldo Pessoa jurÃ­dica direcionados"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ''
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    lw=2, 
)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='InÃ­cio isolamento\nsocial em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else: 
    ax.set_yticklabels(['{:,.2%}'.format(x/100) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.close()

fig.savefig(
    './figs/Credito/SaldoPJ' +   '.pdf',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoPJ.pdf]]



** Saldo Pessoa JurÃ­dica - em % do PIB
#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoPJ_PIB.pdf
titulo = "Saldo Pessoa jurÃ­dica\nem % PIB"
porcentagem = True
unidade = "PIB"
df = pd.concat(
    [
        consulta_bc(20626, ["Recursos livres"]),
        consulta_bc(20629, ["Recursos direcionados"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ""
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df[start_year:].plot(
    title=titulo,
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento\nsocial em SP"
)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(["{:,.0f}".format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f"R$ {unidade}")
else:
    ax.set_yticklabels(["{:,.2%}".format(x / 100) for x in ax.get_yticks()])
    ax.set_ylabel(f"em % {unidade}")
ax2 = plt.axes([0.9, 0.6, 0.2, 0.2])


ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()
plt.close()

fig.savefig(
    "./figs/Credito/SaldoPJ_PIB" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoPJ_PIB.pdf]]

** Saldo Pessoa fÃ­sica - NÃ­vel

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoPF.pdf
titulo = "Saldo Pessoa fÃ­sica"
porcentagem = False
unidade = "MilhÃµes"
df = pd.concat(
    [
        consulta_bc(20570, ["Saldo Pessoa fÃ­sica livre"]),
        consulta_bc(20606, ["Saldo Pessoa fÃ­sica direcionados"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ""
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df[start_year:].plot(
    title=titulo,
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento\nsocial em SP"
)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(["{:,.0f}".format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f"R$ {unidade}")
else:
    ax.set_yticklabels(["{:,.2%}".format(x / 100) for x in ax.get_yticks()])
    ax.set_ylabel(f"em % {unidade}")
ax2 = plt.axes([0.9, 0.6, 0.2, 0.2])


ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()
plt.close()

fig.savefig(
    "./figs/Credito/SaldoPF" + ".pdf", dpi=300, bbox_inches="tight", pad_inches=0
)
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoPF.pdf]]


** Saldo Pessoa fÃ­sica - em % do PIB

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoPF_PIB.pdf
titulo = "Saldo Pessoa fÃ­sica\nem % PIB"
porcentagem = True
unidade = "PIB"
df = pd.concat(
    [
        consulta_bc(20627, ["Recursos livres"]),
        consulta_bc(20630, ["Recursos direcionados"]),
    ],
    axis=1,
)
df = df[start_year:]
df.index.name = ""
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df[start_year:].plot(
    title=titulo,
    ax=ax,
    lw=2,
)
ax.axvline(
    x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento\nsocial em SP"
)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(["{:,.0f}".format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f"R$ {unidade}")
else:
    ax.set_yticklabels(["{:,.2%}".format(x / 100) for x in ax.get_yticks()])
    ax.set_ylabel(f"em % {unidade}")
ax2 = plt.axes([0.9, 0.6, 0.2, 0.2])


ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()
plt.close()

fig.savefig(
    "./figs/Credito/SaldoPF_PIB" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoPF_PIB.pdf]]


** CrÃ©dito ampliado em % do Total

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/SaldoCreditoAmpliado_Total.pdf
titulo = "Saldo CrÃ©dito Ampliado\nem % do Total"
porcentagem=True
unidade="do Total"
df = pd.concat(
    [
        consulta_bc(28183, ["Setor nÃ£o financeiro"]),
        consulta_bc(28196, ["Governo geral"]),
        consulta_bc(28203, ["Empresas e FamÃ­lias"]),
    ],
    axis=1,
)
df = df[start_year:]
df = df.apply(pd.to_numeric, errors='coerce')
df["Total"] = df.sum(axis=1)
df = df.apply(lambda x: x/df["Total"]).drop(["Total"], axis='columns')

df.index.name = ''


fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    kind='bar', stacked=True, edgecolor='black',
    lw=2,
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
#ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='InÃ­cio isolamento\nsocial em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else:
    ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.close()

fig.savefig(
    './figs/Credito/SaldoCreditoAmpliado_Total' + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/SaldoCreditoAmpliado_Total.pdf]]

** Indicadores de aprovaÃ§Ã£o de crÃ©dito

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/PTC.pdf
titulo = "Indicadores de aprovaÃ§Ã£o de crÃ©dito\nAprovaÃ§Ãµes Esperadas - Observadas"
porcentagem=False
unidade="Pontos"
df = pd.concat(
    [
        consulta_bc(21396, ["Grandes - Esperadas"]),
        consulta_bc(21397, ["Grandes - Observadas"]),
        consulta_bc(21398, ["Micro - Esperadas"]),
        consulta_bc(21399, ["Micro - Observadas"]),
        consulta_bc(21400, ["Consumo - Esperadas"]),
        consulta_bc(21401, ["Consumo - Observadas"]),
        consulta_bc(21402, ["Habitacional - Esperadas"]),
        consulta_bc(21403, ["Habitacional - Observadas"]),
    ],
    axis=1,
)
df["Grandes Empresas"] = df["Grandes - Esperadas"] - df["Grandes - Observadas"]
df["Micro, Pequenas e MÃ©dias Empresas"] = df["Micro - Esperadas"] - df["Micro - Observadas"]
df["Consumo"] = df["Consumo - Esperadas"] - df["Consumo - Observadas"]
df["Habitacional"] = df["Habitacional - Esperadas"] - df["Habitacional - Observadas"]
df = df[["Grandes Empresas", "Micro, Pequenas e MÃ©dias Empresas", "Consumo", "Habitacional"]]

df = interpolator(df)
df = df[start_year:]

df.index.name = ''

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = titulo,
    ax = ax,
    # kind='bar', stacked=True, edgecolor='black',
    lw=2,
)
# ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
ax.set_ylabel('Esperadas - Observadas (Pontos)')
ax.axhline(y = 0, color='black', ls='-', lw=1,)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='InÃ­cio isolamento\nsocial em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
# if porcentagem == False:
#     ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
#     ax.set_ylabel(f'{unidade}')
# else:
#     ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
#     ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.9,0.6,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.close()

fig.savefig(
    './figs/Credito/PTC' + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/PTC.pdf]]

** Recolhimentos compulsÃ³rios de instituiÃ§Ãµes financeiras

#+BEGIN_SRC python :results graphics file :file ./figs/Credito/Recolhimentos_Total.pdf
titulo = "Recolhimentos compulsÃ³rios de instituiÃ§Ãµes financeira\nSaldo Total"
porcentagem=False
unidade="u.m.c (mil)"

df = consulta_bc(17633, ["Saldo Total"])

df = df[start_year:]
df = df.apply(pd.to_numeric, errors='coerce')

df.index.name = ''


fig, ax = plt.subplots(figsize=(8,5))
df[start_year:].plot(
    title = titulo,
    ax = ax,
    lw=2,
)
ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='InÃ­cio isolamento\nsocial em SP')
if porcentagem == False:
    ax.set_yticklabels(['{:,.0f}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'R$ {unidade}')
else:
    ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
    ax.set_ylabel(f'em % {unidade}')
ax2 = plt.axes([.135,0.135,0.2,0.2])


ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')


sns.despine()
plt.close()

fig.savefig(
    './figs/Credito/Recolhimentos_Total' + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Credito/Recolhimentos_Total.pdf]]

* Ãndices de atividade setoriais


** Pesquisa Mensal do ComÃ©rcio (PMC)

#+BEGIN_SRC python  :file ./figs/Setoriais/PMC_IBGE.pdf :results graphics file
df = pd.concat(
    [
        consulta_bc(28473, ["Total"]),
        consulta_bc(28474, ["CombustÃ­veis e lubrificantes"]),
        consulta_bc(28475, ["Hipermercados, supermercados, produtos alimentÃ­cios, bebidas e fumo"]),
        consulta_bc(28477, ["Tecido, vestuÃ¡rio e calÃ§ado"]),
        consulta_bc(28478, ["MÃ³veis e eletrodomÃ©sticos - Brasil - Dados dessazonalizados"]),
        consulta_bc(28479, ["AutomÃ³veis, motocicletas, partes e peÃ§as"]),
        consulta_bc(28480, ["Artigos farmacÃªuticos, mÃ©dicos, ortopÃ©dicos, perfumaria e cosmÃ©ticos"]),
        consulta_bc(28481, ["Livros, jornais, revistas e papelaria"]),
        consulta_bc(28482, ["Equipamentos e materiais para escritÃ³rio e comunicaÃ§Ã£o"]),
        consulta_bc(28483, ["Outros artigos de uso pessoal e domÃ©stico"]),
        consulta_bc(28484, ["Material de construÃ§Ã£o"]),
        consulta_bc(28485, ["ComÃ©rcio ampliado"]),
    ],
    axis=1,
)
df.index.name = ''
for col in df:
    df[col] = df[col].apply(lambda x: (100*x)/df[col][base])

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = f"Pesquisa Mensal do ComÃ©rcio (PMC)\nVolume de Vendas Dessazonalizado\n{base} = 100",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='InÃ­cio isolamento social em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.close()

fig.savefig(
    './figs/Setoriais/PMC_IBGE' + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PMC_IBGE.pdf]]


** Pesquisa Industrial Mensal (PIM)

#+BEGIN_SRC python  :file ./figs/Setoriais/PIM_IBGE.pdf :results graphics file
df = pd.concat(
    [
        consulta_bc(28503, ["Geral"]),
        consulta_bc(28504, ["Extrativa mineral"]),
        consulta_bc(28505, ["IndÃºstria de transformaÃ§Ã£o"]),
        consulta_bc(28506, ["Bens de capital"]),
        consulta_bc(28507, ["Bens intermediÃ¡rios"]),
        consulta_bc(28508, ["Bens de consumo"]),
        consulta_bc(28509, ["Bens de consumo durÃ¡veis"]),
        consulta_bc(28510, ["SemidurÃ¡veis e nÃ£o durÃ¡veis"]),
        consulta_bc(28511, ["Insumos da construÃ§Ã£o civil"]),
    ],
    axis=1,
)
df.index.name = ""
for col in df:
    df[col] = df[col].apply(lambda x: (100 * x) / df[col][base])

df = df[start_year:]
df = interpolator(df)


fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Pesquisa Industrial Mensal (PIM)\nSeÃ§Ãµes de atividades desazonalizadas\n{base} = 100",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/PIM_IBGE" + ".pdf", dpi=300, bbox_inches="tight", pad_inches=0
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PIM_IBGE.pdf]]


** Pesquisa Mensal de ServiÃ§os (PMS)
*** Receita nominal sem ajuste sazonal
#+BEGIN_SRC python  :results graphics file :file ./figs/Setoriais/PMS_IBGE.pdf
file_name = "PMS_IBGE"
df = pd.concat(
    [
        consulta_bc(21637, ["Total"]),
        consulta_bc(21638, ["Prestados Ã s famÃ­lias"]),
        consulta_bc(21639, ["InformaÃ§Ã£o e comunicaÃ§Ã£o"]),
        consulta_bc(21640, ["Profissionais, Administrativos e Complementares"]),
        consulta_bc(21641, ["Transportes, ServiÃ§os auxiliares e Correio"]),
        consulta_bc(21642, ["Outros"]),
    ],
    axis=1,
)
df.index.name = ""

for col in df:
    df[col] = df[col].apply(lambda x: (100 * x) / df[col].loc[base])

df = df[start_year:]
df = interpolator(df)
df.columns = [
    "Total Geral",
    "ServiÃ§os prestados Ã s FamÃ­lias",
    "ServiÃ§os de informaÃ§Ã£o e comunicaÃ§Ã£o",
    "ServiÃ§os Profissionais, Administrativos e Complementares",
    "Transportes, ServiÃ§os auxiliares aos transportes e Correio",
    "Outros serviÃ§os",
]

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Pesquisa Mensal de ServiÃ§os (PMS)\nReceita nominal\n{base} = 100",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/PMS_IBGE" + ".pdf", dpi=300, bbox_inches="tight", pad_inches=0
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PMS_IBGE.pdf]]

*** Volume com ajuste sazonal


#+begin_src R :exports none
df <- get_sidra(
  api = "/t/6443/n1/all/v/8677/p/all/c11046/40312/c12355/31399,31426,106869,106874,106876,107071/d/v8677%201"
) %>%
  select( "MÃªs (CÃ³digo)", "Atividades de serviÃ§os", "Valor") %>%
  mutate(Data =  paste0(`MÃªs (CÃ³digo)`, "01")) %>%
  mutate(Data = as.Date(Data, format="%Y%m%d")) %>%
  select(-c(`MÃªs (CÃ³digo)`)) %>%
  pivot_wider(names_from = "Atividades de serviÃ§os", values_from = Valor)

names(df) <- c(
  "Data",
  "Profissionais, Administrativos e Complementares",
  "Outros",
  "Prestados Ã s famÃ­lias",
  "InformaÃ§Ã£o e comunicaÃ§Ã£o",
  "Transportes, ServiÃ§os auxiliares e Correio",
  "Total"
  )
write.csv(
  df,
  './clean/IBGE/PMS_volume_dessazonalizada.csv',
  row.names=FALSE
)
#+end_src

#+RESULTS:
:results:
All others arguments are desconsidered when 'api' is informed
:end:

#+BEGIN_SRC python  :results graphics file :file ./figs/Setoriais/PMS_vol_dessazonalizada.pdf
df = pd.read_csv(
    "./clean/IBGE/PMS_volume_dessazonalizada.csv", index_col="Data", parse_dates=True
)

df.index.name = ""

for col in df:
    df[col] = df[col].apply(lambda x: (100 * x) / df[col].loc[base])

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Pesquisa Mensal de ServiÃ§os (PMS)\nÃndice de Volume de serviÃ§os dessazonalizado\n{base} = 100",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/PMS_vol_dessazonalizada" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PMS_vol_dessazonalizada.pdf]]

*** Volume com ajuste sazonal (em relaÃ§Ã£o ao mÃªs anterior)


#+begin_src R :exports none
df <- get_sidra(
  api = "/t/6443/n1/all/v/8677/p/all/c11046/40312/c12355/31399,31426,106869,106874,106876,107071/d/v8677%201"
) %>%
  select( "MÃªs (CÃ³digo)", "Atividades de serviÃ§os", "Valor") %>%
  mutate(Data =  paste0(`MÃªs (CÃ³digo)`, "01")) %>%
  mutate(Data = as.Date(Data, format="%Y%m%d")) %>%
  select(-c(`MÃªs (CÃ³digo)`)) %>%
  pivot_wider(names_from = "Atividades de serviÃ§os", values_from = Valor)

names(df) <- c(
  "Data",
  "Profissionais, Administrativos e Complementares",
  "Outros",
  "Prestados Ã s famÃ­lias",
  "InformaÃ§Ã£o e comunicaÃ§Ã£o",
  "Transportes, ServiÃ§os auxiliares e Correio",
  "Total"
  )
write.csv(
  df,
  './clean/IBGE/PMS_volume_dessazonalizada.csv',
  row.names=FALSE
)
#+end_src

#+RESULTS:
:results:
All others arguments are desconsidered when 'api' is informed
:end:

#+BEGIN_SRC python  :results graphics file :file ./figs/Setoriais/PMS_vol_dessazonalizada_diff.pdf
df = pd.read_csv(
    "./clean/IBGE/PMS_volume_dessazonalizada.csv", index_col="Data", parse_dates=True
)

df.index.name = ""

for col in df:
    df[col] = df[col].apply(lambda x: (100 * x) / df[col].loc[base])

df = df["2020-01-01":]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.diff().plot(
    title=f"Pesquisa Mensal de ServiÃ§os (PMS)\nÃndice de Volume de serviÃ§os dessazonalizado\nComparado ao mÃªs anterior",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.axhline(y=0, color="black", ls="-", lw=1)
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Setoriais/PMS_vol_dessazonalizada_diff" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Setoriais/PMS_vol_dessazonalizada_diff.pdf]]

* Emprego

** Rendimento mÃ©dio real habitual das pessoas ocupadas


#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/RMHPO.pdf
df = pd.concat(
    [
        consulta_bc(24383, ["Com carteira"]),
        consulta_bc(24384, ["Sem carteira"]),
        consulta_bc(24385, ["Setor privado"]),
        consulta_bc(24386, ["Setor pÃºblico"]),
        consulta_bc(24387, ["Conta prÃ³pria"]),
        consulta_bc(24388, ["Empregadores"]),
    ],
    axis=1,
)

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Rendimento mÃ©dio real habitual\ndas pessoas ocupadas - PNADC",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/RMHPO" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/RMHPO.pdf]]

** Massa de rendimento real efetiva e habitual de todos os trabalhos

#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/MRR_Efetiva_Habitual.pdf
df = pd.concat(
    [
        consulta_bc(28544, ["Efetiva"]),
        consulta_bc(28545, ["Habitual"]),
    ],
    axis=1,
)

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Massa de rendimento real efetiva e\nhabitual de todos os trabalhos",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/MRR_Efetiva_Habitual" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/MRR_Efetiva_Habitual.pdf]]

** Massa Salarial Ampliada DisponÃ­vel - PNADC

#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/MSAD.pdf
df = consulta_bc(22079, ["MSAD - PNADC"])

df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Massa Salarial Ampliada DisponÃ­vel PNADC",
    ax=ax,
    lw=2.5,
)
ax.set_yticklabels(["{:,.2f}".format(x / 1000) for x in ax.get_yticks()])
ax.set_ylabel('R$ BilhÃµes')
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/MSAD" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/MSAD.pdf]]

** Rendimento habitual mÃ©dio por atividade


#+BEGIN_SRC python   :tangle ./codes/pnad.py :eval no
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Mensal RHM Setor Real",
    skiprows = 11,
    usecols = "A:K",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''
df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Rendimento habitual mÃ©dio por atividade",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='InÃ­cio isolamento social em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.close()

fig.savefig(
    image_path + file_path.strip("/")[-1] + "RHM_Setor" + "_" + '.pdf',
    dpi = 300, 
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
:end:

** NÃºmero de horas trabalhadas - indÃºstria de transformaÃ§Ã£o

#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/Horas_Transformacao.pdf
df = consulta_bc(24348, ["IndÃºstria de transformaÃ§Ã£o"])

df = rebase(df, base='2020-01-01')
df = df['2019-01-01':]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"NÃºmero de horas trabalhadas - Dados dessazonalizados\nJan/2020 = 100",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/Horas_Transformacao" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/Horas_Transformacao.pdf]]

** Novo CAGED  - Por atividade (dados dessazonalizados)

#+BEGIN_SRC python :results graphics file :file ./figs/Emprego/NovoCaged_Atividade.pdf
df = pd.concat(
    [
        # consulta_bc(28784, ["Total"]),
        consulta_bc(28785, ["AgropecuÃ¡ria"]),
        consulta_bc(28786, ["IndÃºstrias extrativas"]),
        consulta_bc(28787, ["IndÃºstrias de transformaÃ§Ã£o"]),
        # consulta_bc(28788, ["SIUP"]),
        # consulta_bc(28789, ["Eletricidade e gÃ¡s"]),
        # consulta_bc(28790, ["Ãgua, esgoto, atividades de\ngestÃ£o de resÃ­duos e descontaminaÃ§Ã£o"]),
        consulta_bc(28791, ["ConstruÃ§Ã£o"]),
        consulta_bc(28792, ["ComÃ©rcio"]),
        consulta_bc(28793, ["ServiÃ§os"]),
        # consulta_bc(28794, ["Transporte, armazenamento e correios"]),
        # consulta_bc(28795, ["Alojamento e alimentaÃ§Ã£o"]),
        # consulta_bc(28796, ["InformaÃ§Ã£o e comunicaÃ§Ã£o"]),
        # consulta_bc(28797, ["Atividades financeiras e seguros"]),
        # consulta_bc(28798, ["Atividades imobiliÃ¡rias"]),
        # consulta_bc(28799, ["Atividades profissionais, cientÃ­ficas e tÃ©cnicas"]),
        # consulta_bc(28800, ["Atividades administrativas e serviÃ§os complementares"]),
        # consulta_bc(28801, ["AdministraÃ§Ã£o pÃºblica, defesa e seguridade social"]),
        consulta_bc(28802, ["EducaÃ§Ã£o"]),
        consulta_bc(28803, ["SaÃºde e serviÃ§os sociais"]),
        # consulta_bc(28804, ["Outras atividades de serviÃ§os"]),
    ],
    axis = 1
)
df.index.name = ''
df = df['2019':]

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Novo Caged por atividade - Dados dessazonalizados",
    ax = ax,
    lw = 1.5,
    edgecolor = 'black',
    kind = 'bar', stacked = True, width=0.9
)



ax.set_xticklabels(map(lambda x: line_format(x), df[start_year:].index))

ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([.9,0.7,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.close()

fig.savefig(
    './figs/Emprego/NovoCaged_Atividade.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/NovoCaged_Atividade.pdf]]



** Taxa de desocupaÃ§Ã£o

#+BEGIN_SRC python  :results graphics file :file ./figs/Emprego/TaxaDesocupacao.pdf
df = consulta_bc(24369, ["Taxa de desocupaÃ§Ã£o - PNADC"])


df = df[start_year:]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Taxa de desocupaÃ§Ã£o\nPNADC (em %)",
    ax=ax,
    lw=2.5,
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.legend(loc="center left", bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/Emprego/TaxaDesocupacao" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/Emprego/TaxaDesocupacao.pdf]]


** Desalentados e subocupados :noexport:

#+BEGIN_SRC python   :tangle ./codes/pnad.py :eval no
var = "Desalentados_Subocupados"
df = pd.read_excel(
    file_path,
    sheet_name = "Brasil Dessaz",
    skiprows = 11,
    usecols = "A,D,S,T",
    parse_date = True,
    index_col = [0]
)
df.index.name = ''
df.columns = [
    "ForÃ§a de trabalho",
    "Subocupados",
    "Desalentados"
]
df = df.apply(pd.to_numeric, errors='coerce')
df["Taxa de desalentados"] = df["Desalentados"]/df["ForÃ§a de trabalho"]
df["Taxa de Subocupados por \ninsuficiÃªncia de horas trabalhadas"] = df["Subocupados"]/df["ForÃ§a de trabalho"]
df = df[start_year:]
df = df[["Taxa de desalentados", "Taxa de Subocupados por \ninsuficiÃªncia de horas trabalhadas"]]
df = interpolator(df)

fig, ax = plt.subplots(figsize=(8,5))
df.plot(
    title = "Taxa de desalentados e subocupatos\n(em % da forÃ§a de trabalho)",
    ax = ax,
    lw = 2.5
)
ax.axvline(x = corona_sp, color='black', ls='--', lw=1, label='InÃ­cio isolamento social em SP')
ax.legend(loc='center left', bbox_to_anchor=(1, 0.5))
ax2 = plt.axes([0.135,0.135,0.2,0.2])
ax2.imshow(logo, aspect='auto', zorder=0, alpha=.5)
ax2.axis('off')

sns.despine()
plt.close()

fig.savefig(
    image_path + file_path.strip("/")[-1] + var.replace(" ", "_") + "_" + '.pdf',
    dpi = 300,
    bbox_inches='tight',pad_inches=0
    )
#+END_SRC

#+RESULTS:
:results:
:end:

* PNAD-COVID
** R trial
#+begin_src R :eval no
library(dplyr)
library(srvyr)
library(readr)
library(ggplot2)
library(Cairo)
library(cowplot)
library(magick)

logo_file <- './figs/Cecon_Logo.pdf'

pnad_covid <- read_csv("./raw/PNAD_COVID/PNAD_COVID_112020.csv", col_types = cols(.default = "d"))
mes <- "Novembro"
# ligando Pesos e filtrando Salvador
pnad_covid <- pnad_covid %>%
    as_survey_design(
        ids = UPA,
        strata = Estrato,
        weights = V1032,
        nest = TRUE
        )


# Criando colunas com VariÃ¡veis
pnad_covid <- pnad_covid %>% mutate(one = 1,
                                            Sexo = ifelse(A003 == 1, "Homem", "Mulher"),
                                            Idade = case_when(
                                                A002 %in% 15:24 ~ "15-24",
                                                A002 %in% 25:34 ~ "25-34",
                                                A002 %in% 35:49 ~ "35-49",
                                                A002 %in% 50:64 ~ "50-64",
                                                A002 > 64 ~ "65+"),
                                            Cor = case_when(
                                                A004 == 1 ~ "Branca",
                                                A004 == 2 ~ "Preta",
                                                A004 == 4 ~ "Parda"),
                                            Escolaridade = factor(case_when(
                                                A005 %in% 1:2 ~ "Sem InstruÃ§Ã£o ou Fundamental Incompleto",
                                                A005 %in% 3:4 ~ "Fundamental completo ou MÃ©dio Incompleto",
                                                A005 %in% 5:6 ~ "MÃ©dio completo ou Superior Incompleto",
                                                A005 == 7 ~ "Superior completo",
                                                A005 == 8 ~ "PÃ³s-graduaÃ§Ã£o"),
                                                levels = c( "Sem InstruÃ§Ã£o ou Fundamental Incompleto",
                                                            "Fundamental completo ou MÃ©dio Incompleto",
                                                            "MÃ©dio completo ou Superior Incompleto",
                                                            "Superior completo",
                                                            "PÃ³s-graduaÃ§Ã£o")),
                                            Tipo_emprego = factor(case_when(
                                                C007 == 1 ~ "Trabalhador domÃ©stico (empregado domÃ©stico, cuidados, babÃ¡)",
                                                C007 == 2 ~ "Militar",
                                                C007 == 3 ~ "Policial ou Bombeiro",
                                                C007 == 4 ~ "Setor privado",
                                                C007 == 5 ~ "Setor pÃºblico",
                                                C007 == 6 ~ "Empregador",
                                                C007 == 7 ~ "AutÃ´nomo (Conta prÃ³pria)"),
                                                levels = c( "Trabalhador domÃ©stico (empregado domÃ©stico, cuidados, babÃ¡)",
                                                            "Militar",
                                                            "Policial ou Bombeiro",
                                                            "Setor privado",
                                                            "Setor pÃºblico",
                                                            "Empregador",
                                                            "AutÃ´nomo (Conta prÃ³pria)")),
                                            Faixa_salario = factor(case_when(
                                                C01012 <= 1044 ~ "Menos de um salÃ¡rio mÃ­nimo",
                                                C01012 %in% c(1045:2090) ~ "Entre 1 e 2",
                                                C01012 %in% c(2091:3135) ~ "Entre 2 e 3",
                                                C01012 %in% c(3136:4180) ~ "Entre 3 e 4",
                                                C01012 %in% c(4181:5225) ~ "Entre 4 e 5",
                                                C01012 >= 5226 ~ "Mais de 5"),
                                                levels = c("Menos de um salÃ¡rio mÃ­nimo",
                                                           "Entre 1 e 2",
                                                           "Entre 2 e 3",
                                                           "Entre 3 e 4",
                                                           "Entre 4 e 5",
                                                           "Mais de 5")),
                                            domicilio_situacao = factor(case_when(
                                                F001 == 1 ~ "PrÃ³prio - jÃ¡ pago",
                                                F001 == 2 ~ "PrÃ³prio - ainda pagando" ,
                                                F001 == 3 ~ "Alugado",
                                                F001 %in% 4:6 ~ "Cedido (Por empregador, Familiar ou outro)"),
                                                levels = c("PrÃ³prio - jÃ¡ pago",
                                                           "PrÃ³prio - ainda pagando",
                                                           "Alugado",
                                                           "Cedido (Por empregador, Familiar ou outro)")),
                                            home_office = ifelse(C013 == 1, "Home Office", "Presencial"),
                                            auxilio_emergencial = ifelse(D0051 == 1, "AuxÃ­lio", "Sem auxÃ­lio")
)


############### Home office - Por sexo e cor ################### Criando dataset para conferir pessoas em Home Office
df <- pnad_covid %>%
    group_by(Sexo, Cor) %>%
    summarise(
        home_office = survey_total(C013 == 1, na.rm = TRUE),
        mao_de_obra = survey_total(C001 == 1, na.rm = TRUE)) %>%
    mutate(trab_home_office = (home_office/mao_de_obra)*100) %>%
    drop_na()# grÃ¡fico
fig <- ggplot(df, aes(fill = Cor, y = trab_home_office, x = Sexo)) +
    geom_bar(position = "dodge", stat = "identity") +
    geom_text(aes(label=sprintf("%1.2f%%",trab_home_office)),size = 3, position =position_dodge(width=0.9),
              vjust=-0.5, color = 'black',fontface='bold') +
    theme_classic() +
    theme(axis.title.x = element_text(colour = "black"),
          axis.title.y = element_text(colour = "black"),
          axis.text.y = element_text(face="bold", color="#000000",
                                     size=10),
          axis.line = element_line(colour = "black",
                                   size = 1, linetype = "solid"),
          axis.text=element_text(size=6, face="bold"),
          axis.text.x = element_text(face="bold", color="#000000", size=10),
          plot.title = element_text(colour = "black", size = 17, hjust=0.5),
          legend.position = "bottom", legend.background = element_rect(fill="ghostwhite", size=0.7, linetype="blank")) +
    labs(x = "Sexo", fill = "Cor/RaÃ§a: ", caption = "Fonte: Microdados da Pnad Covid19 - IBGE. Novembro 2020.",
         title = "Pessoas em home office, por cor/raÃ§a e sexo") +
    scale_fill_manual(values = c("#00b894","#ff7675","#0984e3","#6c5ce7")) +
    scale_y_discrete(limits=factor(0:100), breaks = c(0,10,20,30,40,50,60,70,80,90,100), name = "Percentual (%)")

fig<- ggdraw(fig) +
    draw_image(logo_file, x = .975, y = .975, hjust = 1, vjust = 1, width = 0.25, height = 0.2)
# Salvando
ggsave(plot = fig, "./figs/PNAD_COVID/home_sexo_cor.pdf",
       width = 10, height = 5, dpi = 120, units = "in",type = "cairo")

#+end_src

** PendÃªncias :noexport:
*** TODO Incluir logos
** Home office - Por sexo e cor




[[./figs/PNAD_COVID/home_sexo_cor.pdf]]

** Home office - Por Cor e Escolaridade
[[./figs/PNAD_COVID/home_edu_cor.pdf]]
** Home office - Por Cor e Idade
[[./figs/PNAD_COVID/home_sexo_idade.pdf]]

** Home office - Por Trabalho
[[./figs/PNAD_COVID/home_emprego.pdf]]

** Home office - Por faixa salarial e cor
[[./figs/PNAD_COVID/home_renda.pdf]]
** Auxilio - Faixa Salarial
[[./figs/PNAD_COVID/auxilio_renda.pdf]]
** Auxilio - Por tipo do domicilio
[[./figs/PNAD_COVID/auxilio_domicilio.pdf]]
** Auxilio - Sexo e Cor
[[./figs/PNAD_COVID/auxilio_cor_sexo.pdf]]


* RelatÃ³rio do Tesouro :noexport:



* IMF Fiscal Monitor
** Medidas fiscais em % do PIB

#+BEGIN_SRC python :results graphics file :file ./figs/IMF/FiscalMonitor_Covid.pdf
df = pd.read_excel(
    './raw/IMF/fiscal-monitor-database-oct-2020-for-webpage.xlsx',
    sheet_name='Summary.Global',
    index_col=1,
    skiprows=[0,1,2,]
)
df = df.loc[[
    # 'G20: Emerging markets',
    'Argentina',
    'Brazil',
    'China',
    'India',
    'Indonesia',
    'Mexico',
    'Russia',
    'Saudi Arabia',
    'South Africa'
],:].copy()
df = df[[
    'Above the line measures',
    'Unnamed: 3',
    'Unnamed: 4',
    'Above the line measures.1',
    'Unnamed: 15',
    'Unnamed: 16',
]]

df.columns = [
    'Gastos adicionais totais',
    'Setor de saÃºde totais',
    'Outros setores totais',
    'Gastos adicionais',
    'Setor de saÃºde',
    'Outros setores',
]
df.index.name = 'G20 - PaÃ­ses Emergentes'
df = df.sort_values(
    'Gastos adicionais',
    ascending=False
)
fig, ax = plt.subplots(figsize=(8, 5))
df[[
    # "Gastos adicionais",
    "Setor de saÃºde",
    "Outros setores",
]].plot(
    title=f"Resumo das medidas fiscais dos paÃ­ses emergentes\nem resposta Ã  pandemia COVID-19 em % do PIB",
    ax=ax,
    lw=2.5,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax2 = plt.axes([0.675, 0.55, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/IMF/FiscalMonitor_Covid" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/FiscalMonitor_Covid.pdf]]

** Medidas fiscais em % do PIB: Setor de saÃºde/Outros setores

#+BEGIN_SRC python :results graphics file :file ./figs/IMF/FiscalMonitor_Covid_ratio.pdf
df = pd.read_excel(
    './raw/IMF/fiscal-monitor-database-oct-2020-for-webpage.xlsx',
    sheet_name='Summary.Global',
    index_col=1,
    skiprows=[0,1,2,]
)
df = df.loc[[
    # 'G20: Emerging markets',
    'Argentina',
    'Brazil',
    'China',
    'India',
    'Indonesia',
    'Mexico',
    'Russia',
    'Saudi Arabia',
    'South Africa'
],:].copy()
df = df[[
    'Above the line measures',
    'Unnamed: 3',
    'Unnamed: 4',
    'Above the line measures.1',
    'Unnamed: 15',
    'Unnamed: 16',
]]

df.columns = [
    'Gastos adicionais totais',
    'Setor de saÃºde totais',
    'Outros setores totais',
    'Gastos adicionais',
    'Setor de saÃºde',
    'Outros setores',
]
df.index.name = 'G20 - PaÃ­ses Emergentes'

df["SaÃºde/Outros setores"] = df["Setor de saÃºde"]/df["Outros setores"]

df = df.sort_values(
    'SaÃºde/Outros setores',
    ascending=False
)
fig, ax = plt.subplots(figsize=(8, 5))
df[[
    "SaÃºde/Outros setores"
]].plot(
    title=f"RazÃ£o entre gastos com saÃºde e outros setores\nem resposta Ã  pandemia COVID-19",
    ax=ax,
    lw=2.5,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax.set_yticklabels(['{:,.0%}'.format(x/100) for x in ax.get_yticks()])
ax2 = plt.axes([0.675, 0.55, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/IMF/FiscalMonitor_Covid_ratio" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/FiscalMonitor_Covid_ratio.pdf]]

** Medidas fiscais em % do PIB: Setor de saÃºde/Total

#+BEGIN_SRC python :results graphics file :file ./figs/IMF/FiscalMonitor_Covid_total.pdf
df = pd.read_excel(
    './raw/IMF/fiscal-monitor-database-oct-2020-for-webpage.xlsx',
    sheet_name='Summary.Global',
    index_col=1,
    skiprows=[0,1,2,]
)
df = df.loc[[
    # 'G20: Emerging markets',
    'Argentina',
    'Brazil',
    'China',
    'India',
    'Indonesia',
    'Mexico',
    'Russia',
    'Saudi Arabia',
    'South Africa'
],:].copy()
df = df[[
    'Above the line measures',
    'Unnamed: 3',
    'Unnamed: 4',
    'Above the line measures.1',
    'Unnamed: 15',
    'Unnamed: 16',
]]

df.columns = [
    'Gastos adicionais totais',
    'Setor de saÃºde totais',
    'Outros setores totais',
    'Gastos adicionais',
    'Setor de saÃºde',
    'Outros setores',
]
df.index.name = 'G20 - PaÃ­ses Emergentes'

df["SaÃºde/Gastos adicionais"] = df["Setor de saÃºde"]/df["Gastos adicionais"]

df = df.sort_values(
    'SaÃºde/Gastos adicionais',
    ascending=False
)
fig, ax = plt.subplots(figsize=(8, 5))
df[[
    "SaÃºde/Gastos adicionais"
]].plot(
    title=f"RazÃ£o entre gastos com saÃºde e total dos gastos adicionais\nem resposta Ã  pandemia COVID-19",
    ax=ax,
    lw=2.5,
    kind = 'bar', edgecolor='black', width=.8,
)
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax.set_yticklabels(['{:,.0%}'.format(x) for x in ax.get_yticks()])
ax2 = plt.axes([0.675, 0.55, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
plt.close()

fig.savefig(
    "./figs/IMF/FiscalMonitor_Covid_total" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/FiscalMonitor_Covid_total.pdf]]

* World Economic outlook


** GDP vs Lockdown
#+NAME: IMF_fig_1
#+CAPTION: GDP Forecast Errors in 2020:H1 and Lockdown Stringency
|---------+--------------------+---------------------|
| Country | GDP Forecast Error | Lockdown Stringency |
|---------+--------------------+---------------------|
| AUS     | -4,54              | 37,21               |
| AUT     | -9,11              | 37,13               |
| BEL     | -9,65              | 41,34               |
| BRA     | -8,71              | 44,01               |
| CAN     | -8,81              | 40,92               |
| CHL     | -5,71              | 41,76               |
| CHN     | -7,82              | 62,36               |
| COL     | -10,70             | 49,59               |
| HRV     | -9,36              | 40,25               |
| CZE     | -8,87              | 34,38               |
| DNK     | -6,03              | 39,22               |
| EST     | -6,54              | 31,58               |
| FIN     | -5,24              | 28,49               |
| FRA     | -13,44             | 48,72               |
| DEU     | -7,04              | 35,39               |
| GRC     | -10,79             | 39,91               |
| HKG     | -4,45              | 43,62               |
| HUN     | -8,91              | 38,69               |
| IND     | -15,70             | 51,69               |
| IDN     | -6,09              | 42,06               |
| IRL     | -3,48              | 45,59               |
| ISR     | -6,44              | 49,81               |
| ITA     | -11,99             | 51,65               |
| JPN     | -6,27              | 24,21               |
| KOR     | -3,02              | 39,64               |
| LVA     | -7,49              | 33,94               |
| LTU     | -3,51              | 40,30               |
| MYS     | -12,54             | 40,67               |
| MEX     | -11,10             | 41,61               |
| NLD     | -6,49              | 40,82               |
| NOR     | -6,10              | 32,55               |
| PER     | -20,54             | 55,43               |
| PHL     | -15,14             | 58,33               |
| POL     | -6,56              | 40,53               |
| PRT     | -10,87             | 43,79               |
| ROU     | -7,04              | 44,54               |
| RUS     | -4,29              | 48,61               |
| SRB     | -4,59              | 40,73               |
| SGP     | -7,63              | 43,65               |
| SVK     | -10,39             | 40,44               |
| SVN     | -11,35             | 34,24               |
| ZAF     | -9,66              | 47,21               |
| ESP     | -14,65             | 42,21               |
| SWE     | -4,28              | 21,08               |
| CHE     | -6,16              | 37,10               |
| TWN     | -1,37              | 13,73               |
| THA     | -9,13              | 39,43               |
| TUR     | -5,42              | 42,28               |
| UKR     | -8,08              | 47,94               |
| GBR     | -12,91             | 38,99               |
| USA     | -6,44              | 43,14               |
| VNM     | -4,35              | 47,91               |
|---------+--------------------+---------------------|


#+BEGIN_SRC python :var df=IMF_fig_1() :results graphics file :file ./figs/IMF/GDP_Lockdown.pdf
df = pd.DataFrame(
    df,
)
df.set_index(0, inplace=True)
df = df.rename(columns=df.iloc[0]).drop("Country")
for col in df:
    df[col] = [x.replace(",", ".") for x in df[col]]
df = df.apply(pd.to_numeric, axis=1)


df["Country"] = df.index.to_list()
fig, ax = plt.subplots(figsize=(8, 5))
sns.regplot(data=df, y="GDP Forecast Error", x="Lockdown Stringency", ax=ax)
# ax.legend()
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


def label_point(x, y, val, ax):
    a = pd.concat({"x": x, "y": y, "val": val}, axis=1)
    for i, point in a.iterrows():
        ax.text(point["x"] + 0.02, point["y"], str(point["val"]))


label_point(df["Lockdown Stringency"], df["GDP Forecast Error"], df["Country"], ax)
sns.despine()

fig.savefig(
    "./figs/IMF/" + "GDP_Lockdown" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/GDP_Lockdown.pdf]]



** Lockdown: Voluntary vs Stringency

#+NAME: Vol_String
#+CAPTION: Impact of Lockdowns and Voluntary Social Distancing on Mobility during the First 90 Days of Each Countryâ€™s Epidemic
| Country groups | Lockdown stringency | Voluntary social distancing |
|----------------+---------------------+-----------------------------|
| All            | -7,85               | -6,53                       |
| AEs            | -8,07               | -10,62                      |
| EMs            | -8,78               | -6,26                       |
| LICs           | -5,8                | -2,83                       |
|----------------+---------------------+-----------------------------|

#+BEGIN_SRC python :var df=Vol_String :results graphics file :file ./figs/IMF/Vol_String.pdf
df = pd.DataFrame(
    df,
)
# df = df.transpose()
df.set_index(0, inplace=True)
df.index.name = "Country Groups"
df = df.rename(columns=df.iloc[0]).drop("Country groups")
for col in df:
    df[col] = [x.replace(",", ".") for x in df[col]]
df = df.apply(pd.to_numeric, axis=1)


fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    kind="bar",
    stacked=True,
    ax=ax,
    # cmap="Set1",
    width=0.75,
    edgecolor="black",
)
ax.set_ylim(-25, 15)
ax.axhline(y=0, ls="-", color="black")
ax.legend()
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()

fig.savefig(
    "./figs/IMF/" + "Vol_String" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/Vol_String.pdf]]

** Sequencing of lockdown measures
#+NAME: Lock_measure
#+CAPTION: Sequencing of lockdown measures
|--------------------------------+--------+-----+------|
| Lockdown measures              | Middle | Low | High |
|--------------------------------+--------+-----+------|
| Stay-at-home orders            |     18 |  10 |   27 |
| Public transport closures      |     16 | 7,5 |   25 |
| Internal movement restrictions |     16 |   7 |   27 |
| Workplace closures             |     13 |   6 |   22 |
| Gathering restrictions         |     10 |   2 |   20 |
| Public event cancellations     |      6 |   1 | 14,5 |
| School closures                |    4,5 |   1 | 13,5 |
| International travel controls  |      1 |   0 |    9 |
|--------------------------------+--------+-----+------|

#+BEGIN_SRC python :var df=Lock_measure() :results graphics file :file ./figs/IMF/Lock_measures.pdf
df = pd.DataFrame(
    df,
)
# df = df.transpose()
df.set_index(0, inplace=True)
df.index.name = "Lockdown measures"
df = df.rename(columns=df.iloc[0]).drop("Lockdown measures")
for col in df:
    df[col] = [str(x).replace(",", ".") for x in df[col]]
df = df.apply(pd.to_numeric, axis=1)
df = df.sort_values(by="Middle", ascending=True)
df.reset_index(inplace=True)
fig, ax = plt.subplots(figsize=(8, 5))
ax = sns.barplot(
    y="Lockdown measures",
    x="Middle",
    color="teal",
    # cmap="Set1",
    data=df,
    xerr=df["Low"],
    errcolor="black",
)

# df.plot(
#     kind = 'scatter',
#     y = "Lockdown measures",
#     x = "Low",
#     ax=ax,
#     color = 'black',
#     zorder=2
#     )

# df.plot(
#     kind = 'scatter',
#     y = "Lockdown measures",
#     x = "High",
#     ax=ax,
#     color = 'black',
#     zorder=2
#     )
ax.set_xlabel("Days")
ax2 = plt.axes([0.635, 0.635, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")


sns.despine()

fig.savefig(
    "./figs/IMF/" + "Lock_measures" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
plt.close()
#+END_SRC

#+RESULTS:
[[file:./figs/IMF/Lock_measures.pdf]]

* OECD Weekly tracker

#+begin_src shell :dir ./raw/OECD/ :exports none :eval no
wget -q https://github.com/NicolasWoloszko/OECD-Weekly-Tracker/raw/main/Data/weekly_tracker.xlsx
#+end_src

#+begin_src python :results graphics file :file ./figs/Granulares/OCDE_Semanal.pdf
df = pd.read_excel("./raw/OECD/weekly_tracker.xlsx", parse_dates=True, index_col="date")
df = df[df["ISO3"] == "BRA"][["Tracker"]]["2019-01-01":]
df.index.name = ""
fig, ax = plt.subplots(figsize=(8, 5))
df.plot(
    title=f"Indicador Semanal - OCDE",
    ax=ax,
    lw=2.5,
    color="darkred",
)
ax.axvline(x=corona_sp, color="black", ls="--", lw=1, label="InÃ­cio isolamento em SP")
ax.axhline(y=0, ls="-", lw=1.0, color="gray")
ax.legend(
    # loc="center left", bbox_to_anchor=(1, 0.5)
)
ax2 = plt.axes([0.135, 0.135, 0.2, 0.2])
ax2.imshow(logo, aspect="auto", zorder=0, alpha=0.5)
ax2.axis("off")

sns.despine()
fig.savefig(
    "./figs/Granulares/OCDE_Semanal" + ".pdf",
    dpi=300,
    bbox_inches="tight",
    pad_inches=0,
)
plt.close()
#+end_src

#+RESULTS:
[[file:./figs/Granulares/OCDE_Semanal.pdf]]

* Novos casos x RestriÃ§Ã£o de mobilidade por tipo de isolamento
** TODOs :noexport:

*** TODO Tamanho imagen

*** TODO Fixar logo

*** TODO Selecionar menos paÃ­ses?
** Loading data :ignore:noexport:

*** Our world data

#+BEGIN_SRC python
df = pd.read_csv(
    "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv",
    index_col="date",
    parse_dates=True,
    usecols=[  # subseting
        "date",
        "iso_code",
        "continent",
        "new_cases_smoothed",
        "new_deaths_smoothed",
        "new_deaths_per_million",
        "new_cases_per_million",
        "new_cases_smoothed_per_million",
        "new_deaths_smoothed_per_million",
        "new_tests_smoothed_per_thousand",
        "people_fully_vaccinated",
        "new_vaccinations_smoothed_per_million",
        "stringency_index",
        "new_vaccinations_smoothed_per_million",
    ],
)
df[["stringency_index"]] = df[["stringency_index"]].shift(14)
df = df.groupby("iso_code").rolling(window=14).mean().reset_index().set_index("date")
df.to_csv("./clean/COVID/cases_deaths.csv")
#+END_SRC

#+RESULTS:
:results:
:end:

*** Stringency 


#+BEGIN_SRC python
df = pd.read_csv(
    "https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv",
    index_col="Date",
    parse_dates=True,
    usecols=[  # subseting
        "Date",
        "CountryCode",
        "C1_School closing",
        "C1_Flag",
        "C2_Workplace closing",
        "C2_Flag",
        "C3_Cancel public events",
        "C3_Flag",
        "C4_Restrictions on gatherings",
        "C4_Flag",
        "C5_Close public transport",
        "C5_Flag",
        "C6_Stay at home requirements",
        "C6_Flag",
        "C7_Restrictions on internal movement",
        "C7_Flag",
        "C8_International travel controls",
    ],
)

closure = [
    "C1_School closing",
    "C2_Workplace closing",
    "C3_Cancel public events",
    "C4_Restrictions on gatherings",
    "C5_Close public transport",
    "C6_Stay at home requirements",
    "C7_Restrictions on internal movement",
    "C8_International travel controls",
]

flags = [
    "C1_Flag",
    "C2_Flag",
    "C3_Flag",
    "C4_Flag",
    "C5_Flag",
    "C6_Flag",
    "C7_Flag",
]

df["Closure"] = (
    df.reset_index().set_index("CountryCode")[closure].mean(axis="columns").values
)
# df = df[df["Closure"].diff() != 0]
df["Restrict"] = [i > 0 for i in df["Closure"].diff() > 0]
df = df[["CountryCode", "Closure", "Restrict"]].dropna()
df.columns = ["iso_code", "Closure", "Restrict"]
df.index.name = "date"  # for merging purposes
df.to_csv("./clean/COVID/closes.csv")
#+END_SRC

#+RESULTS:
:results:
:end:

*** Google mobility

#+BEGIN_SRC python
url = "https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv"

cols = [
    "country_region",
    "sub_region_1",
    "sub_region_2",
    "metro_area",
    "iso_3166_2_code",
    "census_fips_code",
    "date",
    "retail_and_recreation_percent_change_from_baseline",
    "grocery_and_pharmacy_percent_change_from_baseline",
    "parks_percent_change_from_baseline",
    "transit_stations_percent_change_from_baseline",
    "workplaces_percent_change_from_baseline",
    "residential_percent_change_from_baseline",
]

df = pd.read_csv(
    url,
    usecols=cols,
    parse_dates=True,
    dtype={
        "country_region": str,
        "sub_region_1": str,
        "sub_region_2": str,
        "metro_area": str,
        "iso_3166_2_code": str,
        "census_fips_code": str,
        "date": str,
        "retail_and_recreation_percent_change_from_baseline": np.float64,
        "grocery_and_pharmacy_percent_change_from_baseline": np.float64,
        "parks_percent_change_from_baseline": np.float64,
        "transit_stations_percent_change_from_baseline": np.float64,
        "workplaces_percent_change_from_baseline": np.float64,
        "residential_percent_change_from_baseline": np.float64,
    },
)
# Convert date column to days of the year
# df['date'] = pd.to_datetime(df['date'], format="%Y/%m/%d", utc=True)


# Remove subnational data, keeping only country figures
filter_cols = [
    "sub_region_1",
    "sub_region_2",
    "metro_area",
    "iso_3166_2_code",
    "census_fips_code",
]
df = df[df[filter_cols].isna().all(1)]

# Delete columns
df = df.drop(
    [
        # "country_region",
        "sub_region_1",
        "sub_region_2",
        "metro_area",
        "census_fips_code",
        "iso_3166_2_code",
    ],
    axis="columns",
)


# Standardise country names to OWID country names
df = df.reset_index().set_index("country_region")
df.index = cc.convert(
    names=list(df.index), to="ISO3", not_found=None
)  # To avoid string problems
df = df.reset_index().set_index("date").drop("index", axis="columns")
# Converting the index as date
df.index = pd.to_datetime(df.index)
# Assign new column names
rename_dict = {
    "date": "Date",
    "level_0": "iso_code",
    "retail_and_recreation_percent_change_from_baseline": "Retail & Recreation",
    "grocery_and_pharmacy_percent_change_from_baseline": "Grocery & Pharmacy",
    "parks_percent_change_from_baseline": "Parks",
    "transit_stations_percent_change_from_baseline": "Transit Stations",
    "workplaces_percent_change_from_baseline": "Workplaces",
    "residential_percent_change_from_baseline": "Residential",
}

# Rename columns
df = df.rename(columns=rename_dict)
df["Isolamento"] = df["Residential"].pct_change(7)
df.to_csv("./clean/COVID/google_mobility.csv")
#+END_SRC

#+RESULTS:
:results:
:end:

** Merging :noexport:


#+begin_src R
df <-read_csv(
  './clean/COVID/cases_deaths.csv',
  guess_max = 3000
)  %>% arrange(iso_code)

tmp <- read_csv(
  './clean/COVID/closes.csv'
)  %>% arrange(iso_code)
df <- df %>% left_join(tmp)
# check if full_join or right or left join
tmp <- read_csv(
  './clean/COVID/google_mobility.csv'
)  %>% arrange(iso_code)
df <- df %>% left_join(tmp)
df <- df %>%
  mutate(Policy_change = c(NA, diff(Closure))) %>%
  mutate(Restrict = Policy_change > 0) %>%
  mutate(stayhome_growth = (Residential/lag(Residential) - 1) * 100) %>%
  mutate(stayhome_growth_7 = (Residential/lag(Residential,7) - 1) * 100) %>%
  mutate(stayhome_growth_14 = (Residential/lag(Residential,14) - 1) * 100) %>%
  mutate(Isolamento = case_when(
     stayhome_growth > 0 & Restrict == TRUE ~ "Imposto", # Queda da mobilidade junto da imposiÃ§Ã£o
     stayhome_growth > 0 & Restrict == FALSE ~ "VoluntÃ¡rio", # Queda da mobilidade sem restriÃ§Ã£o
     stayhome_growth <= 0 ~ "Queda",
           )) %>%
  mutate(Isolamento_14 = case_when(
     stayhome_growth_14 > 0 & Restrict == TRUE ~ "Imposto", # Queda da mobilidade junto da imposiÃ§Ã£o
     stayhome_growth_14 > 0 & Restrict == FALSE ~ "VoluntÃ¡rio", # Queda da mobilidade sem restriÃ§Ã£o
     stayhome_growth_14 <= 0 ~ "Queda",
           )) %>%
  mutate(Isolamento_7 = case_when(
     stayhome_growth_7 > 0 & Restrict == TRUE ~ "Imposto", # Queda da mobilidade junto da imposiÃ§Ã£o
     stayhome_growth_7 > 0 & Restrict == FALSE ~ "VoluntÃ¡rio", # Queda da mobilidade sem restriÃ§Ã£o
     stayhome_growth_7 <= 0 ~ "Queda",
           )) %>%
  mutate(Isolamento = as.factor(Isolamento)) %>%
  mutate(Isolamento_7 = as.factor(Isolamento_7)) %>%
  mutate(Isolamento_14 = as.factor(Isolamento_14)) %>%
  mutate(cases_growth = (new_cases_per_million/lag(new_cases_per_million) - 1) * 100) %>%
  mutate(deaths_growth = (new_deaths_per_million/lag(new_deaths_per_million) - 1) * 100) %>%
  mutate(vaccine_growth = (people_fully_vaccinated/lag(people_fully_vaccinated) - 1) * 100) %>%
  distinct(date, iso_code, .keep_all = TRUE)

write.csv(
  df,
  './clean/COVID/cases_closes_google_merged.csv',
  row.names = FALSE
)
#+end_src

#+RESULTS:
:results:

[36mâ”€â”€[39m [1m[1mColumn specification[1m[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
cols(
  date = [34mcol_date(format = "")[39m,
  iso_code = [31mcol_character()[39m,
  new_cases_smoothed = [32mcol_double()[39m,
  new_deaths_smoothed = [32mcol_double()[39m,
  new_cases_per_million = [32mcol_double()[39m,
  new_cases_smoothed_per_million = [32mcol_double()[39m,
  new_deaths_per_million = [32mcol_double()[39m,
  new_deaths_smoothed_per_million = [32mcol_double()[39m,
  new_tests_smoothed_per_thousand = [32mcol_double()[39m,
  people_fully_vaccinated = [32mcol_double()[39m,
  new_vaccinations_smoothed_per_million = [32mcol_double()[39m,
  stringency_index = [32mcol_double()[39m
)

[36mâ”€â”€[39m [1m[1mColumn specification[1m[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
cols(
  date = [34mcol_date(format = "")[39m,
  iso_code = [31mcol_character()[39m,
  Closure = [32mcol_double()[39m,
  Restrict = [33mcol_logical()[39m
)
Joining, by = c("date", "iso_code")

[36mâ”€â”€[39m [1m[1mColumn specification[1m[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
cols(
  date = [34mcol_date(format = "")[39m,
  iso_code = [31mcol_character()[39m,
  `Retail & Recreation` = [32mcol_double()[39m,
  `Grocery & Pharmacy` = [32mcol_double()[39m,
  Parks = [32mcol_double()[39m,
  `Transit Stations` = [32mcol_double()[39m,
  Workplaces = [32mcol_double()[39m,
  Residential = [32mcol_double()[39m,
  Isolamento = [32mcol_double()[39m
)
Joining, by = c("date", "iso_code")
:end:

** Aparando dataframe :noexport:

#+begin_src R
df <-read_csv(
  './clean/COVID/cases_closes_google_merged.csv',
  guess_max = 3000
) %>%
  mutate(Isolamento = as.factor(Isolamento)) %>%
  mutate(Isolamento_7 = as.factor(Isolamento_7)) %>%
  mutate(Isolamento_14 = as.factor(Isolamento_14)) %>%
  select(date,
         iso_code,
         new_cases_per_million,
         cases_growth,
         deaths_growth,
         vaccine_growth,
         Policy_change,
         Restrict,
         Isolamento,
         Isolamento_7,
         Isolamento_14,
         Residential,
         Closure,
         stayhome_growth,
         stayhome_growth_7,
         stayhome_growth_14,
         vaccine_growth
         ) %>%
  mutate(cases_growth_after14 = lead(cases_growth, 14)) %>%
  filter(
    date > as.Date("2020-02-01"), # same start date for all
    cases_growth < 10, # Removing outliers
    cases_growth > -10,
    cases_growth>-50,
    cases_growth_after14 > -10,
    cases_growth_after14<10,
    stayhome_growth_7<100) %>%
  drop_na(Isolamento, Isolamento_7, Isolamento_14, cases_growth, Policy_change) %>%
  filter(iso_code %in% c(
                       "ARG",
                       "AUS",
                       "BEL",
                       "BOL",
                       "BRA",
                       "CAN",
                       "CHE",
                       "CHL",
                       "COL",
                       "DEU",
                       "DNK",
                       "ECU",
                       "ESP",
                       "FIN",
                       "FRA",
                       "GBR",
                       "IND",
                       "IRL",
                       "ISR",
                       "ITA",
                       "JPN",
                       "KOR",
                       "MEX",
                       "NDL",
                       "NOR",
                       "NZL",
                       "PRT",
                       "PRY",
                       "RUS",
                       "SWE",
                       "URY",
                       "USA",
                       "VEN",
                       "ZAF"
                     )) %>%
  mutate(iso_code = as.factor(iso_code)) %>%
  mutate(Policy = case_when(
           Policy_change > 0 ~ "RestriÃ§Ã£o",
           Policy_change < 0 ~ "FlexibilizaÃ§Ã£o",
           Policy_change == 0 ~ "Sem mudanÃ§as"
         )) %>%
  mutate(Policy = as.factor(Policy))


    
ylab = "Taxa de crescimento de casos"
#+end_src

#+RESULTS:
:results:

[36mâ”€â”€[39m [1m[1mColumn specification[1m[22m [36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€[39m
cols(
  .default = col_double(),
  date = [34mcol_date(format = "")[39m,
  iso_code = [31mcol_character()[39m,
  Restrict = [33mcol_logical()[39m,
  Isolamento = [31mcol_character()[39m,
  Isolamento_14 = [31mcol_character()[39m,
  Isolamento_7 = [31mcol_character()[39m
)
[36mâ„¹[39m Use [30m[47m[30m[47m`spec()`[47m[30m[49m[39m for the full column specifications.
:end:

** EconÃ´mico: Pandemia $\Rightarrow$ Isolamento



*** Novos casos por milhÃ£o > 10 para todos os dias

#+begin_src R :results value file :var figname="Casos_Policy_10_Todos"

name = paste0('./figs/COVID/', figname, ".pdf")
    
df %>%
  filter(
    ## Policy_change != 0,
    new_cases_per_million > 10
  ) %>%
  ggplot(aes(y=Policy, x= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") + 
  geom_boxplot(alpha=0.5) +
  geom_boxplot(outlier.shape = NA) +
  labs(
    y = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    x = ylab
  ) +
  ## scale_fill_manual(values=c("#FF0000", "#00FF00","#0000FF")) + 
  ## coord_flip() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_10_Todos.pdf]]
:end:
*** Novos casos por milhÃ£o > 50 para todos os dias

#+begin_src R :results value file :var figname="Casos_Policy_50_Todos"

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    ## Policy_change != 0,
    new_cases_per_million > 50
  ) %>%
  ggplot(aes(y=Policy, x= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") +
  geom_boxplot() +
  labs(
    y = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    x = ylab
  ) +
  ## scale_fill_manual(values=c("#FF0000", "#00FF00","#0000FF")) +
  coord_flip() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_50_Todos.pdf]]
:end:

*** Novos casos por milhÃ£o > 10 para os dias em que foi decretada alguma medida de mobilidade

#+begin_src R :results value file :var figname="Casos_Policy_10_Restricao"

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    Policy_change != 0,
    new_cases_per_million > 10
  ) %>%
  ggplot(aes(y=Policy, x= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") +
  geom_boxplot(alpha=0.5, scale = "area") +
  labs(
    y = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    x = ylab
  ) +
  scale_fill_manual(values=c("#FF0000", "#00FF00","#0000FF")) +
  coord_flip() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_10_Restricao.pdf]]
:end:
*** Novos casos por milhÃ£o > 100 para todos os dias

#+begin_src R :results value file :var figname="Casos_Policy_100_Todos"

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    ## Policy_change != 0,
    new_cases_per_million > 100
  ) %>%
  ggplot(aes(x=Policy_change, y= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") +
  geom_boxplot(alpha=0.5) +
  labs(
    x = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    y = ylab
  ) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_100_Todos.pdf]]
:end:
*** Novos casos por milhÃ£o > 100 apenas nos dias que houve mudanÃ§a na polÃ­tica de restriÃ§Ã£o

#+begin_src R :results value file :var figname="Casos_Policy_100_Restricao"

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    Policy_change != 0,
    new_cases_per_million > 100
  ) %>%
  ggplot(aes(x=Policy_change, y= cases_growth, fill=Isolamento_14)) +
  geom_vline(xintercept=0, color="black") +
  geom_boxplot(alpha=0.5) +
  labs(
    x = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    y = ylab
  ) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
  facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Casos_Policy_100_Restricao.pdf]]
:end:



** EpidemiolÃ³gico: Isolamento $\Rightarrow$ Pandemia :noexport:

#+begin_src R :exports none
ylab = "Taxa de crescimento de casos apÃ³s 14 dias"
#+end_src

#+RESULTS:
:results:
[1] "./figs/COVID/Casos_Policy_10_Todos.pdf"
There were 32 warnings (use warnings() to see them)
[1] "./figs/COVID/Casos_Policy_10_Restricao.pdf"
There were 16 warnings (use warnings() to see them)
[1] "./figs/COVID/Casos_Policy_100_Todos.pdf"
There were 18 warnings (use warnings() to see them)
[1] "./figs/COVID/Casos_Policy_100_Restricao.pdf"
There were 20 warnings (use warnings() to see them)
:end:

*** Novos casos por milhÃ£o > 10 para todos os dias

#+begin_src R :results value file :var figname="Pandemia_Casos_Policy_10_Todos"

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    ## Policy_change != 0,
    new_cases_per_million > 10
  ) %>%
  ggplot(aes(x=Policy_change, y= cases_growth_after14, fill=Isolamento_14)) +
  geom_hline(yintercept=0, color="black") +
  geom_boxplot(alpha=0.5) +
  labs(
    x = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    y = ylab
  ) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Pandemia_Casos_Policy_10_Todos.pdf]]
:end:
*** Novos casos por milhÃ£o > 10 apenas nos dias que houve mudanÃ§a na polÃ­tica de restriÃ§Ã£o

#+begin_src R :results value file :var figname="Pandemia_Casos_Policy_10_Restricao"

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    Policy_change != 0,
    new_cases_per_million > 10
  ) %>%
  ggplot(aes(x=Policy_change, y= cases_growth_after14, fill=Isolamento_14)) +
  geom_hline(yintercept=0, color="black") +
  geom_boxplot(alpha=0.5) +
  labs(
    x = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    y = ylab
  ) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
  facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Pandemia_Casos_Policy_10_Restricao.pdf]]
:end:



*** Novos casos por milhÃ£o > 100 para todos os dias

#+begin_src R :results value file :var figname="Pandemia_Casos_Policy_100_Todos"

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    ## Policy_change != 0,
    new_cases_per_million > 100
  ) %>%
  ggplot(aes(x=Policy_change, y= cases_growth_after14, fill=Isolamento_14)) +
  geom_hline(yintercept=0, color="black") +
  geom_boxplot(alpha=0.5) +
  labs(
    x = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    y = ylab
  ) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
 facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Pandemia_Casos_Policy_100_Todos.pdf]]
:end:
*** Novos casos por milhÃ£o > 100 apenas nos dias que houve mudanÃ§a na polÃ­tica de restriÃ§Ã£o

#+begin_src R :results value file :var figname="Pandemia_Casos_Policy_100_Restricao"

name = paste0('./figs/COVID/', figname, ".pdf")

df %>%
  filter(
    Policy_change != 0,
    new_cases_per_million > 100
  ) %>%
  ggplot(aes(x=Policy_change, y= cases_growth_after14, fill=Isolamento_14)) +
  geom_hline(yintercept=0, color="black") +
  geom_boxplot(alpha=0.5) +
  labs(
    x = "VariaÃ§Ã£o imposiÃ§Ã£o de restriÃ§Ã£o",
    y = ylab
  ) +
 guides(fill=guide_legend(title="Tipo de isolamento")) +
  facet_wrap(~iso_code) -> fig

 fig <- ggdraw(fig) +
   draw_image(logo_file, x = 0.975, y = .975, hjust = 1, vjust = 1, width = 0.15, height = 0.1)
ggsave(name, width = 20, height = 20, units = "cm")
print(name)
#+end_src

#+RESULTS:
:results:
[[file:./figs/COVID/Pandemia_Casos_Policy_100_Restricao.pdf]]
:end:
